<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Generar Mensaje - PhishIntel</title>

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Raleway&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="assets/css/main.css" rel="stylesheet">
</head>
<style>
/* Personalizar los radios */

/* Cuando está seleccionado → círculo rosa */
.custom-radio:checked {
  background-color: #da02e5; /* rosa */
  border-color: #da02e5;
}

/* Para navegadores que usan -webkit-appearance */
.custom-radio[type="radio"] {
  accent-color: #da02e5; /* Soporta Chrome/Edge/Firefox modernos */
}

/* Estilos para selectores deshabilitados */
select:disabled {
  background-color: #3d3d3d !important;
  color: #6c757d !important;
  cursor: not-allowed !important;
  opacity: 0.7;
}

select:disabled option {
  color: #6c757d !important;
  background-color: #3d3d3d !important;
}
</style>
<body class="index-page">

  <!-- ======= Header ======= -->
  <header id="header" class="header d-flex align-items-center fixed-top">
    <div class="container position-relative d-flex align-items-center justify-content-between">
      <a href="/" class="logo d-flex align-items-center me-auto me-xl-0">
        <h1 class="sitename">PhishIntel</h1>
      </a>

      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="/principal" class="btn-getstarted btn-login">Volver a Home</a></li>
          <li><a href="/selectorCampania" class="btn-getstarted btn-login">Volver al selector de campaña</a></li>
        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
      </nav>
    </div>
  </header>
  <!-- End Header -->

  <main class="main">

    <!-- Page Title -->
    <div class="page-title py-5"></div>

    <!-- Formulario con Vue -->
    <section id="mensaje" class="contact section">
      <div class="col-lg-8 mx-auto" data-aos="fade-left" data-aos-delay="200">
        <!-- Vue App -->
        <div id="app" class="contact-form-wrapper">
          <div class="form-header">
            <h3>Generación de Simulación de Mensaje</h3>
            <p>Selecciona el área, usuario y nivel de dificultad para generar un mensaje de phishing.</p>
          </div>

          <form class="php-email-form" @submit.prevent="generarPreview">

            <!-- Selector de Área y Usuario -->
            <div class="mb-3">
              <div class="row g-2">
                <div class="col-6">
                  <label for="areaSelect" class="form-label">Seleccionar Área</label>
                  <select v-model="filtroArea" class="form-control" id="areaSelect" name="area" required>
                    <option value="">-- Selecciona un área --</option>
                    <option v-for="area in areas" :key="area.idArea" :value="area.nombreArea">
                      {{ area.nombreArea }} 
                    </option>
                  </select>
                </div>
                <div class="col-6">
                  <label for="userSelect" class="form-label">Seleccionar Usuario</label>
                  <select v-model="filtroUsuario" class="form-control" id="userSelect" name="usuario" :disabled="!filtroArea" required>
                    <option value="" disabled>{{ filtroArea ? '-- Selecciona un usuario --' : '-- Selecciona un área primero --' }}</option>
                    <option v-for="usuario in usuariosFiltrados" :key="usuario.idUsuario" :value="usuario">
                      {{ usuario.nombre }} {{ usuario.apellido }}
                    </option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Dificultad -->
            <div class="mb-4">
              <label class="form-label mb-3">Nivel de Dificultad</label>
              <div class="row g-2">

                <div class="col-md-4">
                  <div class="card bloque bloque-facil"
                       @click="nivel = 'Fácil'"
                       :class="{ 'seleccionado': nivel === 'Fácil' }">
                    <div class="card-body text-center p-1">
                      <div style="font-size: 1em;"><i class="bi bi-puzzle-fill"></i></div>
                      <h6 class="card-title mb-0" style="font-size: 0.8em;">Fácil</h6>
                      <small class="card-text" style="font-size: 0.7em;">Directo y obvio</small>
                    </div>
                  </div>
                </div>
                
                <div class="col-md-4">
                  <div class="card bloque bloque-medio"
                       @click="nivel = 'Medio'"
                       :class="{ 'seleccionado': nivel === 'Medio' }">
                    <div class="card-body text-center p-1">
                      <div style="font-size: 1em;"><i class="bi bi-shield-fill-x"></i></div>
                      <h6 class="card-title mb-0" style="font-size: 0.8em;">Medio</h6>
                      <small class="card-text" style="font-size: 0.7em;">Mensaje Elaborado</small>
                    </div>
                  </div>
                </div>

                <div class="col-md-4">
                  <div class="card bloque bloque-dificil"
                       @click="nivel = 'Difícil'"
                       :class="{ 'seleccionado': nivel === 'Difícil' }">
                    <div class="card-body text-center p-1">
                      <div style="font-size: 1em;"><i class="bi bi-fire"></i></div>
                      <h6 class="card-title mb-0" style="font-size: 0.8em;">Difícil</h6>
                      <small class="card-text" style="font-size: 0.7em;">Realista</small>
                    </div>
                  </div>
                </div>

              </div>
            </div>

            <!-- Selector de Medio -->
            <div class="mb-4">
              <label class="form-label mb-3">Medio de Comunicación</label>
              <div class="row g-2">
                <div class="col-md-4">
                  <div class="card bloque bloque-normal"
                       @click="medio = 'telegram'"
                       :style="medio === 'telegram' ? 'border-color: var(--accent-color);' : 'bloque-normal'">
                    <div class="card-body text-center p-1">
                      <div style="font-size: 1em;"><i class="bi bi-telegram"></i></div>
                      <h6 class="card-title mb-0" style="font-size: 0.8em;">Telegram</h6>
                      <small class="card-text" style="font-size: 0.7em;">Mensajería instantánea</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card bloque bloque-normal"
                       @click="medio = 'whatsapp'"
                       :style="medio === 'whatsapp' ? 'border-color: var(--accent-color);' : 'bloque-normal'">
                    <div class="card-body text-center p-1">
                      <div style="font-size: 1em;"><i class="bi bi-whatsapp"></i></div>
                      <h6 class="card-title mb-0" style="font-size: 0.8em;">WhatsApp</h6>
                      <small class="card-text" style="font-size: 0.7em;">Mensajería popular</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card bloque bloque-normal"
                       @click="medio = 'sms'"
                       :style="medio === 'sms' ? 'border-color: var(--accent-color);' : 'bloque-normal'">
                    <div class="card-body text-center p-1">
                      <div style="font-size: 1em;"><i class="bi bi-send"></i></div>
                      <h6 class="card-title mb-0" style="font-size: 0.8em;">SMS</h6>
                      <small class="card-text" style="font-size: 0.7em;">Mensaje de texto</small>
                    </div>
                  </div>
                </div>
                <!--<div class="col-md-4">
                  <div class="card h-100 cursor-pointer"
                       :class="{ 'border-0': medio === 'telegram', 'border-secondary': medio !== 'telegram' }"
                       @click="medio = 'telegram'"
                       :style="medio === 'telegram' ? 'background-color: #da02e5; color: white; cursor: pointer; transition: all 0.3s ease;' : 'background-color: #2d2d2d; color: white; cursor: pointer; transition: all 0.3s ease;'">
                    <div class="card-body text-center p-1">
                      <div style="font-size: 1em;"><i class="bi bi-telegram"></i></div>
                      <h6 class="card-title mb-0" style="font-size: 0.8em;">Telegram</h6>
                      <small class="card-text" style="font-size: 0.7em;">Mensajería instantánea</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card h-100 cursor-pointer" 
                       :class="{ 'border-0': medio === 'whatsapp', 'border-secondary': medio !== 'whatsapp' }"
                       @click="medio = 'whatsapp'"
                       :style="medio === 'whatsapp' ? 'background-color: #da02e5; color: white; cursor: pointer; transition: all 0.3s ease;' : 'background-color: #2d2d2d; color: white; cursor: pointer; transition: all 0.3s ease;'">
                    <div class="card-body text-center p-1">
                      <div style="font-size: 1em;"><i class="bi bi-whatsapp"></i></div>
                      <h6 class="card-title mb-0" style="font-size: 0.8em;">WhatsApp</h6>
                      <small class="card-text" style="font-size: 0.7em;">Mensajería popular</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card h-100 cursor-pointer" 
                       :class="{ 'border-0': medio === 'sms', 'border-secondary': medio !== 'sms' }"
                       @click="medio = 'sms'"
                       :style="medio === 'sms' ? 'background-color: #da02e5; color: white; cursor: pointer; transition: all 0.3s ease;' : 'background-color: #2d2d2d; color: white; cursor: pointer; transition: all 0.3s ease;'">
                    <div class="card-body text-center p-1">
                      <div style="font-size: 1em;"><i class="bi bi-send"></i></div>
                      <h6 class="card-title mb-0" style="font-size: 0.8em;">SMS</h6>
                      <small class="card-text" style="font-size: 0.7em;">Mensaje de texto</small>
                    </div>
                  </div>
                </div>-->
              </div>
            </div>

            <!-- Botón de enviar -->
            <div class="text-center">
              <button type="submit" class="btn btn-primary px-4 py-2 rounded-pill" :disabled="cargando">
                <span v-if="cargando">
                  <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                  {{ mensajeCargando }}
                </span>
                <span v-else>
                  <i class="bi bi-chat-dots"></i> Ver Preview
                </span>
              </button>
            </div>
          </form>

          <!-- Modal Preview (dentro de #app) -->
          <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
              <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                  <h5 class="modal-title">Vista previa del mensaje a enviar</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-4">
                    <h6 class="mb-3" style="color: white;">
                      <i class="bi bi-gear-fill me-2"></i>Opciones Elegidas
                    </h6>
                    
                    <div class="row g-3">
                      <!-- Área -->
                      <div class="col-md-6">
                        <div class="d-flex align-items-center p-2 rounded" style="background-color: #2d2d2d; color: white;">
                            <span class="me-2"><i class="bi bi-building"></i></span>
                          <div>
                            <small class="d-block" style="color: #ccc;">Área</small>
                            <strong>{{ filtroArea }}</strong>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Usuario -->
                      <div class="col-md-6">
                        <div class="d-flex align-items-center p-2 rounded" style="background-color: #2d2d2d; color: white;">
                          <span class="me-2"><i class="bi bi-person-fill"></i></span>
                          <div>
                            <small class="d-block" style="color: #ccc;">Usuario</small>
                            <strong>{{ filtroUsuario.nombre }} {{ filtroUsuario.apellido }}</strong>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Dificultad -->
                      <div class="col-md-6">
                        <div class="d-flex align-items-center p-2 rounded" style="background-color: #2d2d2d; color: white;">
                          <span class="me-2">
                              <i v-if="nivel === 'Fácil'" class="bi bi-puzzle-fill"></i>
                              <i v-else-if="nivel === 'Medio'" class="bi bi-gear"></i>
                              <i v-else class="bi bi-fire"></i>
                         </span>
                          <div>
                            <small class="d-block" style="color: #ccc;">Dificultad</small>
                            <strong>{{ nivel }}</strong>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Medio -->
                      <div class="col-md-6">
                        <div class="d-flex align-items-center p-2 rounded" style="background-color: #2d2d2d; color: white;">
                          <span class="me-2">
                              <i v-if="medio === 'whatsapp'" class="bi bi-whatsapp"></i>
                              <i v-else-if="medio === 'telegram'" class="bi bi-telegram"></i>
                              <i v-else class="bi bi-phone"></i>
                          </span>
                          <div>
                            <small class="d-block" style="color: #ccc;">Medio</small>
                            <strong>{{ medio === 'whatsapp' ? 'WhatsApp' : medio === 'telegram' ? 'Telegram' : 'SMS' }}</strong>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Proveedor -->
                      <div class="col-12">
                        <div class="d-flex align-items-center p-2 rounded" style="background-color: #2d2d2d; color: white;">
                          <span class="me-2">
                              <i v-if="proveedor === 'bot' || proveedor === 'selenium'" class="bi bi-robot"></i>
                              <i v-else-if="proveedor === 'telethon'" class="bi bi-telegram"></i>
                              <i v-else-if="proveedor === 'whapi'" class="bi bi-cloud"></i>
                              <i v-else-if="proveedor === 'whapi-link-preview'" class="bi bi-link-45deg"></i>
                              <i v-else-if="proveedor === 'twilio' || proveedor === 'textBee'" class="bi bi-telephone"></i>
                              <i v-else class="bi bi-phone"></i>
                          </span>
                          <div>
                            <small class="d-block" style="color: #ccc;">Proveedor</small>
                            <strong>
                              {{ proveedor === 'bot' ? 'Bot de Telegram' : 
                                 proveedor === 'telethon' ? 'Telethon (Cuenta Propia)' :
                                 proveedor === 'whapi' ? 'whapi.cloud' : 
                                 proveedor === 'whapi-link-preview' ? 'whapi.cloud Link Preview' : 
                                 proveedor === 'twilio' ? 'Twilio' : 
                                 proveedor === 'textBee' ? 'TextBee' :
                                 proveedor === 'selenium' ? 'Selenium' : proveedor }}
                            </strong>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <hr class="my-4">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0" style="color: white;">
                      <i class="bi bi-robot me-2"></i>Mensaje generado por IA
                    </h6>
                    <button type="button" class="btn btn-sm" @click="regenerarMensaje" :disabled="cargandoRegenerar" style="border-color: #da02e5; color: #da02e5;">
                      <span v-if="cargandoRegenerar">
                        <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                        {{ mensajeRegenerando }}
                      </span>
                      <span v-else>
                        <i class="bi bi-arrow-clockwise"></i> Regenerar
                      </span>
                    </button>
                  </div>
                  <div class="p-3 rounded" style="background-color: #2d2d2d;">
                    <textarea 
                      v-model="modalMensaje" 
                      class="form-control border-0 bg-transparent" 
                      rows="6" 
                      style="resize: vertical; font-family: inherit; white-space: pre-wrap; color: white;"
                      placeholder="El mensaje aparecerá aquí..."
                    ></textarea>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="button" class="btn btn-primary" @click="confirmarEnvio" :disabled="cargandoEnvio">
                    <span v-if="cargandoEnvio">
                      <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                      Enviando...
                    </span>
                    <span v-else>
                      Confirmar y Enviar
                    </span>
                  </button>
                </div>
              </div>
            </div>
          </div>

        </div><!-- End #app -->
      </div>
    </section>
  </main>

  <!-- Toast de notificación -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" style="background-color: #1a1a1a; border: 1px solid #da02e5;">
      <div class="toast-header" style="background-color: #2d2d2d; color: white; border-bottom: 1px solid #da02e5;">
        <i class="bi bi-check-circle-fill me-2" style="color: #da02e5;"></i>
        <strong class="me-auto">Éxito</strong>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" style="background-color: #1a1a1a; color: white;">
        Mensaje enviado correctamente ✅
      </div>
    </div>
    
    <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" style="background-color: #1a1a1a; border: 1px solid #da02e5;">
      <div class="toast-header" style="background-color: #2d2d2d; color: white; border-bottom: 1px solid #da02e5;">
        <i class="bi bi-exclamation-triangle-fill me-2" style="color: #da02e5;"></i>
        <strong class="me-auto">Error</strong>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" style="background-color: #1a1a1a; color: white;">
        No se pudo enviar el mensaje
      </div>
    </div>
  </div>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/aos/aos.js"></script>
  <script>
    AOS.init();
  </script>

  <!-- Script de configuración para obtener URL del backend -->
  <script src="assets/js/config.js"></script>

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          areas: [],
          filtroArea: "",
          filtroUsuario: "",
          nivel: "Fácil",
          medio: "telegram",
          proveedor: "telethon",
          modalMensaje: "",
          cargando: false,
          cargandoRegenerar: false,
          cargandoEnvio: false,
          mensajeCargando: "Generando preview",
          mensajeRegenerando: "Regenerando...",
          intervaloCargando: null,
          intervaloRegenerando: null,
          mensajesRotacion: [
            "Generando preview",
            "Sugiriendo mensaje de IA",
            "Procesando solicitud",
            "Analizando contexto",
            "Preparando contenido"
          ],
          mensajesRegeneracion: [
            "Regenerando...",
            "Sugiriendo nuevo mensaje",
            "Procesando regeneración",
            "Optimizando mensaje",
            "Generando alternativa"
          ],
          mensajeGenerado: {
            medio: "telegram",
            proveedor: "telethon",
            idUsuario: null, 
            mensaje: ""
          }
        };
      },
      computed: {
        usuariosFiltrados() {
          const areaSeleccionada = this.areas.find(a => a.nombreArea === this.filtroArea);
          return areaSeleccionada ? areaSeleccionada.usuarios : [];
        }
      },
      watch: {
        filtroArea() {
          // Limpiar usuario seleccionado cuando cambie el área
          this.filtroUsuario = "";
        },
        medio() {
          // Hardcodear proveedor según medio
          if (this.medio === 'telegram') {
            this.proveedor = 'telethon';
          } else if (this.medio === 'whatsapp') {
            this.proveedor = 'whapi-link-preview';
          } else if (this.medio === 'sms') {
            this.proveedor = 'textBee';
          }
        }
      },
      methods: {
        iniciarRotacionMensajes() {
          // Detener cualquier rotación existente
          this.detenerRotacionMensajes();
          let indice = 0;
          this.mensajeCargando = this.mensajesRotacion[0];
          this.intervaloCargando = setInterval(() => {
            indice = (indice + 1) % this.mensajesRotacion.length;
            this.mensajeCargando = this.mensajesRotacion[indice];
          }, 3000);
        },
        detenerRotacionMensajes() {
          if (this.intervaloCargando) {
            clearInterval(this.intervaloCargando);
            this.intervaloCargando = null;
          }
        },
        iniciarRotacionRegeneracion() {
          // Detener cualquier rotación existente
          this.detenerRotacionRegeneracion();
          let indice = 0;
          this.mensajeRegenerando = this.mensajesRegeneracion[0];
          this.intervaloRegenerando = setInterval(() => {
            indice = (indice + 1) % this.mensajesRegeneracion.length;
            this.mensajeRegenerando = this.mensajesRegeneracion[indice];
          }, 3000);
        },
        detenerRotacionRegeneracion() {
          if (this.intervaloRegenerando) {
            clearInterval(this.intervaloRegenerando);
            this.intervaloRegenerando = null;
          }
        },
        async generarPreview() {
          this.cargando = true;
          this.iniciarRotacionMensajes();
          try {
            // Construir contexto según dificultad
            let contextoStr = '';
            if (this.nivel === 'Fácil') {
              contextoStr = 'Genera un mensaje de phishing formal para empleados de PG Control, contexto variable, sin marcadores como [Nombre de la empresa], no incluyas ningún enlace; indica que el enlace se adjuntará a continuación.';
            } else if (this.nivel === 'Medio') {
              contextoStr = 'Se pedirá login en un formulario (como caisteLogin.html) y credenciales. Empresa: PG Control. Sin placeholders. No incluyas enlaces; indica que el enlace se adjuntará a continuación.';
            } else {
              contextoStr = 'Se pedirá actualización urgente de datos con enlace a caisteDatos.html. Empresa: PG Control. Sin placeholders. No incluyas enlaces; indica que el enlace se adjuntará a continuación.';
            }

            const resp = await fetch(`${API_BASE_URL}/api/mensaje/generar`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                contexto: contextoStr,
                nivel: this.nivel
              })
            });

            if (!resp.ok) throw new Error("Error generando el mensaje");

            const data = await resp.json();
            this.modalMensaje = data.mensaje || "Sin mensaje";
            
            this.mensajeGenerado.mensaje = data.mensaje;
            this.mensajeGenerado.idUsuario = this.filtroUsuario.idUsuario;
            this.mensajeGenerado.medio = this.medio;
            // Actualizar proveedor según medio
            if (this.medio === 'telegram') {
              this.proveedor = 'telethon';
            } else if (this.medio === 'whatsapp') {
              this.proveedor = 'whapi-link-preview';
            } else if (this.medio === 'sms') {
              this.proveedor = 'textBee';
            }
            this.mensajeGenerado.proveedor = this.proveedor;

            // Abrir modal
            const modal = new bootstrap.Modal(document.getElementById("previewModal"));
            modal.show();

          } catch (e) {
            console.error("Error:", e);
            this.mostrarToastError();
          } finally {
            this.detenerRotacionMensajes();
            this.cargando = false;
          }
        },

        async regenerarMensaje() {
          this.cargandoRegenerar = true;
          this.iniciarRotacionRegeneracion();
          try {
            // Construir contexto según dificultad
            let contextoStr = '';
            if (this.nivel === 'Fácil') {
              contextoStr = 'Genera un mensaje de phishing formal para empleados de PG Control, contexto variable, sin marcadores como [Nombre de la empresa], no incluyas ningún enlace; indica que el enlace se adjuntará a continuación.';
            } else if (this.nivel === 'Medio') {
              contextoStr = 'Se pedirá login en un formulario (como caisteLogin.html) y credenciales. Empresa: PG Control. Sin placeholders. No incluyas enlaces; indica que el enlace se adjuntará a continuación.';
            } else {
              contextoStr = 'Se pedirá actualización urgente de datos con enlace a caisteDatos.html. Empresa: PG Control. Sin placeholders. No incluyas enlaces; indica que el enlace se adjuntará a continuación.';
            }

            const resp = await fetch(`${API_BASE_URL}/api/mensaje/generar`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                contexto: contextoStr,
                nivel: this.nivel
              })
            });

            if (!resp.ok) throw new Error("Error regenerando el mensaje");

            const data = await resp.json();
            this.modalMensaje = data.mensaje || "Sin mensaje";
            this.mensajeGenerado.mensaje = data.mensaje;

          } catch (e) {
            console.error("Error:", e);
            this.mostrarToastError();
          } finally {
            this.detenerRotacionRegeneracion();
            this.cargandoRegenerar = false;
          }
        },

        async confirmarEnvio() {
          this.cargandoEnvio = true;
          try {
            // Hardcodear proveedor según medio
            let proveedorHardcodeado = 'telethon';
            if (this.medio === 'telegram') {
              proveedorHardcodeado = 'telethon';
            } else if (this.medio === 'whatsapp') {
              proveedorHardcodeado = 'whapi-link-preview';
            } else if (this.medio === 'sms') {
              proveedorHardcodeado = 'textBee';
            }

            const resp = await fetch(`${API_BASE_URL}/api/mensaje/enviar-id`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                medio: this.medio,
                proveedor: proveedorHardcodeado,
                idUsuario: this.filtroUsuario.idUsuario,
                mensaje: this.modalMensaje,
                dificultad: this.nivel
              })
            });

            if (!resp.ok) throw new Error("Error enviando el mensaje");

            const data = await resp.json();
            this.mostrarToastExito();
            bootstrap.Modal.getInstance(document.getElementById("previewModal")).hide();

          } catch (e) {
            console.error("Error:", e);
            this.mostrarToastError();
          } finally {
            this.cargandoEnvio = false;
          }
        },

        mostrarToastExito() {
          const toastElement = document.getElementById('successToast');
          const toast = new bootstrap.Toast(toastElement, {
            autohide: true,
            delay: 4000
          });
          toast.show();
        },

        mostrarToastError() {
          const toastElement = document.getElementById('errorToast');
          const toast = new bootstrap.Toast(toastElement, {
            autohide: true,
            delay: 5000
          });
          toast.show();
        }
      },
      async mounted() {
        try {
          const resp = await fetch(`${API_BASE_URL}/api/areas`);
          const data = await resp.json();
          this.areas = data.areas || [];
        } catch (e) {
          console.error("Error cargando áreas:", e);
        }
      }
    }).mount("#app");
  </script>

</body>

</html>
