<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Generar Mensaje - PhishIntel</title>

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Raleway&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="assets/css/main.css" rel="stylesheet">
</head>
<style>
/* Personalizar los radios */

/* Cuando est√° seleccionado ‚Üí c√≠rculo rosa */
.custom-radio:checked {
  background-color: #da02e5; /* rosa */
  border-color: #da02e5;
}

/* Para navegadores que usan -webkit-appearance */
.custom-radio[type="radio"] {
  accent-color: #da02e5; /* Soporta Chrome/Edge/Firefox modernos */
}
</style>
<body class="index-page">

  <!-- ======= Header ======= -->
  <header id="header" class="header d-flex align-items-center fixed-top">
    <div class="container position-relative d-flex align-items-center justify-content-between">
      <a href="/" class="logo d-flex align-items-center me-auto me-xl-0">
        <h1 class="sitename">PhishIntel</h1>
      </a>

      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="/principal" class="btn-getstarted btn-login">Home</a></li>
          <li><a href="/selectorCampania" class="btn-getstarted btn-login">Volver al Panel</a></li>
        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
      </nav>
    </div>
  </header>
  <!-- End Header -->

  <main class="main">

    <!-- Page Title -->
    <div class="page-title py-5"></div>

    <!-- Formulario con Vue -->
    <section id="mensaje" class="contact section">
      <div class="col-lg-8 mx-auto" data-aos="fade-left" data-aos-delay="200">
        <!-- Vue App -->
        <div id="app" class="contact-form-wrapper">
          <div class="form-header">
            <h3>Generaci√≥n de Simulaci√≥n de Mensaje</h3>
            <p>Selecciona el √°rea, usuario y nivel de dificultad para generar un mensaje de phishing.</p>
          </div>

          <form class="php-email-form" @submit.prevent="generarPreview">

            <!-- Selector de √Årea -->
            <div class="mb-3">
              <label for="areaSelect" class="form-label">Seleccionar √Årea</label>
              <select v-model="filtroArea" class="form-control" id="areaSelect" name="area" required>
                <option value="">-- Selecciona un √°rea --</option>
                <option v-for="area in areas" :key="area.idArea" :value="area.nombreArea">
                  {{ area.nombreArea }} 
                </option>
              </select>
            </div>

            <!-- Selector de Usuario (solo visible cuando hay √°rea seleccionada) -->
            <div class="mb-3" v-if="filtroArea">
              <label for="userSelect" class="form-label">Seleccionar Usuario</label>
              <select v-model="filtroUsuario" class="form-control" id="userSelect" name="usuario" required>
                <option value="">-- Selecciona un usuario --</option>
                <option v-for="usuario in usuariosFiltrados" :key="usuario.idUsuario" :value="usuario">
                  {{ usuario.nombre }} {{ usuario.apellido }}
                </option>
              </select>
            </div>

            <!-- Dificultad -->
            <div class="mb-3">
              <label class="form-label">Nivel de Dificultad</label>

              <div class="form-check">
                <input class="form-check-input custom-radio" type="radio" v-model="nivel" id="facil" value="F√°cil" checked>
                <label class="form-check-label" for="facil">F√°cil (Mensaje directo y obvio)</label>
              </div>

              <div class="form-check">
                <input class="form-check-input custom-radio" type="radio" v-model="nivel" id="medio" value="Medio">
                <label class="form-check-label" for="medio">Medio (Mensaje con contexto corporativo)</label>
              </div>

              <div class="form-check">
                <input class="form-check-input custom-radio" type="radio" v-model="nivel" id="dificil" value="Dif√≠cil">
                <label class="form-check-label" for="dificil">Dif√≠cil (Mensaje sofisticado y personalizado)</label>
              </div>
            </div>

            <!-- Selector de Medio -->
            <div class="mb-3">
              <label class="form-label">Medio de Comunicaci√≥n</label>

              <div class="form-check">
                <input class="form-check-input custom-radio" type="radio" v-model="medio" id="telegram" value="telegram" checked>
                <label class="form-check-label" for="telegram">üì± Telegram</label>
              </div>

              <div class="form-check">
                <input class="form-check-input custom-radio" type="radio" v-model="medio" id="whatsapp" value="whatsapp">
                <label class="form-check-label" for="whatsapp">üí¨ WhatsApp</label>
              </div>

              <div class="form-check">
                <input class="form-check-input custom-radio" type="radio" v-model="medio" id="sms" value="sms">
                <label class="form-check-label" for="sms">üì± SMS</label>
              </div>
            </div>

            <!-- Selector de Proveedor (solo visible cuando hay medio seleccionado) -->
            <div class="mb-3" v-if="medio">
              <label class="form-label">Proveedor</label>
              
              <!-- Proveedores para Telegram -->
              <div v-if="medio === 'telegram'">
                <div class="form-check">
                  <input class="form-check-input custom-radio" type="radio" v-model="proveedor" id="telegram-bot" value="bot" checked>
                  <label class="form-check-label" for="telegram-bot">ü§ñ Bot (‚úÖ Funciona)</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input custom-radio" type="radio" v-model="proveedor" id="telegram-directo" value="directo" disabled>
                  <label class="form-check-label" for="telegram-directo">üì® Mensaje Directo (üöß Pr√≥ximamente)</label>
                </div>
              </div>

              <!-- Proveedores para WhatsApp -->
              <div v-if="medio === 'whatsapp'">
                <div class="form-check">
                  <input class="form-check-input custom-radio" type="radio" v-model="proveedor" id="whatsapp-whapi" value="whapi" checked>
                  <label class="form-check-label" for="whatsapp-whapi">‚òÅÔ∏è whapi.cloud (‚úÖ Funciona)</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input custom-radio" type="radio" v-model="proveedor" id="whatsapp-whapi-link-preview" value="whapi-link-preview">
                  <label class="form-check-label" for="whatsapp-whapi-link-preview">üîó whapi.cloud Link Preview (‚úÖ Funciona)</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input custom-radio" type="radio" v-model="proveedor" id="whatsapp-twilio" value="twilio">
                  <label class="form-check-label" for="whatsapp-twilio">üìû Twilio (‚ö†Ô∏è Limitado)</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input custom-radio" type="radio" v-model="proveedor" id="whatsapp-selenium" value="selenium">
                  <label class="form-check-label" for="whatsapp-selenium">ü§ñ Selenium (‚ùå No funciona)</label>
                </div>
              </div>

              <!-- Proveedores para SMS -->
              <div v-if="medio === 'sms'">
                <div class="form-check">
                  <input class="form-check-input custom-radio" type="radio" v-model="proveedor" id="sms-twilio" value="twilio" checked>
                  <label class="form-check-label" for="sms-twilio">üìû Twilio (‚ö†Ô∏è Limitado)</label>
                </div>
              </div>
            </div>

            <!-- Bot√≥n de enviar -->
            <div class="text-center">
              <button type="submit" class="btn btn-primary px-4 py-2 rounded-pill">
                <i class="bi bi-chat-dots"></i> Ver Preview
              </button>
            </div>
          </form>

          <!-- Modal Preview (dentro de #app) -->
          <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
              <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                  <h5 class="modal-title">Vista previa del mensaje a enviar</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <p><strong>Opciones Elegidas </strong></p>
                  <p><strong>√Årea: </strong>{{ filtroArea }} <span id="previewArea"></span></p>
                  <p><strong>Usuario:  </strong> {{ filtroUsuario.nombre }} {{ filtroUsuario.apellido }}<span id="previewUsuario"></span></p>
                  <p><strong>Dificultad: </strong> {{ nivel }}<span id="previewDificultad"></span></p>
                  <p><strong>Medio: </strong> {{ medio === 'whatsapp' ? 'WhatsApp' : medio === 'telegram' ? 'Telegram' : 'SMS' }}<span id="previewMedio"></span></p>
                  <p><strong>Proveedor: </strong> {{ proveedor }}<span id="previewProveedor"></span></p>
                  <hr>
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <p><strong>Mensaje generado por IA</strong></p>
                    <button type="button" class="btn btn-sm btn-outline-primary" @click="regenerarMensaje">
                      <i class="bi bi-arrow-clockwise"></i> Regenerar
                    </button>
                  </div>
                  <div class="bg-light text-dark p-3 rounded">
                    <textarea 
                      v-model="modalMensaje" 
                      class="form-control border-0 bg-transparent" 
                      rows="6" 
                      style="resize: vertical; font-family: inherit; white-space: pre-wrap;"
                      placeholder="El mensaje aparecer√° aqu√≠..."
                    ></textarea>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="button" class="btn btn-primary" @click="confirmarEnvio">Confirmar y Enviar</button>
                </div>
              </div>
            </div>
          </div>

        </div><!-- End #app -->
      </div>
    </section>
  </main>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/aos/aos.js"></script>
  <script>
    AOS.init();
  </script>

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          areas: [],
          filtroArea: "",
          filtroUsuario: "",
          nivel: "F√°cil",
          medio: "telegram",
          proveedor: "bot",
          modalMensaje: "",
          mensajeGenerado: {
            medio: "telegram",
            proveedor: "bot",
            idUsuario: null, 
            mensaje: ""
          }
        };
      },
      computed: {
        usuariosFiltrados() {
          const areaSeleccionada = this.areas.find(a => a.nombreArea === this.filtroArea);
          return areaSeleccionada ? areaSeleccionada.usuarios : [];
        }
      },
      watch: {
        filtroArea() {
          // Limpiar usuario seleccionado cuando cambie el √°rea
          this.filtroUsuario = "";
        },
        medio() {
          // Resetear proveedor cuando cambie el medio
          if (this.medio === 'telegram') {
            this.proveedor = 'bot';
          } else if (this.medio === 'whatsapp') {
            this.proveedor = 'whapi';
          } else if (this.medio === 'sms') {
            this.proveedor = 'twilio';
          }
        }
      },
      methods: {
        async generarPreview() {
          try {
            const resp = await fetch("http://localhost:8080/api/mensaje/generar", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                contexto: `√Årea: ${this.filtroArea}, Usuario: ${this.filtroUsuario.nombre} ${this.filtroUsuario.apellido}, La fecha que sea el 24/8/2025, Sin links, No le pidas informacion ni pongas un asunto en mayuscula. Pone un tono mas corporativo para que no llegue a spam.`,
                nivel: this.nivel
              })
            });

            if (!resp.ok) throw new Error("Error generando el mensaje");

            const data = await resp.json();
            this.modalMensaje = data.mensaje || "Sin mensaje";
            
            this.mensajeGenerado.mensaje = data.mensaje;
            this.mensajeGenerado.idUsuario = this.filtroUsuario.idUsuario;
            this.mensajeGenerado.medio = this.medio;
            this.mensajeGenerado.proveedor = this.proveedor;

            // Abrir modal
            const modal = new bootstrap.Modal(document.getElementById("previewModal"));
            modal.show();

          } catch (e) {
            console.error("Error:", e);
            alert("No se pudo generar el mensaje");
          }
        },

        async regenerarMensaje() {
          try {
            const resp = await fetch("http://localhost:8080/api/mensaje/generar", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                contexto: `√Årea: ${this.filtroArea}, Usuario: ${this.filtroUsuario.nombre} ${this.filtroUsuario.apellido}, La fecha que sea el 24/8/2025, Sin links, No le pidas informacion ni pongas un asunto en mayuscula. Pone un tono mas corporativo para que no llegue a spam.`,
                nivel: this.nivel
              })
            });

            if (!resp.ok) throw new Error("Error regenerando el mensaje");

            const data = await resp.json();
            this.modalMensaje = data.mensaje || "Sin mensaje";
            this.mensajeGenerado.mensaje = data.mensaje;

          } catch (e) {
            console.error("Error:", e);
            alert("No se pudo regenerar el mensaje");
          }
        },

        async confirmarEnvio() {
          try {
            const resp = await fetch("http://localhost:8080/api/mensaje/enviar-id", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                medio: this.medio,
                proveedor: this.proveedor,
                idUsuario: this.filtroUsuario.idUsuario,
                mensaje: this.modalMensaje
              })
            });

            if (!resp.ok) throw new Error("Error enviando el mensaje");

            const data = await resp.json();
            alert("Mensaje enviado correctamente ‚úÖ");
            bootstrap.Modal.getInstance(document.getElementById("previewModal")).hide();

          } catch (e) {
            console.error("Error:", e);
            alert("No se pudo enviar el mensaje");
          }
        }
      },
      async mounted() {
        try {
          const resp = await fetch("http://localhost:8080/api/areas");
          const data = await resp.json();
          this.areas = data.areas || [];
        } catch (e) {
          console.error("Error cargando √°reas:", e);
        }
      }
    }).mount("#app");
  </script>

</body>

</html>
