<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Reportar Evento - PhishIntel</title>

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Raleway&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="assets/css/main.css" rel="stylesheet">
</head>
<style>
/* Personalizar los radios */

/* Cuando est√° seleccionado ‚Üí c√≠rculo rosa */
.custom-radio:checked {
  background-color: #da02e5; /* rosa */
  border-color: #da02e5;
}

/* Para navegadores que usan -webkit-appearance */
.custom-radio[type="radio"] {
  accent-color: #da02e5; /* Soporta Chrome/Edge/Firefox modernos */
}
/* Botones de fecha r√°pida - EST√âTICA 100% NEGRO/BLANCO/ROSA */
.fecha-rapida-btn {
  background-color: transparent !important;
  color: #ffffff !important;
  border: 1px solid #555 !important; /* gris oscuro para no seleccionado */
  border-radius: 0.375rem !important;
  font-size: 0.9rem;
  transition: all 0.3s ease;
  flex: 1;
}

.fecha-rapida-btn:hover {
  background-color: rgba(218, 2, 229, 0.15) !important; /* rosa muy suave */
  border-color: #da02e5 !important;
  color: #ffffff !important;
  box-shadow: 0 0 10px rgba(218, 2, 229, 0.3) !important;
  transform: translateY(-1px);
}

/* Cuando est√° seleccionado/activo */
.fecha-rapida-btn.active,
.fecha-rapida-btn.selected {
  background: linear-gradient(135deg, #da02e5, #b800c9) !important;
  border-color: #da02e5 !important;
  color: white !important;
  box-shadow: 0 4px 15px rgba(218, 2, 229, 0.4) !important;
}

/* Quitar foco azul molesto */
.fecha-rapida-btn:focus,
.fecha-rapida-btn:active {
  box-shadow: 0 0 0 0.2rem rgba(218, 2, 229, 0.3) !important;
  outline: none !important;
}
.fecha-rapida-btn.active {
  position: relative;
  overflow: hidden;
}

.fecha-rapida-btn.active::before {
  content: '';
  position: absolute;
  top: 0; left: -100%;
  width: 100%; height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  animation: shine 3s infinite;
}

@keyframes shine {
  0% { left: -100%; }
  100% { left: 100%; }
}
/* Mejorar el selector de fecha */
input[type="datetime-local"] {
  background-color: #2d2d2d !important;
  color: white !important;
  border: 1px solid #da02e5 !important;
  border-radius: 0.375rem !important;
  padding: 0.5rem 0.75rem !important;
  font-size: 0.9rem !important;
  transition: all 0.3s ease !important;
}

input[type="datetime-local"]:focus {
  background-color: #2d2d2d !important;
  color: white !important;
  border-color: #da02e5 !important;
  box-shadow: 0 0 0 0.2rem rgba(218, 2, 229, 0.25) !important;
  outline: none !important;
}

input[type="datetime-local"]:hover {
  border-color: #da02e5 !important;
  box-shadow: 0 0 10px rgba(218, 2, 229, 0.2) !important;
}

/* Estilo para el calendario/reloj que aparece */
input[type="datetime-local"]::-webkit-calendar-picker-indicator {
  background-color: #da02e5;
  border-radius: 0.25rem;
  cursor: pointer;
  padding: 0.25rem;
}

input[type="datetime-local"]::-webkit-calendar-picker-indicator:hover {
  background-color: #b802c7;
}

.disabled-date-input {
  opacity: 0.5;
  cursor: not-allowed;
}
</style>
<body class="index-page">

  <!-- ======= Header ======= -->
  <header id="header" class="header d-flex align-items-center fixed-top">
    <div class="container position-relative d-flex align-items-center justify-content-between">
      <a href="/" class="logo d-flex align-items-center me-auto me-xl-0">
        <h1 class="sitename">PhishIntel</h1>
      </a>

      <nav id="navmenu" class="navmenu">
        <ul>
          <li><span id="user-info" class="user-welcome">Cargando...</span></li>
          <li><a href="/principalEmpleado" class="btn-getstarted btn-login">Volver al Panel</a></li>
          <li><a href="#" onclick="logout()" class="btn-getstarted btn-login">Logout</a></li>
        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
      </nav>
    </div>
  </header>
  <!-- End Header -->

  <main class="main">

    <!-- Page Title -->
    <div class="page-title py-5"></div>

    <!-- Formulario de Reporte -->
    <section id="reporte" class="contact section">
      <div class="col-lg-8 mx-auto" data-aos="fade-left" data-aos-delay="200">
        <!-- Vue App -->
        <div id="app" class="contact-form-wrapper">
          <div class="form-header">
            <h3>Reportar Evento de Phishing</h3>
            <p>Reporta eventos de phishing que hayas recibido para mejorar tu scoring.</p>
          </div>

          <form class="php-email-form" @submit.prevent="reportarEvento">

            <!-- Tipo de Evento -->
            <div class="mb-4">
              <label class="form-label mb-3">Tipo de Evento</label>
              <div class="row g-2">
                <div class="col-md-4">
                  <div class="card bloque bloque-normal"
                       @click="tipoEvento = 'CORREO'"
                       :style="tipoEvento === 'CORREO' ? 'border-color: var(--accent-color);' : 'bloque-normal'">
                    <div class="card-body text-center p-2">
                      <div style="font-size: 1.5em;"><i class="bi bi-mailbox"></i></div>
                      <h6 class="card-title mb-0" style="font-size: 0.8em;">Correo</h6>
                      <small class="card-text" style="font-size: 0.7em;">Electr√≥nico</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card bloque bloque-normal"
                       @click="tipoEvento = 'MENSAJE'"
                       :style="tipoEvento === 'MENSAJE' ? 'border-color: var(--accent-color);' : 'bloque-normal'">
                    <div class="card-body text-center p-2">
                      <div style="font-size: 1.5em;"><i class="bi bi-cloud"></i></div>
                      <h6 class="card-title mb-0" style="font-size: 0.8em;">Mensaje</h6>
                      <small class="card-text" style="font-size: 0.7em;">WhatsApp/SMS</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card bloque bloque-normal"
                       @click="tipoEvento = 'LLAMADA'"
                       :style="tipoEvento === 'LLAMADA' ? 'border-color: var(--accent-color);' : 'bloque-normal'">
                    <div class="card-body text-center p-2">
                      <div style="font-size: 1.5em;"><i class="bi bi-telephone"></i></div>
                      <h6 class="card-title mb-0" style="font-size: 0.8em;">Llamada</h6>
                      <small class="card-text" style="font-size: 0.7em;">Telef√≥nica</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Rango de Fechas -->
            <div class="mb-4">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <label class="form-label mb-0">Rango de Fechas en las que Ocurri√≥ el Evento</label>
              </div>

              <!-- Botones r√°pidos de fecha - SIN AZUL NUNCA -->
              <div class="btn-group w-100 mb-3" role="group" aria-label="Seleccionar rango r√°pido de fechas">
                <button type="button"
                        class="btn fecha-rapida-btn"
                        :class="{ 'active': dateMode === 'HOY', 'selected': dateMode === 'HOY' }"
                        @click="setFechaRapida('HOY')">
                  {{ getDescripcionFechaRapida('HOY') }}
                </button>
                <button type="button"
                        class="btn fecha-rapida-btn"
                        :class="{ 'active': dateMode === 'AYER', 'selected': dateMode === 'AYER' }"
                        @click="setFechaRapida('AYER')">
                  {{ getDescripcionFechaRapida('AYER') }}
                </button>
                <button type="button"
                        class="btn fecha-rapida-btn"
                        :class="{ 'active': dateMode === 'RANGO', 'selected': dateMode === 'RANGO' }"
                        @click="setFechaRapida('RANGO')">
                  Elegir rango manual
                </button>
              </div>

              <div class="row g-3" v-if="dateMode === 'RANGO'">
                <div class="col-md-6">
                  <label for="fechaInicio" class="form-label">Fecha de Inicio</label>
                  <input type="datetime-local" v-model="fechaInicio" class="form-control" id="fechaInicio" required
                         @change="validarRangoFechas"
                         style="background-color: #2d2d2d; color: white; border: 1px solid #da02e5;">
                </div>
                <div class="col-md-6">
                  <label for="fechaFin" class="form-label">Fecha de Fin</label>
                  <input type="datetime-local" v-model="fechaFin" class="form-control" id="fechaFin" required
                         @change="validarRangoFechas"
                         style="background-color: #2d2d2d; color: white; border: 1px solid #da02e5;">
                </div>
              </div>

              <div v-if="errorFechas" class="alert alert-warning mt-2" style="background-color: rgba(255,193,7,0.1); border: 1px solid #ffc107; color: #ffc107;">
                <i class="bi bi-exclamation-triangle me-2"></i>
                {{ errorFechas }}
              </div>
              <small v-if="dateMode === 'RANGO'" style="color: white; font-size: 0.8em;">
                <i class="bi bi-info-circle me-1" style="color: white;"></i>
                M√°ximo 2 d√≠as de diferencia entre las fechas
              </small>
            </div>

            <!-- Bot√≥n de enviar -->
            <div class="text-center">
              <button type="submit" class="btn btn-primary px-4 py-2 rounded-pill" :disabled="cargando">
                <span v-if="cargando">
                  <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                  Reportando...
                </span>
                <span v-else>
                  <i class="bi bi-shield-check"></i> Reportar Evento
                </span>
              </button>
            </div>
          </form>

          <!-- Modal Resultado -->
          <div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
              <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                  <h5 class="modal-title">Resultado del Reporte</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-4">
                    <h6 class="mb-3" style="color: white;">
                      <i class="bi bi-info-circle-fill me-2"></i>Estado del Reporte
                    </h6>
                    
                    <div class="row g-3">
                      <!-- Tipo de Evento -->
                      <div class="col-md-6">
                        <div class="d-flex align-items-center p-2 rounded" style="background-color: #2d2d2d; color: white;">
                          <span class="me-2">{{ getTipoIcon(resultado.tipoEvento) }}</span>
                          <div>
                            <small class="d-block" style="color: #ccc;">Tipo de Evento</small>
                            <strong>{{ getTipoNombre(resultado.tipoEvento) }}</strong>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Estado -->
                      <div class="col-md-6">
                        <div class="d-flex align-items-center p-2 rounded" style="background-color: #2d2d2d; color: white;">
                          <span class="me-2">{{ resultado.verificado ? '‚úÖ' : '‚ö†Ô∏è' }}</span>
                          <div>
                            <small class="d-block" style="color: #ccc;">Estado</small>
                            <strong>{{ resultado.verificado ? 'Verificado' : 'No Verificado' }}</strong>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Mensaje -->
                      <div class="col-12">
                        <div class="alert" :class="resultado.verificado ? 'alert-success' : 'alert-warning'" style="background-color: #2d2d2d; border: 1px solid #da02e5;">
                          <h6>{{ resultado.mensaje }}</h6>

                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Mis Reportes -->
    <section id="reportes" class="contact section">
      <div class="col-lg-10 mx-auto" data-aos="fade-right" data-aos-delay="300">
        <div class="contact-form-wrapper">
          <div class="form-header">
            <h3>Mis Reportes Anteriores</h3>
            <p>Historial completo de tus reportes de phishing.</p>
          </div>
          
          <div id="reports-container">
            <div class="text-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/aos/aos.js"></script>
  
  <!-- Script de configuraci√≥n para obtener URL del backend -->
  <script src="assets/js/config.js"></script>
  
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script>
    AOS.init();
  </script>

  <script>
    // Vue App
    const { createApp } = Vue;
    
    createApp({
      data() {
        return {
          tipoEvento: '',
          fechaInicio: '',
          fechaFin: '',
          cargando: false,
          errorFechas: '',
          dateMode: '',
          resultado: {
            mensaje: '',
            verificado: false,
            resultadoVerificacion: '',
            tipoEvento: ''
          }
        }
      },
      methods: {
        setFechaRapida(modo) {
          this.dateMode = modo;

          const ahora = new Date();
          let inicio, fin;

          if (modo === 'HOY') {
            inicio = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate(), 0, 0, 0);
            fin = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate(), 23, 59, 0);
          } else if (modo === 'AYER') {
            const ayer = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate() - 1);
            inicio = new Date(ayer.getFullYear(), ayer.getMonth(), ayer.getDate(), 0, 0, 0);
            fin = new Date(ayer.getFullYear(), ayer.getMonth(), ayer.getDate(), 23, 59, 0);
          } else if (modo === 'RANGO') {
            // En modo rango, no sobreescribimos las fechas actuales; solo habilitamos los campos
            this.errorFechas = '';
            return;
          } else {
            return;
          }

          const toLocalInput = (d) => {
            const pad = (n) => n.toString().padStart(2, '0');
            const year = d.getFullYear();
            const month = pad(d.getMonth() + 1);
            const day = pad(d.getDate());
            const hours = pad(d.getHours());
            const minutes = pad(d.getMinutes());
            return `${year}-${month}-${day}T${hours}:${minutes}`;
          };

          this.fechaInicio = toLocalInput(inicio);
          this.fechaFin = toLocalInput(fin);
          this.errorFechas = '';
        },
        getDescripcionFechaRapida(modo) {
          const hoy = new Date();

          const formatoFecha = (d) => {
            const dia = d.getDate().toString().padStart(2, '0');
            const mes = (d.getMonth() + 1).toString().padStart(2, '0');
            return `${dia}/${mes}`;
          };

          if (modo === 'HOY') {
            return `Ocurri√≥ hoy ${formatoFecha(hoy)}`;
          }

          if (modo === 'AYER') {
            const ayer = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate() - 1);
            return `Ocurri√≥ ayer ${formatoFecha(ayer)}`;
          }

          return '';
        },
        validarRangoFechas() {
          if (!this.fechaInicio || !this.fechaFin) {
            this.errorFechas = '';
            return;
          }
          
          const fechaInicio = new Date(this.fechaInicio);
          const fechaFin = new Date(this.fechaFin);
          
          // Verificar que la fecha de fin sea posterior a la de inicio
          if (fechaFin <= fechaInicio) {
            this.errorFechas = 'La fecha de fin debe ser posterior a la fecha de inicio';
            return;
          }
          
          // Calcular la diferencia en d√≠as
          const diferenciaMs = fechaFin - fechaInicio;
          const diferenciaDias = diferenciaMs / (1000 * 60 * 60 * 24);
          
          if (diferenciaDias > 2) {
            this.errorFechas = 'El rango de fechas no puede ser mayor a 2 d√≠as';
            return;
          }
          
          this.errorFechas = '';
        },
        
        async reportarEvento() {
          if (!this.tipoEvento || !this.fechaInicio || !this.fechaFin) {
            alert('Por favor completa todos los campos');
            return;
          }
          
          // Validar fechas antes de enviar
          this.validarRangoFechas();
          if (this.errorFechas) {
            alert('Por favor corrige los errores en las fechas antes de continuar');
            return;
          }

          this.cargando = true;
          
          try {
            const formData = {
              tipoEvento: this.tipoEvento,
              fechaInicio: new Date(this.fechaInicio).toISOString(),
              fechaFin: new Date(this.fechaFin).toISOString()
            };
            
            const response = await fetch(`${API_BASE_URL}/api/empleado/reportar-evento`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            
            this.resultado = {
              mensaje: data.mensaje,
              verificado: data.verificado,
              resultadoVerificacion: data.resultadoVerificacion,
              tipoEvento: this.tipoEvento
            };
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('resultModal'));
            modal.show();
            
            // Limpiar formulario
            this.tipoEvento = '';
            this.fechaInicio = '';
            this.fechaFin = '';
            this.dateMode = '';
            this.errorFechas = '';
            
            // Recargar reportes
            this.loadReports();
            
          } catch (error) {
            console.error('Error:', error);
            alert('Error al reportar evento. Por favor, int√©ntalo de nuevo.');
          } finally {
            this.cargando = false;
          }
        },
        
        getTipoIcon(tipo) {
          const icons = {
            'CORREO': 'üìß',
            'MENSAJE': 'üí¨',
            'LLAMADA': 'üìû',
          };
          return icons[tipo] || '‚ùì';
        },
        
        getTipoNombre(tipo) {
          const nombres = {
            'CORREO': 'Correo Electr√≥nico',
            'MENSAJE': 'Mensaje (WhatsApp/SMS)',
            'LLAMADA': 'Llamada Telef√≥nica',
          };
          return nombres[tipo] || tipo;
        },
        
        async loadReports() {
          try {
            const response = await fetch(`${API_BASE_URL}/api/empleado/mis-reportes`);
            const data = await response.json();
            
            const container = document.getElementById('reports-container');
            
            if (data.intentos && data.intentos.length > 0) {
              let html = '<div class="table-responsive"><table class="table table-dark table-striped">';
              html += '<thead><tr><th>Tipo</th><th>Fecha Inicio</th><th>Fecha Fin</th><th>Fecha Reporte</th><th>Estado</th><th>Resultado</th></tr></thead>';
              html += '<tbody>';
              
              data.intentos.forEach(intento => {
                const estado = intento.verificado ? 
                  '<span class="badge bg-success">Verificado</span>' : 
                  '<span class="badge bg-warning">Pendiente</span>';
                
                html += `<tr>
                  <td>${this.getTipoIcon(intento.tipoEvento)} ${this.getTipoNombre(intento.tipoEvento)}</td>
                  <td>${new Date(intento.fechaInicio).toLocaleString()}</td>
                  <td>${new Date(intento.fechaFin).toLocaleString()}</td>
                  <td>${new Date(intento.fechaIntento).toLocaleString()}</td>
                  <td>${estado}</td>
                  <td>${intento.resultadoVerificacion || 'N/A'}</td>
                </tr>`;
              });
              
              html += '</tbody></table></div>';
              container.innerHTML = html;
            } else {
              container.innerHTML = '<p class="text-center" style="color: #b0b0b0)">No tienes reportes anteriores.</p>';
            }
          } catch (error) {
            console.error('Error cargando reportes:', error);
            document.getElementById('reports-container').innerHTML = 
              '<p class="text-center text-danger">Error cargando reportes.</p>';
          }
        }
      },
      mounted() {
        this.loadReports();
      
      }
    }).mount('#app');

    // Cargar informaci√≥n del usuario al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
      loadUserInfo();
    });

    function loadUserInfo() {
      fetch(`${API_BASE_URL}/api/auth/current-user`)
        .then(response => response.json())
        .then(data => {
          if (data.usuario) {
            document.getElementById('user-info').textContent = `Bienvenido, ${data.usuario.nombre} ${data.usuario.apellido}`;
          } else {
            // Si no hay usuario logueado, redirigir al login
            window.location.href = '/login';
          }
        })
        .catch(error => {
          console.error('Error:', error);
          window.location.href = '/login';
        });
    }

    function logout() {
      fetch(`${API_BASE_URL}/api/auth/logout`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        window.location.href = '/login';
      })
      .catch(error => {
        console.error('Error:', error);
        window.location.href = '/login';
      });
    }
  </script>

</body>
</html>