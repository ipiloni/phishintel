<!DOCTYPE html>
<html lang="en">

<head>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Login - PhishIntel</title>

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Raleway&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="assets/css/main.css" rel="stylesheet">
</head>

<body class="index-page">

  <!-- ======= Header ======= -->
  <header id="header" class="header d-flex align-items-center fixed-top">
    <div class="container position-relative d-flex align-items-center justify-content-between">
      <a href="index.html" class="logo d-flex align-items-center me-auto me-xl-0">
        <h1 class="sitename">PhishIntel</h1>
      </a>

      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="index.html" class="btn-getstarted btn-login">Home</a></li>
          <!--<li><a href="login.html" class="btn-getstarted btn-login">Login</a></li>-->
        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
      </nav>
    </div>
  </header>
  <!-- End Header -->

  <main class="main">

  <!-- Page Title -->
  <div class="page-title py-5">
  </div>

  <!-- Contact Section -->
  <section id="contact" class="contact section">
    <!-- Section Title -->
    <div class="col-lg-6 mx-auto" data-aos="fade-left" data-aos-delay="200">
      <div class="contact-form-wrapper">
        <div class="form-header">
          <h3>Iniciar Sesión</h3>
          <p>Ingresa tus datos para acceder a tu cuenta.</p>
        </div>

       <form id="loginForm" class="php-email-form">
  <div class="mb-3">
    <label for="loginEmail" class="form-label">Correo o usuario</label>
    <input type="text" class="form-control" name="email" id="loginEmail" placeholder="Ingresa tu correo o usuario" required>
  </div>

  <div class="mb-3">
    <label for="loginPassword" class="form-label">Contraseña</label>
    <input type="password" class="form-control" name="password" id="loginPassword" placeholder="Ingresa tu contraseña" required>
  </div>

  <div class="my-3">
    <div class="error-message" style="display:none; color:white; text-align:center;"></div>


  </div>

  <button type="submit" id="loginButton" class="submit-btn">
    <span id="loginButtonText">Ingresar</span>
    <i id="loginButtonIcon" class="bi bi-arrow-right"></i>
    <span id="loginButtonSpinner" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true" style="display: none;"></span>
  </button>

  <button type="button" id="googleLoginButton" class="submit-btn-google">
      <span id="googleLoginButtonText">Ingresar con Google</span>
      <i id="googleLoginButtonIcon" class="bi bi-google"></i>
      <span id="googleLoginButtonSpinner" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true" style="display: none;"></span>
  </button>
</form>

        <p class="mt-3 text-center">
          ¿No tenes una cuenta? <a href="/registro">Registrate acá</a>
        </p>
      </div>  
    </div>
  </section><!-- /Contact Section -->

</main>


  <!-- Vendor JS Files -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/aos/aos.js"></script>
  
  <!-- Script de configuración para obtener URL del backend -->
  <script src="assets/js/config.js"></script>
  <meta name="google-signin-client_id" content="387090655276-8f9s91d8ir0go3ujuspnu6kc78d2ti6h.apps.googleusercontent.com">
  <script>
    AOS.init();
  </script>
<script>
document.getElementById("loginForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  const loginButton = document.getElementById("loginButton");
  const loginButtonText = document.getElementById("loginButtonText");
  const loginButtonIcon = document.getElementById("loginButtonIcon");
  const loginButtonSpinner = document.getElementById("loginButtonSpinner");
  const errorMessage = document.querySelector(".error-message");

  // Mostrar estado de carga en el botón
  loginButton.disabled = true;
  loginButtonText.textContent = "Ingresando...";
  loginButtonIcon.style.display = "none";
  loginButtonSpinner.style.display = "inline-block";
  errorMessage.style.display = "none";

  const email = document.getElementById("loginEmail").value.trim();
  const password = document.getElementById("loginPassword").value;

  if (!email || !password) {
    mostrarToastError("Completá email y contraseña");
    resetearBoton();
    return;
  }

  try {
    const res = await fetch("/verificarlogin", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "same-origin",
      body: JSON.stringify({ email, password })
    });

    const data = await res.json();

    if (res.ok) {
      // Mostrar toast de éxito
      mostrarToastExito();
      setTimeout(() => { window.location.href = data.redirect; }, 1500);
    } else {
      // Mostrar toast de error
      mostrarToastError(data.error || "Error al iniciar sesión");
      document.getElementById("loginPassword").value = "";
      resetearBoton();
    }
  } catch (err) {
    // Mostrar toast de error
    mostrarToastError("Error de conexión con el servidor");
    document.getElementById("loginPassword").value = "";
    resetearBoton();
  }
});

function mostrarToastExito() {
  const toastElement = document.getElementById('successToast');
  const toast = new bootstrap.Toast(toastElement, {
    autohide: true,
    delay: 3000
  });
  toast.show();
}

function mostrarToastError(mensaje) {
  const toastElement = document.getElementById('errorToast');
  const toastBody = toastElement.querySelector('.toast-body');
  toastBody.textContent = mensaje + " ❌";
  const toast = new bootstrap.Toast(toastElement, {
    autohide: true,
    delay: 5000
  });
  toast.show();
}

function resetearBoton() {
  const loginButton = document.getElementById("loginButton");
  const loginButtonText = document.getElementById("loginButtonText");
  const loginButtonIcon = document.getElementById("loginButtonIcon");
  const loginButtonSpinner = document.getElementById("loginButtonSpinner");
  
  loginButton.disabled = false;
  loginButtonText.textContent = "Ingresar";
  loginButtonIcon.style.display = "inline-block";
  loginButtonSpinner.style.display = "none";
}

let googleClient;

function initializeGoogleLogin() {
  // Construir redirect_uri dinámicamente basado en la URL actual
  const currentProtocol = window.location.protocol;
  const currentHost = window.location.host;
  const redirectUri = `${currentProtocol}//${currentHost}/login`;
  
  console.log('Google OAuth redirect_uri:', redirectUri);
  
  googleClient = google.accounts.oauth2.initCodeClient({
    client_id: "387090655276-8f9s91d8ir0go3ujuspnu6kc78d2ti6h.apps.googleusercontent.com",
    scope: "email profile",
    ux_mode: "popup",
    redirect_uri: "postmessage",
    callback: handleCredentialResponse
  });

  const btn = document.getElementById("googleLoginButton");
  btn.addEventListener("click", () => {
    googleClient.requestCode(); // Esto abre el popup clásico
  });
}

function handleCredentialResponse(response) {
  // Este callback se ejecuta cuando Google responde con el token
  fetch(`${API_BASE_URL}/api/google/login`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ token: response.code }) // ahora es "code" (authorization code)
  })
  .then(async res => {
    const data = await res.json();
    if (res.ok) {
      mostrarToastExito();
      setTimeout(() => window.location.href = data.redirect, 1500);
    } else {
      mostrarToastError(data.error || "Error al iniciar sesión");
      resetearBotonGoogle();
    }
  });
}

window.onload = initializeGoogleLogin;

function resetearBotonGoogle() {
  document.getElementById("googleLoginButtonText").style.display = "inline";
  document.getElementById("googleLoginButtonIcon").style.display = "inline";
  document.getElementById("googleLoginButtonSpinner").style.display = "none";
}
</script>

  <!-- Toast de notificación -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" style="background-color: #1a1a1a; border: 1px solid #da02e5;">
      <div class="toast-header" style="background-color: #2d2d2d; color: white; border-bottom: 1px solid #da02e5;">
        <i class="bi bi-check-circle-fill me-2" style="color: #da02e5;"></i>
        <strong class="me-auto">Éxito</strong>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" style="background-color: #1a1a1a; color: white;">
        Login exitoso ✅
      </div>
    </div>
    
    <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" style="background-color: #1a1a1a; border: 1px solid #da02e5;">
      <div class="toast-header" style="background-color: #2d2d2d; color: white; border-bottom: 1px solid #da02e5;">
        <i class="bi bi-exclamation-triangle-fill me-2" style="color: #da02e5;"></i>
        <strong class="me-auto">Error</strong>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" style="background-color: #1a1a1a; color: white;">
        Error al iniciar sesión ❌
      </div>
    </div>
  </div>

</body>
</html>
