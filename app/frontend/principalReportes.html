<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Reportes - PhishIntel</title>

    <link href="assets/img/favicon.png" rel="icon">
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/vendor/aos/aos.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Raleway&display=swap" rel="stylesheet">
    <link href="assets/css/main.css" rel="stylesheet">
    <style>
      .card.bg-dark .card-header { background-color: #1f1f1f; border-bottom: 1px solid #3a3a3a; }
      .card.bg-dark .card-body { background-color: #1b1b1b; }
      .card.bg-dark, .card.bg-dark .card-body, .card.bg-dark .card-header { color: #f1f1f1; }
      .nav-tabs { border-bottom: 1px solid #3a3a3a; }
      .nav-tabs .nav-link { color: #dddddd; }
      .nav-tabs .nav-link:hover { color: #ffffff; }
      
      /* Estilos para select múltiple mejorados - Oculto por defecto */
      select[multiple] {
        min-height: 40px;
        max-height: 40px;
        background: linear-gradient(145deg, #2a2a2a, #1e1e1e);
        border: 2px solid #444;
        border-radius: 12px;
        color: #f1f1f1;
        font-size: 0.9rem;
        padding: 8px 12px;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
        overflow: hidden;
        position: relative;
      }
      
       select[multiple]:focus {
         border-color: #da02e5;
         box-shadow: 0 0 0 3px rgba(218, 2, 229, 0.2);
         outline: none;
         max-height: 200px;
         overflow-y: auto;
       }
       
       select[multiple]:hover {
         border-color: #da02e5;
         cursor: pointer;
       }
      
      select[multiple] option {
        padding: 8px 12px;
        margin: 2px 0;
        border-radius: 6px;
        background: transparent;
        color: #f1f1f1;
        transition: all 0.2s ease;
        display: none;
      }
      
      select[multiple]:focus option {
        display: block;
      }
      
      /* Asegurar que el placeholder se oculte cuando hay opciones visibles */
      select[multiple]:focus .filter-placeholder {
        display: none !important;
      }
      
       select[multiple] option:hover {
         background: rgba(218, 2, 229, 0.1);
       }
       
       select[multiple] option:checked {
         background: linear-gradient(135deg, #da02e5, #e533f0);
         color: white;
         font-weight: 600;
         box-shadow: 0 2px 4px rgba(218, 2, 229, 0.3);
       }
      
      /* Placeholder text para mostrar selecciones */
      .filter-placeholder {
        position: absolute;
        top: 50%;
        left: 12px;
        transform: translateY(-50%);
        color: #888;
        pointer-events: none;
        font-size: 0.9rem;
        transition: all 0.3s ease;
      }
      
      select[multiple]:focus .filter-placeholder {
        opacity: 0;
        visibility: hidden;
      }
      
       /* Indicador de dropdown */
       .filter-dropdown-icon {
         position: absolute;
         top: 50%;
         right: 12px;
         transform: translateY(-50%);
         color: #da02e5;
         pointer-events: none;
         transition: transform 0.3s ease;
       }
      
      select[multiple]:focus .filter-dropdown-icon {
        transform: translateY(-50%) rotate(180deg);
      }
      
      /* Ocultar opciones cuando se pierde el foco */
      select[multiple]:not(:focus) {
        max-height: 40px;
        overflow: hidden;
      }
      
      select[multiple]:not(:focus) option {
        display: none;
      }
      
      /* Mejorar la apariencia del placeholder cuando hay selecciones */
      .filter-placeholder.has-selection {
        color: #f1f1f1;
        font-weight: 500;
      }
      
      /* Mejorar la apariencia de los filtros */
      .form-select-sm[multiple] {
        font-size: 0.9rem;
      }
      
       /* Estilos para los labels de filtros */
       .filter-label {
         background: linear-gradient(135deg, #da02e5, #e533f0);
         color: white;
         padding: 6px 12px;
         border-radius: 20px;
         font-size: 0.85rem;
         font-weight: 600;
         text-transform: uppercase;
         letter-spacing: 0.5px;
         box-shadow: 0 2px 8px rgba(218, 2, 229, 0.3);
         border: none;
         min-width: 80px;
         text-align: center;
       }
      
      /* Contenedor de filtros mejorado */
      .filters-container {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        padding: 15px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }
      
      /* Espaciado mejorado entre filtros */
      .filter-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }
      
      .filter-group:last-child {
        margin-bottom: 0;
      }
      
      /* Iconos para los filtros */
      .filter-icon {
        font-size: 1.1rem;
        margin-right: 6px;
      }
      
      /* Responsive para filtros */
      @media (max-width: 768px) {
        .filters-container {
          flex-direction: column;
          gap: 10px;
        }
        
        .filter-group {
          flex-direction: column;
          align-items: stretch;
          gap: 8px;
        }
        
        .filter-label {
          text-align: center;
          min-width: auto;
        }
        
        select[multiple] {
          width: 100% !important;
        }
      }
      
      /* Animación suave para hover */
      .filters-container:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      }
      
      /* Mejorar el scroll de los selects */
      select[multiple]::-webkit-scrollbar {
        width: 8px;
      }
      
      select[multiple]::-webkit-scrollbar-track {
        background: #2a2a2a;
        border-radius: 4px;
      }
      
       select[multiple]::-webkit-scrollbar-thumb {
         background: #da02e5;
         border-radius: 4px;
       }
       
       select[multiple]::-webkit-scrollbar-thumb:hover {
         background: #e533f0;
       }
      .nav-tabs .nav-link.active { color: #ffffff; background-color: #1f1f1f; border-color: #3a3a3a #3a3a3a #1f1f1f; }
      
      /* Estilos para las áreas colapsables */
      .card-header[data-bs-toggle="collapse"] {
        transition: all 0.3s ease;
      }
      
      .card-header[data-bs-toggle="collapse"]:hover {
        background: linear-gradient(135deg, #e533f0, #f066ff) !important;
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(218, 2, 229, 0.4);
      }
      
      .bi-chevron-down {
        transition: transform 0.3s ease;
      }
      
      /* Mejorar el estilo de las tarjetas de empleados */
      .card.bg-dark {
        transition: all 0.3s ease;
      }
      
      .card.bg-dark:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(218, 2, 229, 0.3);
      }
      
      /* Estilos para badges mejorados */
      .badge {
        font-weight: 600;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
      }
      
      .badge:hover {
        transform: scale(1.05);
      }
    </style>
</head>
<body class="index-page">

  <header id="header" class="header d-flex align-items-center fixed-top">
    <div class="container position-relative d-flex align-items-center justify-content-between">
      <a href="/principal" class="logo d-flex align-items-center me-auto me-xl-0">
        <h1 class="sitename">PhishIntel</h1>
      </a>
      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="/principal" class="btn-getstarted btn-login">Home</a></li>
        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
      </nav>
    </div>
  </header>

  <main class="main">
    <br>
    <section class="section">
      <div class="container" data-aos="fade-up">
        <div class="mb-3">
           <ul class="nav nav-tabs" role="tablist">
             <li class="nav-item" role="presentation">
               <button class="nav-link active" id="tab-fecha" data-bs-toggle="tab" data-bs-target="#panel-fecha" type="button" role="tab">
                 <i class="bi bi-calendar3"></i> Fallas por Fecha
               </button>
             </li>
             <li class="nav-item" role="presentation">
               <button class="nav-link" id="tab-area" data-bs-toggle="tab" data-bs-target="#panel-area" type="button" role="tab">
                 <i class="bi bi-pie-chart"></i> Fallas por Área
               </button>
             </li>
             <li class="nav-item" role="presentation">
               <button class="nav-link" id="tab-campania" data-bs-toggle="tab" data-bs-target="#panel-campania" type="button" role="tab">
                 <i class="bi bi-graph-up"></i> Fallas por Tipo de Campaña
               </button>
             </li>
             <li class="nav-item" role="presentation">
               <button class="nav-link" id="tab-empleado" data-bs-toggle="tab" data-bs-target="#panel-empleado" type="button" role="tab">
                 <i class="bi bi-people-fill"></i> Fallas por Empleado
               </button>
             </li>
             <li class="nav-item" role="presentation">
               <button class="nav-link" id="tab-kpis" data-bs-toggle="tab" data-bs-target="#panel-kpis" type="button" role="tab">
                 <i class="bi bi-speedometer2"></i> KPIs
               </button>
             </li>
           </ul>
        </div>

        <div class="tab-content">
          <div class="tab-pane fade show active" id="panel-fecha" role="tabpanel" aria-labelledby="tab-fecha">
            <div class="row g-4">
              <div class="col-lg-9">
                <div class="card p-3 bg-dark text-white">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Fallas por Fecha</h5>
                    <div class="filters-container">
                      <div class="filter-group">
                        <span class="filter-label">
                          <i class="bi bi-calendar3 filter-icon"></i>
                          Período
                        </span>
                        <div style="position: relative; width: 220px;">
                          <select id="filtroPeriodo" class="form-select form-select-sm" style="width: 100%;" multiple>
                          </select>
                          <div class="filter-placeholder" id="filtroPeriodoPlaceholder">Seleccionar períodos...</div>
                          <i class="bi bi-chevron-down filter-dropdown-icon"></i>
                        </div>
                      </div>
                      <div class="filter-group">
                        <span class="filter-label">
                          <i class="bi bi-funnel filter-icon"></i>
                          Tipo
                        </span>
                        <div style="position: relative; width: 180px;">
                          <select id="filtroTipoFecha" class="form-select form-select-sm" style="width: 100%;" multiple>
                            <option value="CORREO">📧 Correo</option>
                            <option value="MENSAJE">💬 Mensaje</option>
                            <option value="LLAMADA">📞 Llamada</option>
                            <option value="VIDEOLLAMADA">📹 Videollamada</option>
                          </select>
                          <div class="filter-placeholder" id="filtroTipoFechaPlaceholder">Seleccionar tipos...</div>
                          <i class="bi bi-chevron-down filter-dropdown-icon"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div id="chartFallasPorFecha"></div>
                </div>
              </div>
              <div class="col-lg-3">
                <div class="card p-3 h-100 d-flex align-items-center justify-content-center bg-dark text-white">
                  <div class="text-center">
                    <div class="mb-2"><i class="bi bi-calendar3" style="font-size: 2rem;"></i></div>
                    <h5 class="mb-1">Total de Fallas</h5>
                    <div id="totalFallasFecha" class="display-5">0</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="tab-pane fade" id="panel-area" role="tabpanel" aria-labelledby="tab-area">
            <div class="row g-4">
              <div class="col-lg-9">
                <div class="card p-3 bg-dark text-white">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Fallas por Área</h5>
                    <div class="filters-container">
                      <div class="filter-group">
                        <span class="filter-label">
                          <i class="bi bi-funnel filter-icon"></i>
                          Tipo
                        </span>
                        <div style="position: relative; width: 220px;">
                          <select id="filtroTipo" class="form-select form-select-sm" style="width: 100%;" multiple>
                            <option value="CORREO">📧 Correo</option>
                            <option value="MENSAJE">💬 Mensaje</option>
                            <option value="LLAMADA">📞 Llamada</option>
                            <option value="VIDEOLLAMADA">📹 Videollamada</option>
                          </select>
                          <div class="filter-placeholder" id="filtroTipoPlaceholder">Seleccionar tipos...</div>
                          <i class="bi bi-chevron-down filter-dropdown-icon"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div id="chartFallasPorArea"></div>
                </div>
              </div>
              <div class="col-lg-3">
                <div class="card p-3 h-100 d-flex align-items-center justify-content-center bg-dark text-white">
                  <div class="text-center">
                    <div class="mb-2"><i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i></div>
                    <h5 class="mb-1">Total de Fallas</h5>
                    <div id="totalFallas" class="display-5">0</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="tab-pane fade" id="panel-campania" role="tabpanel" aria-labelledby="tab-campania">
            <div class="row g-4">
              <div class="col-lg-9">
                <div class="card p-3 bg-dark text-white">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Fallas por Tipo de Campaña</h5>
                    <div class="filters-container">
                      <div class="filter-group">
                        <span class="filter-label">
                          <i class="bi bi-geo-alt filter-icon"></i>
                          Área
                        </span>
                        <div style="position: relative; width: 220px;">
                          <select id="filtroAreaCampania" class="form-select form-select-sm" style="width: 100%;" multiple>
                          </select>
                          <div class="filter-placeholder" id="filtroAreaCampaniaPlaceholder">Seleccionar áreas...</div>
                          <i class="bi bi-chevron-down filter-dropdown-icon"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div id="chartFallasPorCampania"></div>
                </div>
              </div>
              <div class="col-lg-3">
                <div class="card p-3 h-100 d-flex align-items-center justify-content-center bg-dark text-white">
                  <div class="text-center">
                    <div class="mb-2"><i class="bi bi-graph-up" style="font-size: 2rem;"></i></div>
                    <h5 class="mb-1">Total de Fallas</h5>
                    <div id="totalFallasCampania" class="display-5">0</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="tab-pane fade" id="panel-empleado" role="tabpanel" aria-labelledby="tab-empleado">
            <div class="row g-4">
              <div class="col-12">
                <div class="card p-3 bg-dark text-white">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Fallas por Empleado</h5>
                    <div class="filters-container">
                      <div class="filter-group">
                        <span class="filter-label">
                          <i class="bi bi-funnel filter-icon"></i>
                          Tipo
                        </span>
                        <div style="position: relative; width: 220px;">
                          <select id="filtroTipoEmpleado" class="form-select form-select-sm" style="width: 100%;" multiple>
                            <option value="CORREO">📧 Correo</option>
                            <option value="MENSAJE">💬 Mensaje</option>
                            <option value="LLAMADA">📞 Llamada</option>
                            <option value="VIDEOLLAMADA">📹 Videollamada</option>
                          </select>
                          <div class="filter-placeholder" id="filtroTipoEmpleadoPlaceholder">Seleccionar tipos...</div>
                          <i class="bi bi-chevron-down filter-dropdown-icon"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div id="contenidoEmpleados"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="tab-pane fade" id="panel-kpis" role="tabpanel" aria-labelledby="tab-kpis">
            <div class="row g-4">
              <div class="col-12">
                <div class="card p-4 bg-dark text-white">
                  <div class="text-center">
                    <div class="mb-4">
                      <i class="bi bi-speedometer2" style="font-size: 4rem; color: #da02e5;"></i>
                    </div>
                    <h3 class="mb-3">KPIs en Construcción</h3>
                    <p class="mb-4 text-muted fs-5">
                      Estamos trabajando en una sección completa de KPIs que incluirá:
                    </p>
                    <div class="row g-3">
                      <div class="col-md-6 col-lg-3">
                        <div class="card bg-secondary p-3 h-100">
                          <div class="text-center">
                            <i class="bi bi-people-fill mb-2" style="font-size: 2rem; color: #00d4aa;"></i>
                            <h6>Efectividad por Usuario</h6>
                            <small class="text-muted">Métricas individuales de rendimiento</small>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6 col-lg-3">
                        <div class="card bg-secondary p-3 h-100">
                          <div class="text-center">
                            <i class="bi bi-clock-history mb-2" style="font-size: 2rem; color: #ff6b6b;"></i>
                            <h6>Tiempo de Respuesta</h6>
                            <small class="text-muted">Análisis de tiempos de reacción</small>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6 col-lg-3">
                        <div class="card bg-secondary p-3 h-100">
                          <div class="text-center">
                            <i class="bi bi-trophy-fill mb-2" style="font-size: 2rem; color: #feca57;"></i>
                            <h6>Rankings y Comparativas</h6>
                            <small class="text-muted">Comparaciones entre áreas y usuarios</small>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6 col-lg-3">
                        <div class="card bg-secondary p-3 h-100">
                          <div class="text-center">
                            <i class="bi bi-graph-up-arrow mb-2" style="font-size: 2rem; color: #4ecdc4;"></i>
                            <h6>Tendencias y Proyecciones</h6>
                            <small class="text-muted">Análisis predictivo y tendencias</small>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="mt-4">
                      <p class="text-muted">
                        <i class="bi bi-info-circle me-2"></i>
                        Esta funcionalidad estará disponible próximamente
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/aos/aos.js"></script>
  <script> AOS.init(); </script>
  <!-- ApexCharts -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <script>
    let chartInstance = null;

    async function cargarFallasPorArea(tiposEvento = []) {
      try {
        let url = '/api/areas/fallas';
        if (tiposEvento.length > 0) {
          const params = new URLSearchParams();
          tiposEvento.forEach(tipo => params.append('tipo_evento', tipo));
          url += `?${params.toString()}`;
        }
        
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('Error al obtener datos');
        const data = await resp.json();

        const areas = (data.areas || []).sort((a,b) => a.idArea - b.idArea);
        const labels = areas.map(a => a.nombreArea);
        const valores = areas.map(a => a.totalFallas);
        const total = valores.reduce((acc, v) => acc + v, 0);
        
        // Calcular porcentajes y crear datos en formato correcto
        const datosTorta = areas.map((area, index) => {
          const porcentaje = total > 0 ? parseFloat(((area.totalFallas / total) * 100).toFixed(1)) : 0;
          return {
            name: area.nombreArea,
            value: porcentaje,
            cantidad: area.totalFallas
          };
        });
        
        document.getElementById('totalFallas').textContent = total;

        const opciones = {
          chart: { 
            type: 'pie', 
            height: 420, 
            toolbar: { show: false }, 
            foreColor: '#f1f1f1' 
          },
          theme: { mode: 'dark' },
          plotOptions: { 
            pie: { 
              expandOnClick: true,
              donut: {
                size: '60%',
                labels: {
                  show: true,
                  name: {
                    show: true,
                    fontSize: '16px',
                    fontWeight: 600,
                    color: '#f1f1f1'
                  },
                  value: {
                    show: true,
                    fontSize: '14px',
                    fontWeight: 400,
                    color: '#f1f1f1',
                    formatter: function (val) {
                      return val + '%'
                    }
                  },
                  total: {
                    show: false
                  }
                }
              }
            } 
          },
          dataLabels: { 
            enabled: true, 
            style: { 
              colors: ['#ffffff'],
              fontSize: '12px',
              fontWeight: 600
            }, 
            formatter: (val, opts) => {
              const dataPoint = datosTorta[opts.seriesIndex];
              return `${dataPoint.name}\n${val}% (${dataPoint.cantidad})`;
            }
          },
          series: datosTorta.map(item => item.value),
          labels: datosTorta.map(item => item.name),
          colors: ['#da02e5', '#00d4aa', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff', '#5f27cd'],
          tooltip: { 
            theme: 'dark',
            style: {
              fontSize: '14px',
              fontFamily: 'Arial, sans-serif'
            },
            fillSeriesColor: false,
            marker: {
              show: true
            },
            y: { 
              formatter: (val, { seriesIndex, dataPointIndex }) => {
                const dataPoint = datosTorta[dataPointIndex];
                return `${dataPoint.name}: ${val}% (${dataPoint.cantidad} fallas)`;
              }
            } 
          },
          legend: {
            position: 'bottom',
            horizontalAlign: 'center',
            fontSize: '14px',
            fontFamily: 'Helvetica, Arial',
            fontWeight: 400,
            labels: {
              colors: '#f1f1f1'
            },
            markers: {
              width: 12,
              height: 12,
              strokeWidth: 0,
              radius: 2
            }
          }
        };

        // Destruir gráfico anterior si existe
        if (chartInstance) {
          chartInstance.destroy();
        }
        
        chartInstance = new ApexCharts(document.querySelector('#chartFallasPorArea'), opciones);
        chartInstance.render();
      } catch (e) {
        console.error(e);
      }
    }

    // Función para actualizar placeholder
    function actualizarPlaceholder(selectId, placeholderId) {
      const select = document.getElementById(selectId);
      const placeholder = document.getElementById(placeholderId);
      const seleccionados = Array.from(select.selectedOptions);
      
      // Solo mostrar placeholder si el select no tiene foco
      if (document.activeElement !== select) {
        placeholder.style.display = 'block';
        
        if (seleccionados.length === 0) {
          placeholder.textContent = placeholderId.includes('Periodo') ? 'Seleccionar períodos...' : 'Seleccionar tipos...';
          placeholder.style.opacity = '1';
          placeholder.classList.remove('has-selection');
        } else if (seleccionados.length === 1) {
          placeholder.textContent = seleccionados[0].textContent;
          placeholder.style.opacity = '0.9';
          placeholder.classList.add('has-selection');
        } else {
          placeholder.textContent = `${seleccionados.length} seleccionados`;
          placeholder.style.opacity = '0.9';
          placeholder.classList.add('has-selection');
        }
      } else {
        // Si el select tiene foco, ocultar placeholder
        placeholder.style.display = 'none';
      }
    }

    // Event listener para el filtro
    document.getElementById('filtroTipo').addEventListener('change', function() {
      const tiposSeleccionados = Array.from(this.selectedOptions).map(option => option.value);
      actualizarPlaceholder('filtroTipo', 'filtroTipoPlaceholder');
      cargarFallasPorArea(tiposSeleccionados);
    });

    // Event listeners para ocultar/mostrar placeholder
    document.getElementById('filtroTipo').addEventListener('focus', function() {
      document.getElementById('filtroTipoPlaceholder').style.display = 'none';
    });

    document.getElementById('filtroTipo').addEventListener('blur', function() {
      setTimeout(() => {
        actualizarPlaceholder('filtroTipo', 'filtroTipoPlaceholder');
      }, 100);
    });

    // Event listener para manejar clics en opciones (deselección sin Ctrl)
    document.getElementById('filtroTipo').addEventListener('mousedown', function(e) {
      // Ocultar placeholder inmediatamente
      document.getElementById('filtroTipoPlaceholder').style.display = 'none';
      
      // Solo permitir deselección sin Ctrl si la opción ya está seleccionada
      if (e.target.tagName === 'OPTION' && e.target.selected) {
        e.preventDefault();
        e.target.selected = false;
        
        // Actualizar placeholder después de un pequeño delay
        setTimeout(() => {
          actualizarPlaceholder('filtroTipo', 'filtroTipoPlaceholder');
        }, 50);
        
        // Disparar evento change manualmente
        this.dispatchEvent(new Event('change'));
      }
    });

     // Variables para el gráfico de fecha
     let chartFechaInstance = null;
     
     // Variables para el gráfico de campaña
     let chartCampaniaInstance = null;

    // Función para cargar fallas por fecha
    async function cargarFallasPorFecha(periodos = [], tiposEvento = []) {
      try {
        const params = new URLSearchParams();
        periodos.forEach(periodo => params.append('periodo', periodo));
        tiposEvento.forEach(tipo => params.append('tipo_evento', tipo));
        
        const url = `/api/areas/fallas-fecha?${params.toString()}`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('Error al obtener datos');
        const data = await resp.json();

        const periodosData = data.periodos || [];
        const fallas = data.fallas || [];
        const total = data.totalFallas || 0;
        
        // Actualizar total
        document.getElementById('totalFallasFecha').textContent = total;

        // Formatear etiquetas (siempre por mes)
        const etiquetas = periodosData.map(periodo => {
          const [año, mes] = periodo.split('-');
          const nombresMeses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun',
                               'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
          return `${nombresMeses[parseInt(mes) - 1]} ${año}`;
        });

        // Configurar gráfico de barras
        const opciones = {
          chart: { 
            type: 'bar', 
            height: 420, 
            toolbar: { show: false }, 
            foreColor: '#f1f1f1' 
          },
          theme: { mode: 'dark' },
          grid: { borderColor: '#444' },
          plotOptions: { 
            bar: { 
              horizontal: false, 
              columnWidth: '60%', 
              borderRadius: 6 
            } 
          },
          dataLabels: { 
            enabled: true, 
            style: { colors: ['#ffffff'] },
            formatter: (val) => `${val}`
          },
          xaxis: { 
            categories: etiquetas, 
            labels: { 
              style: { colors: '#ffffff' },
              rotate: -45
            }
          },
          yaxis: { 
            title: { 
              text: 'Cantidad de fallas', 
              style: { color: '#ffffff', fontSize: '16px' } 
            }, 
            labels: { style: { colors: '#ffffff' } },
            min: 0
          },
           series: [{ name: 'Fallas', data: fallas }],
           colors: ['#da02e5'],
          tooltip: { 
            theme: 'dark', 
            y: { 
              formatter: (val) => `${val} fallas`
            } 
          }
        };

        // Destruir gráfico anterior si existe
        if (chartFechaInstance) {
          chartFechaInstance.destroy();
        }
        
        chartFechaInstance = new ApexCharts(document.querySelector('#chartFallasPorFecha'), opciones);
        chartFechaInstance.render();

        // Actualizar opciones de filtros si es la primera carga
        if (data.filtros) {
          actualizarFiltros(data.filtros);
        }

       } catch (e) {
         console.error('Error cargando fallas por fecha:', e);
       }
     }

     // Función para cargar fallas por tipo de campaña
     async function cargarFallasPorCampania(areas = []) {
       try {
         let url = '/api/areas/fallas-campania';
         if (areas.length > 0) {
           const params = new URLSearchParams();
           areas.forEach(area => params.append('area', area));
           url += `?${params.toString()}`;
         }
         
         const resp = await fetch(url);
         if (!resp.ok) throw new Error('Error al obtener datos');
         const data = await resp.json();

         const campanias = data.campanias || [];
         const total = campanias.reduce((acc, campania) => acc + campania.totalFallas, 0);
         
         document.getElementById('totalFallasCampania').textContent = total;

         // Crear datos para el gráfico de torta
         const labels = campanias.map(campania => {
           const nombres = {
             'CORREO': '📧 Correo',
             'MENSAJE': '💬 Mensaje', 
             'LLAMADA': '📞 Llamada',
             'VIDEOLLAMADA': '📹 Videollamada'
           };
           return nombres[campania.tipo] || campania.tipo;
         });
         
         const valores = campanias.map(campania => campania.totalFallas);

         const opciones = {
           chart: { 
             type: 'bar', 
             height: 420, 
             toolbar: { show: false }, 
             foreColor: '#f1f1f1' 
           },
           theme: { mode: 'dark' },
           grid: { borderColor: '#444' },
           plotOptions: { 
             bar: { 
               horizontal: false, 
               columnWidth: '60%', 
               borderRadius: 6 
             } 
           },
           dataLabels: { 
             enabled: true, 
             style: { colors: ['#ffffff'] },
             formatter: (val) => `${val}`
           },
           xaxis: { 
             categories: labels, 
             labels: { 
               style: { colors: '#ffffff' },
               rotate: -45
             }
           },
           yaxis: { 
             title: { 
               text: 'Cantidad de fallas', 
               style: { color: '#ffffff', fontSize: '16px' } 
             }, 
             labels: { style: { colors: '#ffffff' } },
             min: 0
           },
           series: [{ name: 'Fallas', data: valores }],
           colors: ['#da02e5'],
           tooltip: { 
             theme: 'dark', 
             y: { 
               formatter: (val) => `${val} fallas`
             } 
           }
         };

         // Destruir gráfico anterior si existe
         if (chartCampaniaInstance) {
           chartCampaniaInstance.destroy();
         }
         
         chartCampaniaInstance = new ApexCharts(document.querySelector('#chartFallasPorCampania'), opciones);
         chartCampaniaInstance.render();

         // Actualizar opciones de filtros de área si es la primera carga
         if (campanias.length > 0 && document.getElementById('filtroAreaCampania').children.length === 0) {
           // Obtener todas las áreas únicas de las campañas
           const todasLasAreas = new Set();
           campanias.forEach(campania => {
             campania.areas.forEach(area => {
               todasLasAreas.add(JSON.stringify({idArea: area.idArea, nombreArea: area.nombreArea}));
             });
           });
           const areasUnicas = Array.from(todasLasAreas).map(areaStr => JSON.parse(areaStr));
           actualizarFiltrosArea(areasUnicas);
         }

       } catch (e) {
         console.error('Error cargando fallas por campaña:', e);
       }
     }

     // Función para actualizar las opciones de filtros de área
     function actualizarFiltrosArea(areas) {
       const selectArea = document.getElementById('filtroAreaCampania');
       
       // Limpiar opciones existentes
       selectArea.innerHTML = '';
       
       // Agregar áreas
       areas.forEach(area => {
         const option = document.createElement('option');
         option.value = area.idArea.toString();
         option.textContent = `🏢 ${area.nombreArea}`;
         option.style.fontSize = '0.9rem';
         selectArea.appendChild(option);
       });
     }

    // Función para actualizar las opciones de filtros jerárquicos
    function actualizarFiltros(filtros) {
      const selectPeriodo = document.getElementById('filtroPeriodo');
      
      // Limpiar opciones existentes
      selectPeriodo.innerHTML = '';
      
      const nombresMeses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                           'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      
      // Agregar años
      if (filtros.años) {
        filtros.años.forEach(año => {
          const option = document.createElement('option');
          option.value = año.toString();
          option.textContent = `📅 ${año}`;
          option.style.fontWeight = 'bold';
          option.style.fontSize = '0.95rem';
          selectPeriodo.appendChild(option);
        });
      }
      
       // Agregar trimestres
       if (filtros.trimestres) {
         filtros.trimestres.forEach(trimestre => {
           const option = document.createElement('option');
           option.value = trimestre;
           option.textContent = `📊 ${trimestre}`;
           option.style.color = '#da02e5';
           option.style.fontWeight = '600';
           option.style.fontSize = '0.9rem';
           option.style.paddingLeft = '20px';
           selectPeriodo.appendChild(option);
         });
       }
      
      // Agregar meses
      if (filtros.meses) {
        filtros.meses.forEach(mesPeriodo => {
          const [mes, año] = mesPeriodo.split('-');
          const option = document.createElement('option');
          option.value = mesPeriodo;
          option.textContent = `📅 ${nombresMeses[parseInt(mes) - 1]} ${año}`;
          option.style.paddingLeft = '40px';
          option.style.fontSize = '0.85rem';
          option.style.opacity = '0.9';
          selectPeriodo.appendChild(option);
        });
      }
    }

    // Event listeners para filtros de fecha
    document.getElementById('filtroPeriodo').addEventListener('change', function() {
      const periodos = Array.from(this.selectedOptions).map(option => option.value);
      const tipos = Array.from(document.getElementById('filtroTipoFecha').selectedOptions).map(option => option.value);
      actualizarPlaceholder('filtroPeriodo', 'filtroPeriodoPlaceholder');
      cargarFallasPorFecha(periodos, tipos);
    });

    document.getElementById('filtroTipoFecha').addEventListener('change', function() {
      const periodos = Array.from(document.getElementById('filtroPeriodo').selectedOptions).map(option => option.value);
      const tipos = Array.from(this.selectedOptions).map(option => option.value);
      actualizarPlaceholder('filtroTipoFecha', 'filtroTipoFechaPlaceholder');
      cargarFallasPorFecha(periodos, tipos);
    });

    // Event listeners para ocultar/mostrar placeholder - Filtro Período
    document.getElementById('filtroPeriodo').addEventListener('focus', function() {
      document.getElementById('filtroPeriodoPlaceholder').style.display = 'none';
    });

    document.getElementById('filtroPeriodo').addEventListener('blur', function() {
      setTimeout(() => {
        actualizarPlaceholder('filtroPeriodo', 'filtroPeriodoPlaceholder');
      }, 100);
    });

    // Event listener para manejar clics en opciones (deselección sin Ctrl) - Período
    document.getElementById('filtroPeriodo').addEventListener('mousedown', function(e) {
      // Ocultar placeholder inmediatamente
      document.getElementById('filtroPeriodoPlaceholder').style.display = 'none';
      
      // Solo permitir deselección sin Ctrl si la opción ya está seleccionada
      if (e.target.tagName === 'OPTION' && e.target.selected) {
        e.preventDefault();
        e.target.selected = false;
        
        // Actualizar placeholder después de un pequeño delay
        setTimeout(() => {
          actualizarPlaceholder('filtroPeriodo', 'filtroPeriodoPlaceholder');
        }, 50);
        
        // Disparar evento change manualmente
        this.dispatchEvent(new Event('change'));
      }
    });

    // Event listeners para ocultar/mostrar placeholder - Filtro Tipo Fecha
    document.getElementById('filtroTipoFecha').addEventListener('focus', function() {
      document.getElementById('filtroTipoFechaPlaceholder').style.display = 'none';
    });

    document.getElementById('filtroTipoFecha').addEventListener('blur', function() {
      setTimeout(() => {
        actualizarPlaceholder('filtroTipoFecha', 'filtroTipoFechaPlaceholder');
      }, 100);
    });

    // Event listener para manejar clics en opciones (deselección sin Ctrl) - Tipo Fecha
    document.getElementById('filtroTipoFecha').addEventListener('mousedown', function(e) {
      // Ocultar placeholder inmediatamente
      document.getElementById('filtroTipoFechaPlaceholder').style.display = 'none';
      
      // Solo permitir deselección sin Ctrl si la opción ya está seleccionada
      if (e.target.tagName === 'OPTION' && e.target.selected) {
        e.preventDefault();
        e.target.selected = false;
        
        // Actualizar placeholder después de un pequeño delay
        setTimeout(() => {
          actualizarPlaceholder('filtroTipoFecha', 'filtroTipoFechaPlaceholder');
        }, 50);
        
        // Disparar evento change manualmente
        this.dispatchEvent(new Event('change'));
      }
    });

     // Event listeners para filtros de campaña
     document.getElementById('filtroAreaCampania').addEventListener('change', function() {
       const areas = Array.from(this.selectedOptions).map(option => option.value);
       actualizarPlaceholder('filtroAreaCampania', 'filtroAreaCampaniaPlaceholder');
       cargarFallasPorCampania(areas);
     });

     // Event listeners para ocultar/mostrar placeholder - Filtro Área Campaña
     document.getElementById('filtroAreaCampania').addEventListener('focus', function() {
       document.getElementById('filtroAreaCampaniaPlaceholder').style.display = 'none';
     });

     document.getElementById('filtroAreaCampania').addEventListener('blur', function() {
       setTimeout(() => {
         actualizarPlaceholder('filtroAreaCampania', 'filtroAreaCampaniaPlaceholder');
       }, 100);
     });

     // Event listener para manejar clics en opciones (deselección sin Ctrl) - Área Campaña
     document.getElementById('filtroAreaCampania').addEventListener('mousedown', function(e) {
       // Ocultar placeholder inmediatamente
       document.getElementById('filtroAreaCampaniaPlaceholder').style.display = 'none';
       
       // Solo permitir deselección sin Ctrl si la opción ya está seleccionada
       if (e.target.tagName === 'OPTION' && e.target.selected) {
         e.preventDefault();
         e.target.selected = false;
         
         // Actualizar placeholder después de un pequeño delay
         setTimeout(() => {
           actualizarPlaceholder('filtroAreaCampania', 'filtroAreaCampaniaPlaceholder');
         }, 50);
         
         // Disparar evento change manualmente
         this.dispatchEvent(new Event('change'));
       }
     });

     // Función para cargar fallas por empleado
     async function cargarFallasPorEmpleado(tiposEvento = []) {
       try {
         let url = '/api/areas/fallas-empleados';
         if (tiposEvento.length > 0) {
           const params = new URLSearchParams();
           tiposEvento.forEach(tipo => params.append('tipo_evento', tipo));
           url += `?${params.toString()}`;
         }
         
         const resp = await fetch(url);
         if (!resp.ok) throw new Error('Error al obtener datos');
         const data = await resp.json();

         const areas = data.areas || [];
         const contenido = document.getElementById('contenidoEmpleados');
         
         if (areas.length === 0) {
           contenido.innerHTML = `
             <div class="text-center py-5">
               <i class="bi bi-info-circle" style="font-size: 3rem; color: #da02e5;"></i>
               <h5 class="mt-3 text-muted">No hay datos disponibles</h5>
               <p class="text-muted">No se encontraron empleados con fallas en las áreas seleccionadas.</p>
             </div>
           `;
           return;
         }

         let html = '';
         
         areas.forEach((area, index) => {
           if (area.totalEmpleados > 0) {
             const areaId = `area-${index}`;
             html += `
               <div class="card mb-3 bg-dark border-0" style="box-shadow: 0 4px 15px rgba(218, 2, 229, 0.2);">
                 <div class="card-header bg-gradient" style="background: linear-gradient(135deg, #da02e5, #e533f0); border: none; cursor: pointer;" 
                      data-bs-toggle="collapse" data-bs-target="#${areaId}" aria-expanded="false" aria-controls="${areaId}">
                   <div class="d-flex justify-content-between align-items-center">
                     <h6 class="mb-0 text-white">
                       <i class="bi bi-building me-2"></i>
                       ${area.nombreArea}
                       <i class="bi bi-chevron-down ms-2" id="icon-${areaId}"></i>
                     </h6>
                     <div class="d-flex gap-2">
                       <span class="badge" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">
                         <i class="bi bi-people-fill me-1"></i>
                         ${area.totalEmpleados} empleados
                       </span>
                       <span class="badge" style="background: rgba(255,107,107,0.8); color: white;">
                         <i class="bi bi-exclamation-triangle-fill me-1"></i>
                         ${area.empleadosConFalla} con fallas
                       </span>
                       <span class="badge" style="background: rgba(255,193,7,0.8); color: #000;">
                         <i class="bi bi-bug-fill me-1"></i>
                         ${area.totalFallas} fallas
                       </span>
                     </div>
                   </div>
                 </div>
                 <div class="collapse" id="${areaId}">
                   <div class="card-body p-3">
                     <div class="row g-3">
             `;
             
             area.empleados.forEach(empleado => {
               const badgeClass = empleado.tieneFallas ? 'bg-danger' : 'bg-success';
               const badgeText = empleado.tieneFallas ? `${empleado.cantidadFallas} fallas` : 'Sin fallas';
               const iconClass = empleado.tieneFallas ? 'bi-exclamation-triangle-fill' : 'bi-check-circle-fill';
               const cardStyle = empleado.tieneFallas ? 
                 'border-left: 4px solid #ff6b6b; box-shadow: 0 2px 8px rgba(255,107,107,0.3);' : 
                 'border-left: 4px solid #00d4aa; box-shadow: 0 2px 8px rgba(0,212,170,0.3);';
               
               html += `
                 <div class="col-lg-3 col-md-6 col-sm-12">
                   <div class="card bg-dark border-0" style="${cardStyle}">
                     <div class="card-body p-3">
                       <div class="d-flex justify-content-between align-items-start mb-2">
                         <h6 class="mb-0 text-white" style="font-size: 0.9rem;">
                           <i class="bi bi-person-fill me-2" style="color: #da02e5;"></i>
                           ${empleado.nombre} ${empleado.apellido}
                         </h6>
                         <span class="badge ${badgeClass}" style="font-size: 0.75rem;">
                           <i class="bi ${iconClass} me-1"></i>
                           ${badgeText}
                         </span>
                       </div>
                       <div class="text-white small">
                         <i class="bi bi-person-badge me-1" style="color: #da02e5;"></i>
                         ID: ${empleado.idUsuario}
                       </div>
                     </div>
                   </div>
                 </div>
               `;
             });
             
             html += `
                     </div>
                   </div>
                 </div>
               </div>
             `;
           }
         });
         
         contenido.innerHTML = html;
         
         // Agregar event listeners para los iconos de colapso
         areas.forEach((area, index) => {
           const areaId = `area-${index}`;
           const iconId = `icon-${areaId}`;
           const collapseElement = document.getElementById(areaId);
           const iconElement = document.getElementById(iconId);
           
           if (collapseElement && iconElement) {
             collapseElement.addEventListener('show.bs.collapse', function () {
               iconElement.style.transform = 'rotate(180deg)';
             });
             
             collapseElement.addEventListener('hide.bs.collapse', function () {
               iconElement.style.transform = 'rotate(0deg)';
             });
           }
         });
         
       } catch (e) {
         console.error('Error cargando fallas por empleado:', e);
         document.getElementById('contenidoEmpleados').innerHTML = `
           <div class="text-center py-5">
             <i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: #da02e5;"></i>
             <h5 class="mt-3 text-danger">Error al cargar datos</h5>
             <p class="text-muted">No se pudieron cargar los datos de empleados. Intente nuevamente.</p>
           </div>
         `;
       }
     }

     // Event listeners para filtros de empleado
     document.getElementById('filtroTipoEmpleado').addEventListener('change', function() {
       const tiposSeleccionados = Array.from(this.selectedOptions).map(option => option.value);
       actualizarPlaceholder('filtroTipoEmpleado', 'filtroTipoEmpleadoPlaceholder');
       cargarFallasPorEmpleado(tiposSeleccionados);
     });

     // Event listeners para ocultar/mostrar placeholder - Filtro Tipo Empleado
     document.getElementById('filtroTipoEmpleado').addEventListener('focus', function() {
       document.getElementById('filtroTipoEmpleadoPlaceholder').style.display = 'none';
     });

     document.getElementById('filtroTipoEmpleado').addEventListener('blur', function() {
       setTimeout(() => {
         actualizarPlaceholder('filtroTipoEmpleado', 'filtroTipoEmpleadoPlaceholder');
       }, 100);
     });

     // Event listener para manejar clics en opciones (deselección sin Ctrl) - Tipo Empleado
     document.getElementById('filtroTipoEmpleado').addEventListener('mousedown', function(e) {
       // Ocultar placeholder inmediatamente
       document.getElementById('filtroTipoEmpleadoPlaceholder').style.display = 'none';
       
       // Solo permitir deselección sin Ctrl si la opción ya está seleccionada
       if (e.target.tagName === 'OPTION' && e.target.selected) {
         e.preventDefault();
         e.target.selected = false;
         
         // Actualizar placeholder después de un pequeño delay
         setTimeout(() => {
           actualizarPlaceholder('filtroTipoEmpleado', 'filtroTipoEmpleadoPlaceholder');
         }, 50);
         
         // Disparar evento change manualmente
         this.dispatchEvent(new Event('change'));
       }
     });

     // Cargar datos iniciales
     document.addEventListener('DOMContentLoaded', () => {
       cargarFallasPorFecha(); // Cargar primero el reporte por fecha
       cargarFallasPorArea(); // Cargar también el reporte por área
       cargarFallasPorCampania(); // Cargar también el reporte por campaña
       cargarFallasPorEmpleado(); // Cargar también el reporte por empleado
     });
  </script>

</body>
</html>