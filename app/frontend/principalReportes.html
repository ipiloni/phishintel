<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Reportes - PhishIntel</title>

    <link href="assets/img/favicon.png" rel="icon">
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/vendor/aos/aos.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Raleway&display=swap" rel="stylesheet">
    <link href="assets/css/main.css" rel="stylesheet">
    <style>
      .card.bg-dark .card-header { background-color: #1f1f1f; border-bottom: 1px solid #3a3a3a; }
      .card.bg-dark .card-body { background-color: #1b1b1b; }
      .card.bg-dark, .card.bg-dark .card-body, .card.bg-dark .card-header { color: #f1f1f1; }
      .nav-tabs { border-bottom: 1px solid #3a3a3a; }
      .nav-tabs .nav-link { color: #dddddd; }
      .nav-tabs .nav-link:hover { color: #ffffff; }
      
      /* Estilos para select múltiple mejorados - Oculto por defecto */
      select[multiple] {
        min-height: 40px;
        max-height: 40px;
        background: linear-gradient(145deg, #2a2a2a, #1e1e1e);
        border: 2px solid #444;
        border-radius: 12px;
        color: #f1f1f1;
        font-size: 0.9rem;
        padding: 8px 12px;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
        overflow: hidden;
        position: relative;
      }
      
       select[multiple]:focus {
         border-color: #da02e5;
         box-shadow: 0 0 0 3px rgba(218, 2, 229, 0.2);
         outline: none;
         max-height: 200px;
         overflow-y: auto;
       }
       
       select[multiple]:hover {
         border-color: #da02e5;
         cursor: pointer;
       }
      
      select[multiple] option {
        padding: 8px 12px;
        margin: 2px 0;
        border-radius: 6px;
        background: transparent;
        color: #f1f1f1;
        transition: all 0.2s ease;
        display: none;
      }
      
      select[multiple]:focus option {
        display: block;
      }
      
      /* Asegurar que el placeholder se oculte cuando hay opciones visibles */
      select[multiple]:focus .filter-placeholder {
        display: none !important;
      }
      
       select[multiple] option:hover {
         background: rgba(218, 2, 229, 0.1);
       }
       
       select[multiple] option:checked {
         background: linear-gradient(135deg, #da02e5, #e533f0);
         color: white;
         font-weight: 600;
         box-shadow: 0 2px 4px rgba(218, 2, 229, 0.3);
       }
      
      /* Placeholder text para mostrar selecciones */
      .filter-placeholder {
        position: absolute;
        top: 50%;
        left: 12px;
        transform: translateY(-50%);
        color: #888;
        pointer-events: none;
        font-size: 0.9rem;
        transition: all 0.3s ease;
      }
      
      select[multiple]:focus .filter-placeholder {
        opacity: 0;
        visibility: hidden;
      }
      
       /* Indicador de dropdown */
       .filter-dropdown-icon {
         position: absolute;
         top: 50%;
         right: 12px;
         transform: translateY(-50%);
         color: #da02e5;
         pointer-events: none;
         transition: transform 0.3s ease;
       }
      
      select[multiple]:focus .filter-dropdown-icon {
        transform: translateY(-50%) rotate(180deg);
      }
      
      /* Ocultar opciones cuando se pierde el foco */
      select[multiple]:not(:focus) {
        max-height: 40px;
        overflow: hidden;
      }
      
      select[multiple]:not(:focus) option {
        display: none;
      }
      
      /* Mejorar la apariencia del placeholder cuando hay selecciones */
      .filter-placeholder.has-selection {
        color: #f1f1f1;
        font-weight: 500;
      }
      
      /* Mejorar la apariencia de los filtros */
      .form-select-sm[multiple] {
        font-size: 0.9rem;
      }
      
       /* Estilos para los labels de filtros */
       .filter-label {
         background: linear-gradient(135deg, #da02e5, #e533f0);
         color: white;
         padding: 6px 12px;
         border-radius: 20px;
         font-size: 0.85rem;
         font-weight: 600;
         text-transform: uppercase;
         letter-spacing: 0.5px;
         box-shadow: 0 2px 8px rgba(218, 2, 229, 0.3);
         border: none;
         min-width: 80px;
         text-align: center;
       }
      
      /* Contenedor de filtros mejorado */
      .filters-container {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        padding: 15px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }
      
      /* Espaciado mejorado entre filtros */
      .filter-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }
      
      .filter-group:last-child {
        margin-bottom: 0;
      }
      
      /* Iconos para los filtros */
      .filter-icon {
        font-size: 1.1rem;
        margin-right: 6px;
      }
      
      /* Responsive para filtros */
      @media (max-width: 768px) {
        .filters-container {
          flex-direction: column;
          gap: 10px;
        }
        
        .filter-group {
          flex-direction: column;
          align-items: stretch;
          gap: 8px;
        }
        
        .filter-label {
          text-align: center;
          min-width: auto;
        }
        
        select[multiple] {
          width: 100% !important;
        }
      }
      
      /* Animación suave para hover */
      .filters-container:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      }
      
      /* Mejorar el scroll de los selects */
      select[multiple]::-webkit-scrollbar {
        width: 8px;
      }
      
      select[multiple]::-webkit-scrollbar-track {
        background: #2a2a2a;
        border-radius: 4px;
      }
      
       select[multiple]::-webkit-scrollbar-thumb {
         background: #da02e5;
         border-radius: 4px;
       }
       
       select[multiple]::-webkit-scrollbar-thumb:hover {
         background: #e533f0;
       }
      .nav-tabs .nav-link.active { color: #ffffff; background-color: #1f1f1f; border-color: #3a3a3a #3a3a3a #1f1f1f; }
      
      /* Estilos para las áreas colapsables */
      .card-header[data-bs-toggle="collapse"] {
        transition: all 0.3s ease;
      }
      
      .card-header[data-bs-toggle="collapse"]:hover {
        background: linear-gradient(135deg, #e533f0, #f066ff) !important;
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(218, 2, 229, 0.4);
      }
      
      .bi-chevron-down {
        transition: transform 0.3s ease;
      }
      
      /* Mejorar el estilo de las tarjetas de empleados */
      .card.bg-dark {
        transition: all 0.3s ease;
      }
      
      .card.bg-dark:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(218, 2, 229, 0.3);
      }
      
      /* Estilos para badges mejorados */
      .badge {
        font-weight: 600;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
      }
      
      .badge:hover {
        transform: scale(1.05);
      }
      
      /* Estilos para el indicador de KPI */
      .kpi-indicator {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      
      .kpi-level {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: #333;
        border: 2px solid #555;
        transition: all 0.5s ease;
        position: relative;
      }
      
      .kpi-level.active {
        background-color: #da02e5;
        border-color: #da02e5;
        box-shadow: 0 0 10px rgba(218, 2, 229, 0.5);
        transform: scale(1.1);
      }
      
      .kpi-level.active::after {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        border-radius: 50%;
        border: 2px solid #da02e5;
        animation: pulse 2s infinite;
      }
      
      /* Estilos para nivel crítico (nivel 0) */
      .kpi-level.critical {
        background-color: #dc3545;
        border-color: #dc3545;
        box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
        transform: scale(1.1);
      }
      
      .kpi-level.critical::after {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        border-radius: 50%;
        border: 2px solid #dc3545;
        animation: pulse 2s infinite;
      }
      
      /* Estilos para la barra de progreso crítica */
      .progress-bar.critical {
        background: linear-gradient(90deg, #dc3545, #ff6b7a);
        box-shadow: 0 0 10px rgba(220, 53, 69, 0.3);
      }
      
      /* Estilos para la barra de progreso de tasa de fallas */
      #kpiProgresoFallas {
        background: linear-gradient(90deg, #ff6b6b, #ff8e8e);
        transition: width 2s ease-in-out;
      }
      
      /* Estilos para datos insuficientes */
      .insuficiente-datos {
        opacity: 0.6;
        filter: grayscale(50%);
      }
      
      /* Estilos para el estado del nivel */
      #kpiEstadoNivel {
        transition: all 0.3s ease;
      }
      
      /* Estilos para nivel 1 (Presas del Phishing) */
      #kpiEstadoNivel.nivel1 {
        animation: pulse-nivel1 2s infinite;
      }
      
      #kpiEstadoNivel.nivel1 .badge {
        background-color: #dc3545 !important;
        color: white;
        font-weight: 600;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
        border: 1px solid rgba(220, 53, 69, 0.3);
      }

      /* Estilos para nivel 1 (Presas del Phishing) - KPI de Fallas */
      #kpiEstadoNivelFallas.nivel1 {
        animation: pulse-nivel1 2s infinite;
      }
      
      #kpiEstadoNivelFallas.nivel1 .badge {
        background-color: #dc3545 !important;
        color: white;
        font-weight: 600;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
        border: 1px solid rgba(220, 53, 69, 0.3);
      }
      
      /* Estilos para niveles normales (2-3) */
      #kpiEstadoNivel.normal .badge {
        background-color: #6c757d;
        color: white;
        font-weight: 500;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(108, 117, 125, 0.3);
      }

      /* Estilos para niveles normales (2-3) - KPI de Fallas */
      #kpiEstadoNivelFallas.normal .badge {
        background-color: #6c757d;
        color: white;
        font-weight: 500;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(108, 117, 125, 0.3);
      }
      
      /* Estilos para nivel alto (4-5) */
      #kpiEstadoNivel.alto .badge {
        background-color: #28a745;
        color: white;
        font-weight: 500;
        box-shadow: 0 1px 4px rgba(40, 167, 69, 0.3);
        border: 1px solid rgba(40, 167, 69, 0.3);
      }

      /* Estilos para nivel alto (4-5) - KPI de Fallas */
      #kpiEstadoNivelFallas.alto .badge {
        background-color: #28a745;
        color: white;
        font-weight: 500;
        box-shadow: 0 1px 4px rgba(40, 167, 69, 0.3);
        border: 1px solid rgba(40, 167, 69, 0.3);
      }
      
      @keyframes pulse-nivel1 {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.05);
          opacity: 0.8;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
      
      @keyframes pulse {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        100% {
          transform: scale(1.3);
          opacity: 0;
        }
      }
      
      /* Colores para diferentes niveles */
      .kpi-level[data-level="0"].active { background-color: #dc3545; border-color: #dc3545; }
      .kpi-level[data-level="1"].active { background-color: #fd7e14; border-color: #fd7e14; }
      .kpi-level[data-level="2"].active { background-color: #ffc107; border-color: #ffc107; }
      .kpi-level[data-level="3"].active { background-color: #20c997; border-color: #20c997; }
      .kpi-level[data-level="4"].active { background-color: #0d6efd; border-color: #0d6efd; }
      .kpi-level[data-level="5"].active { background-color: #6f42c1; border-color: #6f42c1; }
      
       /* Colores específicos para KPI de fallas */
       #kpiIndicadorFallas .kpi-level[data-level="0"].active { background-color: #dc3545 !important; border-color: #dc3545 !important; }
       #kpiIndicadorFallas .kpi-level[data-level="1"].active { background-color: #dc3545 !important; border-color: #dc3545 !important; }
       #kpiIndicadorFallas .kpi-level[data-level="2"].active { background-color: #ffc107 !important; border-color: #ffc107 !important; }
       #kpiIndicadorFallas .kpi-level[data-level="3"].active { background-color: #20c997 !important; border-color: #20c997 !important; }
       #kpiIndicadorFallas .kpi-level[data-level="4"].active { background-color: #0d6efd !important; border-color: #0d6efd !important; }
       #kpiIndicadorFallas .kpi-level[data-level="5"].active { background-color: #6f42c1 !important; border-color: #6f42c1 !important; }

       /* Botón de actualizar del KPI de tiempo de respuesta en rosa */
       #btnActualizarKPITiempo {
         border-color: rgb(218, 2, 229) !important;
         color: rgb(218, 2, 229) !important;
       }
       #btnActualizarKPITiempo:hover {
         background-color: rgb(218, 2, 229) !important;
         color: white !important;
       }
      
      /* Animación del contador */
      .counter-animate {
        animation: countUp 2s ease-out;
      }
      
      @keyframes countUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      /* Estilos para la barra de progreso */
      .progress-bar {
        background: linear-gradient(90deg, #da02e5, #e533f0);
        transition: width 2s ease-in-out;
      }
      
      /* Tooltip personalizado */
      .tooltip-inner {
        background-color: #1a1a1a;
        color: #f1f1f1;
        border: 1px solid #da02e5;
        max-width: 300px;
      }
      
      .tooltip.bs-tooltip-top .tooltip-arrow::before {
        border-top-color: #da02e5;
      }
      
      /* Estilos para el dropdown de navegación */
      .nav-item.dropdown .nav-link.dropdown-toggle {
        color: #dddddd;
        border: none;
        background: transparent;
        transition: all 0.3s ease;
      }
      
      .nav-item.dropdown .nav-link.dropdown-toggle:hover {
        color: #ffffff;
        background: rgba(218, 2, 229, 0.1);
      }
      
      .nav-item.dropdown .nav-link.dropdown-toggle:focus {
        color: #ffffff;
        background: rgba(218, 2, 229, 0.2);
        box-shadow: 0 0 0 2px rgba(218, 2, 229, 0.3);
      }
      
      .nav-item.dropdown .nav-link.dropdown-toggle[aria-expanded="true"] {
        color: #ffffff;
        background: rgba(218, 2, 229, 0.2);
      }
      
      .nav-item.dropdown .nav-link.dropdown-toggle .bi-chevron-down {
        transition: transform 0.3s ease;
      }
      
      .nav-item.dropdown .nav-link.dropdown-toggle[aria-expanded="true"] .bi-chevron-down {
        transform: rotate(180deg);
      }
      
      .nav-item.dropdown .dropdown-menu {
        background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
        border: 1px solid #444;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        padding: 8px 0;
        margin-top: 4px;
      }
      
      .nav-item.dropdown .dropdown-menu .dropdown-item {
        color: #f1f1f1;
        padding: 10px 16px;
        transition: all 0.3s ease;
        border: none;
        background: transparent;
        width: 100%;
        text-align: left;
        font-size: 0.9rem;
      }
      
      .nav-item.dropdown .dropdown-menu .dropdown-item:hover {
        background: rgba(218, 2, 229, 0.2);
        color: #ffffff;
        transform: translateX(4px);
      }
      
      .nav-item.dropdown .dropdown-menu .dropdown-item:focus {
        background: rgba(218, 2, 229, 0.3);
        color: #ffffff;
        box-shadow: none;
        outline: none;
      }
      
      .nav-item.dropdown .dropdown-menu .dropdown-item.active {
        background: linear-gradient(135deg, #da02e5, #e533f0);
        color: #ffffff;
        font-weight: 600;
      }
      
      .nav-item.dropdown .dropdown-menu .dropdown-item i {
        color: #da02e5;
        transition: color 0.3s ease;
      }
      
      .nav-item.dropdown .dropdown-menu .dropdown-item:hover i {
        color: #ffffff;
      }
      
      .nav-item.dropdown .dropdown-menu .dropdown-item.active i {
        color: #ffffff;
      }
    </style>
</head>
<body class="index-page">

  <header id="header" class="header d-flex align-items-center fixed-top">
    <div class="container position-relative d-flex align-items-center justify-content-between">
      <a href="/principal" class="logo d-flex align-items-center me-auto me-xl-0">
        <h1 class="sitename">PhishIntel</h1>
      </a>
      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="/principal" class="btn-getstarted btn-login">Home</a></li>
        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
      </nav>
    </div>
  </header>

  <main class="main">
    <br>
    <section class="section">
      <div class="container" data-aos="fade-up">
        <div class="mb-3">
           <ul class="nav nav-tabs" role="tablist">
             <li class="nav-item" role="presentation">
               <button class="nav-link active" id="tab-kpis" data-bs-toggle="tab" data-bs-target="#panel-kpis" type="button" role="tab">
                 <i class="bi bi-speedometer2"></i> KPIs
               </button>
             </li>
             <li class="nav-item dropdown" role="presentation">
               <button class="nav-link dropdown-toggle" id="dropdown-estadisticas" data-bs-toggle="dropdown" aria-expanded="false" type="button">
                 <i class="bi bi-bar-chart"></i> Estadísticas Fallas
                 <i class="bi bi-chevron-down ms-1"></i>
               </button>
               <ul class="dropdown-menu" aria-labelledby="dropdown-estadisticas">
                 <li>
                   <button class="dropdown-item" id="tab-fecha" data-bs-toggle="tab" data-bs-target="#panel-fecha" type="button" role="tab">
                     <i class="bi bi-calendar3 me-2"></i> Fallas por Fecha
                   </button>
                 </li>
                 <li>
                   <button class="dropdown-item" id="tab-area" data-bs-toggle="tab" data-bs-target="#panel-area" type="button" role="tab">
                     <i class="bi bi-pie-chart me-2"></i> Fallas por Área
                   </button>
                 </li>
                 <li>
                   <button class="dropdown-item" id="tab-campania" data-bs-toggle="tab" data-bs-target="#panel-campania" type="button" role="tab">
                     <i class="bi bi-graph-up me-2"></i> Fallas por Tipo de Campaña
                   </button>
                 </li>
                 <li>
                   <button class="dropdown-item" id="tab-empleado" data-bs-toggle="tab" data-bs-target="#panel-empleado" type="button" role="tab">
                     <i class="bi bi-people-fill me-2"></i> Fallas por Empleado
                   </button>
                 </li>
               </ul>
             </li>
           </ul>
        </div>

        <div class="tab-content">
          <div class="tab-pane fade show active" id="panel-kpis" role="tabpanel" aria-labelledby="tab-kpis">
            <div class="row g-4">
              <div class="col-12">
                <div class="card p-4 bg-dark text-white">
                  <div class="text-center mb-4">
                    <h3 class="mb-3">
                      <i class="bi bi-speedometer2 me-2" style="color: #da02e5;"></i>
                      KPIs de Seguridad
                    </h3>
                  </div>
                  
                  <!-- KPI de Tiempo de Respuesta -->
                  <div class="row g-4">
                    <div class="col-lg-8">
                      <div class="card bg-gradient h-100" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border: 1px solid #444;">
                        <div class="card-body p-4">
                          <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                              <i class="bi bi-clock-history me-2" style="color: #da02e5;"></i>
                              Tiempo de Respuesta Promedio
                            </h5>
                            <div class="d-flex align-items-center">
                              <i class="bi bi-info-circle me-2" style="color: #da02e5; cursor: pointer;" 
                                 data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true"
                                 title="<strong>Tiempo de Respuesta Promedio</strong><br/>Tiempo promedio que tardan los usuarios en reportar un evento de phishing simulado, contado desde que se generó el evento hasta que el sistema lo registra como reportado.<br/>Mide qué tan rápido los usuarios detectan y reportan los intentos de phishing."></i>
                              <span id="kpiTiempoRespuesta" class="display-4 fw-bold" style="color: #da02e5;">0</span>
                              <span class="ms-2 fs-5 text-white">horas</span>
                            </div>
                          </div>
                          
                          <div class="row g-3 mb-3">
                            <div class="col-md-4">
                              <div class="text-center">
                                <div class="fs-6 text-white">Mediana</div>
                                <div id="kpiMediana" class="fs-4 fw-bold" style="color: #00d4aa;">0h</div>
                              </div>
                            </div>
                            <div class="col-md-4">
                              <div class="text-center">
                                <div class="fs-6 text-white">P90</div>
                                <div id="kpiP90" class="fs-4 fw-bold" style="color: #ff6b6b;">0h</div>
                              </div>
                            </div>
                            <div class="col-md-4">
                              <div class="text-center">
                                <div class="fs-6 text-white">Eventos</div>
                                <div id="kpiTotalEventos" class="fs-4 fw-bold" style="color: #feca57;">0</div>
                              </div>
                            </div>
                          </div>
                          
                          <!-- Barra de progreso del nivel -->
                          <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                              <span class="fs-6 text-white">Nivel de Madurez</span>
                              <span id="kpiNivel" class="badge fs-6 px-3 py-2">0/5</span>
                            </div>
                            <div class="progress" style="height: 12px; background-color: #333;">
                              <div id="kpiProgreso" class="progress-bar" role="progressbar" style="width: 0%; transition: width 2s ease-in-out;"></div>
                            </div>
                            <!-- Estado del nivel debajo de la barra -->
                            <div id="kpiEstadoNivel" class="text-center mt-2" style="display: none;">
                              <span id="kpiBadgeNivel" class="badge fs-6 px-3 py-2">
                                <i id="kpiIconoNivel" class="bi me-1"></i>
                                <span id="kpiTextoNivel">Nivel 1</span>
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="col-lg-4">
                      <div class="card bg-gradient h-100" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border: 1px solid #444;">
                        <div class="card-body p-4">
                          <h6 class="mb-3">
                            <i class="bi bi-shield-check me-2" style="color: #da02e5;"></i>
                            Clasificación Actual
                          </h6>
                          
                          <div class="text-center mb-3">
                            <div id="kpiClasificacion" class="fs-4 fw-bold mb-2" style="color: #da02e5;">Cargando...</div>
                            <div id="kpiDescripcion" class="text-white small">Obteniendo datos...</div>
                          </div>
                          
                          <!-- Indicador visual del nivel -->
                          <div class="d-flex justify-content-center mb-3">
                            <div id="kpiIndicador" class="kpi-indicator">
                              <div class="kpi-level" data-level="0" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" title="<strong>Nivel 1: Presas del Phishing</strong><br/>Mediana > 12h o P90 > 60h<br/>Necesitan mejorar significativamente"></div>
                              <div class="kpi-level" data-level="1" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" title="<strong>Nivel 2: Aprendices de Seguridad</strong><br/>Mediana ≤ 12h, P90 ≤ 60h<br/>En proceso de mejora"></div>
                              <div class="kpi-level" data-level="2" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" title="<strong>Nivel 3: Defensores Digitales</strong><br/>Mediana ≤ 4h, P90 ≤ 48h<br/>Respuesta estándar"></div>
                              <div class="kpi-level" data-level="3" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" title="<strong>Nivel 4: Guardianes Anti-Phishing</strong><br/>Mediana ≤ 2h, P90 ≤ 36h<br/>Responden rápido"></div>
                              <div class="kpi-level" data-level="4" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" title="<strong>Nivel 5: Vigilantes del Ciberespacio</strong><br/>Mediana ≤ 1h, P90 ≤ 24h<br/>Excelencia en ciberseguridad"></div>
                            </div>
                          </div>
                          
                          <div class="text-center">
                            <button id="btnActualizarKPITiempo" class="btn btn-outline-primary btn-sm">
                              <i class="bi bi-arrow-clockwise me-1"></i>
                              Actualizar
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- KPI de Tasa de Fallas -->
                  <div class="row g-4 mt-4">
                    <div class="col-lg-8">
                      <div class="card bg-gradient h-100" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border: 1px solid #444;">
                        <div class="card-body p-4">
                          <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                              <i class="bi bi-exclamation-triangle me-2" style="color: #ff6b6b;"></i>
                              Tasa de Fallas
                            </h5>
                            <div class="d-flex align-items-center">
                              <i class="bi bi-info-circle me-2" style="color: #ff6b6b; cursor: pointer;" 
                                 data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true"
                                 title="<strong>Tasa de Fallas</strong><br/>Porcentaje de usuarios que interactuaron de forma riesgosa con el intento de phishing (por ejemplo, haciendo clic o entregando credenciales), en relación al total de usuarios expuestos en la campaña"></i>
                              <span id="kpiTasaFallas" class="display-4 fw-bold" style="color: #ff6b6b;">0</span>
                              <span class="ms-2 fs-5 text-white">%</span>
                            </div>
                          </div>
                          
                          <div class="row g-3 mb-3">
                            <div class="col-md-4">
                              <div class="text-center">
                                <div class="fs-6 text-white">Total Intentos</div>
                                <div id="kpiTotalIntentosFallas" class="fs-4 fw-bold" style="color: #feca57;">0</div>
                              </div>
                            </div>
                            <div class="col-md-4">
                              <div class="text-center">
                                <div class="fs-6 text-white">Con Fallas</div>
                                <div id="kpiIntentosConFallas" class="fs-4 fw-bold" style="color: #ff6b6b;">0</div>
                              </div>
                            </div>
                            <div class="col-md-4">
                              <div class="text-center">
                                <div class="fs-6 text-white">Sin Fallas</div>
                                <div id="kpiIntentosSinFallas" class="fs-4 fw-bold" style="color: #00d4aa;">0</div>
                              </div>
                            </div>
                          </div>
                          
                          <!-- Barra de progreso del nivel -->
                          <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                              <span class="fs-6 text-white">Nivel de Madurez</span>
                              <span id="kpiNivelFallas" class="badge fs-6 px-3 py-2">0/5</span>
                            </div>
                            <div class="progress" style="height: 12px; background-color: #333;">
                              <div id="kpiProgresoFallas" class="progress-bar" role="progressbar" style="width: 0%; transition: width 2s ease-in-out;"></div>
                            </div>
                            <!-- Estado del nivel debajo de la barra -->
                            <div id="kpiEstadoNivelFallas" class="text-center mt-2" style="display: none;">
                              <span id="kpiBadgeNivelFallas" class="badge fs-6 px-3 py-2">
                                <i id="kpiIconoNivelFallas" class="bi me-1"></i>
                                <span id="kpiTextoNivelFallas">Nivel 1</span>
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="col-lg-4">
                      <div class="card bg-gradient h-100" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border: 1px solid #444;">
                        <div class="card-body p-4">
                          <h6 class="mb-3">
                            <i class="bi bi-shield-exclamation me-2" style="color: #ff6b6b;"></i>
                            Clasificación Actual
                          </h6>
                          
                          <div class="text-center mb-3">
                            <div id="kpiClasificacionFallas" class="fs-4 fw-bold mb-2" style="color: #ff6b6b;">Cargando...</div>
                            <div id="kpiDescripcionFallas" class="text-white small">Obteniendo datos...</div>
                          </div>
                          
                          <!-- Indicador visual del nivel -->
                          <div class="d-flex justify-content-center mb-3">
                            <div id="kpiIndicadorFallas" class="kpi-indicator">
                              <div class="kpi-level" data-level="0" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" title="<strong>Nivel 1: Presas del Phishing</strong><br/>Failure Rate > 20%<br/>Nivel crítico de fallas"></div>
                              <div class="kpi-level" data-level="1" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" title="<strong>Nivel 2: Aprendices de Seguridad</strong><br/>Failure Rate > 10% y ≤ 20%<br/>Fallas frecuentes"></div>
                              <div class="kpi-level" data-level="2" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" title="<strong>Nivel 3: Defensores Digitales</strong><br/>Failure Rate > 5% y ≤ 10%<br/>Rendimiento estándar"></div>
                              <div class="kpi-level" data-level="3" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" title="<strong>Nivel 4: Guardianes Anti-Phishing</strong><br/>Failure Rate > 2% y ≤ 5%<br/>Fallas puntuales"></div>
                              <div class="kpi-level" data-level="4" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" title="<strong>Nivel 5: Vigilantes del Ciberespacio</strong><br/>Failure Rate ≤ 2%<br/>Operación prácticamente sin fallas"></div>
                            </div>
                          </div>
                          
                          <div class="text-center">
                            <button id="btnActualizarKPIFallas" class="btn btn-outline-danger btn-sm">
                              <i class="bi bi-arrow-clockwise me-1"></i>
                              Actualizar
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                </div>
              </div>
            </div>
          </div>

          <div class="tab-pane fade" id="panel-fecha" role="tabpanel" aria-labelledby="tab-fecha">
            <div class="row g-4">
              <div class="col-lg-9">
                <div class="card p-3 bg-dark text-white">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Fallas por Fecha</h5>
                    <div class="filters-container">
                      <div class="filter-group">
                        <span class="filter-label">
                          <i class="bi bi-calendar3 filter-icon"></i>
                          Período
                        </span>
                        <div style="position: relative; width: 220px;">
                          <select id="filtroPeriodo" class="form-select form-select-sm" style="width: 100%;" multiple>
                          </select>
                          <div class="filter-placeholder" id="filtroPeriodoPlaceholder">Seleccionar períodos...</div>
                          <i class="bi bi-chevron-down filter-dropdown-icon"></i>
                        </div>
                      </div>
                      <div class="filter-group">
                        <span class="filter-label">
                          <i class="bi bi-funnel filter-icon"></i>
                          Tipo
                        </span>
                        <div style="position: relative; width: 180px;">
                          <select id="filtroTipoFecha" class="form-select form-select-sm" style="width: 100%;" multiple>
                            <option value="CORREO">📧 Correo</option>
                            <option value="MENSAJE">💬 Mensaje</option>
                            <option value="LLAMADA">📞 Llamada</option>
                            <option value="VIDEOLLAMADA">📹 Videollamada</option>
                          </select>
                          <div class="filter-placeholder" id="filtroTipoFechaPlaceholder">Seleccionar tipos...</div>
                          <i class="bi bi-chevron-down filter-dropdown-icon"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div id="chartFallasPorFecha"></div>
                </div>
              </div>
              <div class="col-lg-3">
                <div class="card p-3 h-100 d-flex align-items-center justify-content-center bg-dark text-white">
                  <div class="text-center">
                    <div class="mb-2"><i class="bi bi-calendar3" style="font-size: 2rem;"></i></div>
                    <h5 class="mb-1">Total de Fallas</h5>
                    <div id="totalFallasFecha" class="display-5">0</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="tab-pane fade" id="panel-area" role="tabpanel" aria-labelledby="tab-area">
            <div class="row g-4">
              <div class="col-lg-9">
                <div class="card p-3 bg-dark text-white">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Fallas por Área</h5>
                    <div class="filters-container">
                      <div class="filter-group">
                        <span class="filter-label">
                          <i class="bi bi-funnel filter-icon"></i>
                          Tipo
                        </span>
                        <div style="position: relative; width: 220px;">
                          <select id="filtroTipo" class="form-select form-select-sm" style="width: 100%;" multiple>
                            <option value="CORREO">📧 Correo</option>
                            <option value="MENSAJE">💬 Mensaje</option>
                            <option value="LLAMADA">📞 Llamada</option>
                            <option value="VIDEOLLAMADA">📹 Videollamada</option>
                          </select>
                          <div class="filter-placeholder" id="filtroTipoPlaceholder">Seleccionar tipos...</div>
                          <i class="bi bi-chevron-down filter-dropdown-icon"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div id="chartFallasPorArea"></div>
                </div>
              </div>
              <div class="col-lg-3">
                <div class="card p-3 h-100 d-flex align-items-center justify-content-center bg-dark text-white">
                  <div class="text-center">
                    <div class="mb-2"><i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i></div>
                    <h5 class="mb-1">Total de Fallas</h5>
                    <div id="totalFallas" class="display-5">0</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="tab-pane fade" id="panel-campania" role="tabpanel" aria-labelledby="tab-campania">
            <div class="row g-4">
              <div class="col-lg-9">
                <div class="card p-3 bg-dark text-white">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Fallas por Tipo de Campaña</h5>
                    <div class="filters-container">
                      <div class="filter-group">
                        <span class="filter-label">
                          <i class="bi bi-geo-alt filter-icon"></i>
                          Área
                        </span>
                        <div style="position: relative; width: 220px;">
                          <select id="filtroAreaCampania" class="form-select form-select-sm" style="width: 100%;" multiple>
                          </select>
                          <div class="filter-placeholder" id="filtroAreaCampaniaPlaceholder">Seleccionar áreas...</div>
                          <i class="bi bi-chevron-down filter-dropdown-icon"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div id="chartFallasPorCampania"></div>
                </div>
              </div>
              <div class="col-lg-3">
                <div class="card p-3 h-100 d-flex align-items-center justify-content-center bg-dark text-white">
                  <div class="text-center">
                    <div class="mb-2"><i class="bi bi-graph-up" style="font-size: 2rem;"></i></div>
                    <h5 class="mb-1">Total de Fallas</h5>
                    <div id="totalFallasCampania" class="display-5">0</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="tab-pane fade" id="panel-empleado" role="tabpanel" aria-labelledby="tab-empleado">
            <div class="row g-4">
              <div class="col-12">
                <div class="card p-3 bg-dark text-white">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Fallas por Empleado</h5>
                    <div class="filters-container">
                      <div class="filter-group">
                        <span class="filter-label">
                          <i class="bi bi-funnel filter-icon"></i>
                          Tipo
                        </span>
                        <div style="position: relative; width: 220px;">
                          <select id="filtroTipoEmpleado" class="form-select form-select-sm" style="width: 100%;" multiple>
                            <option value="CORREO">📧 Correo</option>
                            <option value="MENSAJE">💬 Mensaje</option>
                            <option value="LLAMADA">📞 Llamada</option>
                            <option value="VIDEOLLAMADA">📹 Videollamada</option>
                          </select>
                          <div class="filter-placeholder" id="filtroTipoEmpleadoPlaceholder">Seleccionar tipos...</div>
                          <i class="bi bi-chevron-down filter-dropdown-icon"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div id="contenidoEmpleados"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="tab-pane fade" id="panel-kpis" role="tabpanel" aria-labelledby="tab-kpis">
            <div class="row g-4">
              <div class="col-12">
                <div class="card p-4 bg-dark text-white">
                  <div class="text-center mb-4">
                    <h3 class="mb-3">
                      <i class="bi bi-speedometer2 me-2" style="color: #da02e5;"></i>
                      KPIs de Seguridad
                    </h3>
                  </div>
                  
                  <!-- KPI de Tiempo de Respuesta -->
                  <div class="row g-4">
                    <div class="col-lg-8">
                      <div class="card bg-gradient h-100" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border: 1px solid #444;">
                        <div class="card-body p-4">
                          <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                              <i class="bi bi-clock-history me-2" style="color: #da02e5;"></i>
                              Tiempo de Respuesta Promedio
                            </h5>
                            <div class="d-flex align-items-center">
                              <i class="bi bi-info-circle me-2" style="color: #da02e5; cursor: pointer;" 
                                 data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true"
                                 title="<strong>Tiempo de Respuesta Promedio</strong><br/>Tiempo promedio que tardan los usuarios en reportar un evento de phishing simulado, contado desde que se generó el evento hasta que el sistema lo registra como reportado.<br/>Mide qué tan rápido los usuarios detectan y reportan los intentos de phishing."></i>
                              <span id="kpiTiempoRespuesta" class="display-4 fw-bold" style="color: #da02e5;">0</span>
                              <span class="ms-2 fs-5 text-white">horas</span>
                            </div>
                          </div>
                          
                          <div class="row g-3 mb-3">
                            <div class="col-md-4">
                              <div class="text-center">
                                <div class="fs-6 text-white">Mediana</div>
                                <div id="kpiMediana" class="fs-4 fw-bold" style="color: #00d4aa;">0h</div>
                              </div>
                            </div>
                            <div class="col-md-4">
                              <div class="text-center">
                                <div class="fs-6 text-white">P90</div>
                                <div id="kpiP90" class="fs-4 fw-bold" style="color: #ff6b6b;">0h</div>
                              </div>
                            </div>
                            <div class="col-md-4">
                              <div class="text-center">
                                <div class="fs-6 text-white">Eventos</div>
                                <div id="kpiTotalEventos" class="fs-4 fw-bold" style="color: #feca57;">0</div>
                              </div>
                            </div>
                          </div>
                          
                          <!-- Barra de progreso del nivel -->
                          <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                              <span class="fs-6 text-white">Nivel de Madurez</span>
                              <span id="kpiNivel" class="badge fs-6 px-3 py-2">0/5</span>
                            </div>
                            <div class="progress" style="height: 12px; background-color: #333;">
                              <div id="kpiProgreso" class="progress-bar" role="progressbar" style="width: 0%; transition: width 2s ease-in-out;"></div>
                            </div>
                            <!-- Estado del nivel debajo de la barra -->
                            <div id="kpiEstadoNivel" class="text-center mt-2" style="display: none;">
                              <span id="kpiBadgeNivel" class="badge fs-6 px-3 py-2">
                                <i id="kpiIconoNivel" class="bi me-1"></i>
                                <span id="kpiTextoNivel">Nivel 1</span>
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="col-lg-4">
                      <div class="card bg-gradient h-100" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border: 1px solid #444;">
                        <div class="card-body p-4">
                          <h6 class="mb-3">
                            <i class="bi bi-shield-check me-2" style="color: #da02e5;"></i>
                            Clasificación Actual
                          </h6>
                          
                          <div class="text-center mb-3">
                            <div id="kpiClasificacion" class="fs-4 fw-bold mb-2" style="color: #da02e5;">Cargando...</div>
                            <div id="kpiDescripcion" class="text-white small">Obteniendo datos...</div>
                          </div>
                          
                          <!-- Indicador visual del nivel -->
                          <div class="d-flex justify-content-center mb-3">
                            <div id="kpiIndicador" class="kpi-indicator">
                              <div class="kpi-level" data-level="0" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" title="<strong>Nivel 1: Presas del Phishing</strong><br/>Mediana > 12h o P90 > 60h<br/>Necesitan mejorar significativamente"></div>
                              <div class="kpi-level" data-level="1" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" title="<strong>Nivel 2: Aprendices de Seguridad</strong><br/>Mediana ≤ 12h, P90 ≤ 60h<br/>En proceso de mejora"></div>
                              <div class="kpi-level" data-level="2" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" title="<strong>Nivel 3: Defensores Digitales</strong><br/>Mediana ≤ 4h, P90 ≤ 48h<br/>Respuesta estándar"></div>
                              <div class="kpi-level" data-level="3" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" title="<strong>Nivel 4: Guardianes Anti-Phishing</strong><br/>Mediana ≤ 2h, P90 ≤ 36h<br/>Responden rápido"></div>
                              <div class="kpi-level" data-level="4" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" title="<strong>Nivel 5: Vigilantes del Ciberespacio</strong><br/>Mediana ≤ 1h, P90 ≤ 24h<br/>Excelencia en ciberseguridad"></div>
                            </div>
                          </div>
                          
                          <div class="text-center">
                            <button id="btnActualizarKPI" class="btn btn-outline-primary btn-sm">
                              <i class="bi bi-arrow-clockwise me-1"></i>
                              Actualizar
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Información adicional -->
                  <div class="row g-4 mt-3">
                    <div class="col-12">
                      <div class="card bg-secondary">
                        <div class="card-body p-3">
                          <h6 class="mb-3">
                            <i class="bi bi-info-circle me-2"></i>
                            Información sobre el KPI
                          </h6>
                          <div class="row g-3">
                            <div class="col-md-6">
                              <div class="d-flex align-items-center">
                                <i class="bi bi-calculator me-2" style="color: #da02e5;"></i>
                                <div>
                                  <div class="fw-bold">Cálculo</div>
                                  <small class="text-white">Diferencia entre fecha de reporte y fecha de creación del evento</small>
                                </div>
                              </div>
                            </div>
                            <div class="col-md-6">
                              <div class="d-flex align-items-center">
                                <i class="bi bi-target me-2" style="color: #00d4aa;"></i>
                                <div>
                                  <div class="fw-bold">Objetivo Ideal</div>
                                  <small class="text-white">Mediana ≤ 1h, P90 ≤ 24h</small>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/aos/aos.js"></script>
  <script> AOS.init(); </script>
  <!-- ApexCharts -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <script>
    let chartInstance = null;

    async function cargarFallasPorArea(tiposEvento = []) {
      try {
        let url = '/api/areas/fallas';
        if (tiposEvento.length > 0) {
          const params = new URLSearchParams();
          tiposEvento.forEach(tipo => params.append('tipo_evento', tipo));
          url += `?${params.toString()}`;
        }
        
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('Error al obtener datos');
        const data = await resp.json();

        const areas = (data.areas || []).sort((a,b) => a.idArea - b.idArea);
        const labels = areas.map(a => a.nombreArea);
        const valores = areas.map(a => a.totalFallas);
        const total = valores.reduce((acc, v) => acc + v, 0);
        
        // Calcular porcentajes y crear datos en formato correcto
        const datosTorta = areas.map((area, index) => {
          const porcentaje = total > 0 ? parseFloat(((area.totalFallas / total) * 100).toFixed(1)) : 0;
          return {
            name: area.nombreArea,
            value: porcentaje,
            cantidad: area.totalFallas
          };
        });
        
        document.getElementById('totalFallas').textContent = total;

        const opciones = {
          chart: { 
            type: 'pie', 
            height: 420, 
            toolbar: { show: false }, 
            foreColor: '#f1f1f1' 
          },
          theme: { mode: 'dark' },
          plotOptions: { 
            pie: { 
              expandOnClick: true,
              donut: {
                size: '60%',
                labels: {
                  show: true,
                  name: {
                    show: true,
                    fontSize: '16px',
                    fontWeight: 600,
                    color: '#f1f1f1'
                  },
                  value: {
                    show: true,
                    fontSize: '14px',
                    fontWeight: 400,
                    color: '#f1f1f1',
                    formatter: function (val) {
                      return val + '%'
                    }
                  },
                  total: {
                    show: false
                  }
                }
              }
            } 
          },
          dataLabels: { 
            enabled: true, 
            style: { 
              colors: ['#ffffff'],
              fontSize: '12px',
              fontWeight: 600
            }, 
            formatter: (val, opts) => {
              const dataPoint = datosTorta[opts.seriesIndex];
              return `${dataPoint.name}\n${val}% (${dataPoint.cantidad})`;
            }
          },
          series: datosTorta.map(item => item.value),
          labels: datosTorta.map(item => item.name),
          colors: ['#da02e5', '#00d4aa', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff', '#5f27cd'],
          tooltip: { 
            theme: 'dark',
            style: {
              fontSize: '14px',
              fontFamily: 'Arial, sans-serif'
            },
            fillSeriesColor: false,
            marker: {
              show: true
            },
            y: { 
              formatter: (val, { seriesIndex, dataPointIndex }) => {
                const dataPoint = datosTorta[dataPointIndex];
                return `${dataPoint.name}: ${val}% (${dataPoint.cantidad} fallas)`;
              }
            } 
          },
          legend: {
            position: 'bottom',
            horizontalAlign: 'center',
            fontSize: '14px',
            fontFamily: 'Helvetica, Arial',
            fontWeight: 400,
            labels: {
              colors: '#f1f1f1'
            },
            markers: {
              width: 12,
              height: 12,
              strokeWidth: 0,
              radius: 2
            }
          }
        };

        // Destruir gráfico anterior si existe
        if (chartInstance) {
          chartInstance.destroy();
        }
        
        chartInstance = new ApexCharts(document.querySelector('#chartFallasPorArea'), opciones);
        chartInstance.render();
      } catch (e) {
        console.error(e);
      }
    }

    // Función para actualizar placeholder
    function actualizarPlaceholder(selectId, placeholderId) {
      const select = document.getElementById(selectId);
      const placeholder = document.getElementById(placeholderId);
      const seleccionados = Array.from(select.selectedOptions);
      
      // Solo mostrar placeholder si el select no tiene foco
      if (document.activeElement !== select) {
        placeholder.style.display = 'block';
        
        if (seleccionados.length === 0) {
          placeholder.textContent = placeholderId.includes('Periodo') ? 'Seleccionar períodos...' : 'Seleccionar tipos...';
          placeholder.style.opacity = '1';
          placeholder.classList.remove('has-selection');
        } else if (seleccionados.length === 1) {
          placeholder.textContent = seleccionados[0].textContent;
          placeholder.style.opacity = '0.9';
          placeholder.classList.add('has-selection');
        } else {
          placeholder.textContent = `${seleccionados.length} seleccionados`;
          placeholder.style.opacity = '0.9';
          placeholder.classList.add('has-selection');
        }
      } else {
        // Si el select tiene foco, ocultar placeholder
        placeholder.style.display = 'none';
      }
    }

    // Event listener para el filtro
    document.getElementById('filtroTipo').addEventListener('change', function() {
      const tiposSeleccionados = Array.from(this.selectedOptions).map(option => option.value);
      actualizarPlaceholder('filtroTipo', 'filtroTipoPlaceholder');
      cargarFallasPorArea(tiposSeleccionados);
    });

    // Event listeners para ocultar/mostrar placeholder
    document.getElementById('filtroTipo').addEventListener('focus', function() {
      document.getElementById('filtroTipoPlaceholder').style.display = 'none';
    });

    document.getElementById('filtroTipo').addEventListener('blur', function() {
      setTimeout(() => {
        actualizarPlaceholder('filtroTipo', 'filtroTipoPlaceholder');
      }, 100);
    });

    // Event listener para manejar clics en opciones (deselección sin Ctrl)
    document.getElementById('filtroTipo').addEventListener('mousedown', function(e) {
      // Ocultar placeholder inmediatamente
      document.getElementById('filtroTipoPlaceholder').style.display = 'none';
      
      // Solo permitir deselección sin Ctrl si la opción ya está seleccionada
      if (e.target.tagName === 'OPTION' && e.target.selected) {
        e.preventDefault();
        e.target.selected = false;
        
        // Actualizar placeholder después de un pequeño delay
        setTimeout(() => {
          actualizarPlaceholder('filtroTipo', 'filtroTipoPlaceholder');
        }, 50);
        
        // Disparar evento change manualmente
        this.dispatchEvent(new Event('change'));
      }
    });

     // Variables para el gráfico de fecha
     let chartFechaInstance = null;
     
     // Variables para el gráfico de campaña
     let chartCampaniaInstance = null;

    // Función para cargar fallas por fecha
    async function cargarFallasPorFecha(periodos = [], tiposEvento = []) {
      try {
        const params = new URLSearchParams();
        periodos.forEach(periodo => params.append('periodo', periodo));
        tiposEvento.forEach(tipo => params.append('tipo_evento', tipo));
        
        const url = `/api/areas/fallas-fecha?${params.toString()}`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('Error al obtener datos');
        const data = await resp.json();

        const periodosData = data.periodos || [];
        const fallas = data.fallas || [];
        const total = data.totalFallas || 0;
        
        // Actualizar total
        document.getElementById('totalFallasFecha').textContent = total;

        // Formatear etiquetas (siempre por mes)
        const etiquetas = periodosData.map(periodo => {
          const [año, mes] = periodo.split('-');
          const nombresMeses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun',
                               'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
          return `${nombresMeses[parseInt(mes) - 1]} ${año}`;
        });

        // Configurar gráfico de barras
        const opciones = {
          chart: { 
            type: 'bar', 
            height: 420, 
            toolbar: { show: false }, 
            foreColor: '#f1f1f1' 
          },
          theme: { mode: 'dark' },
          grid: { borderColor: '#444' },
          plotOptions: { 
            bar: { 
              horizontal: false, 
              columnWidth: '60%', 
              borderRadius: 6 
            } 
          },
          dataLabels: { 
            enabled: true, 
            style: { colors: ['#ffffff'] },
            formatter: (val) => `${val}`
          },
          xaxis: { 
            categories: etiquetas, 
            labels: { 
              style: { colors: '#ffffff' },
              rotate: -45
            }
          },
          yaxis: { 
            title: { 
              text: 'Cantidad de fallas', 
              style: { color: '#ffffff', fontSize: '16px' } 
            }, 
            labels: { style: { colors: '#ffffff' } },
            min: 0
          },
           series: [{ name: 'Fallas', data: fallas }],
           colors: ['#da02e5'],
          tooltip: { 
            theme: 'dark', 
            y: { 
              formatter: (val) => `${val} fallas`
            } 
          }
        };

        // Destruir gráfico anterior si existe
        if (chartFechaInstance) {
          chartFechaInstance.destroy();
        }
        
        chartFechaInstance = new ApexCharts(document.querySelector('#chartFallasPorFecha'), opciones);
        chartFechaInstance.render();

        // Actualizar opciones de filtros si es la primera carga
        if (data.filtros) {
          actualizarFiltros(data.filtros);
        }

       } catch (e) {
         console.error('Error cargando fallas por fecha:', e);
       }
     }

     // Función para cargar fallas por tipo de campaña
     async function cargarFallasPorCampania(areas = []) {
       try {
         let url = '/api/areas/fallas-campania';
         if (areas.length > 0) {
           const params = new URLSearchParams();
           areas.forEach(area => params.append('area', area));
           url += `?${params.toString()}`;
         }
         
         const resp = await fetch(url);
         if (!resp.ok) throw new Error('Error al obtener datos');
         const data = await resp.json();

         const campanias = data.campanias || [];
         const total = campanias.reduce((acc, campania) => acc + campania.totalFallas, 0);
         
         document.getElementById('totalFallasCampania').textContent = total;

         // Crear datos para el gráfico de torta
         const labels = campanias.map(campania => {
           const nombres = {
             'CORREO': '📧 Correo',
             'MENSAJE': '💬 Mensaje', 
             'LLAMADA': '📞 Llamada',
             'VIDEOLLAMADA': '📹 Videollamada'
           };
           return nombres[campania.tipo] || campania.tipo;
         });
         
         const valores = campanias.map(campania => campania.totalFallas);

         const opciones = {
           chart: { 
             type: 'bar', 
             height: 420, 
             toolbar: { show: false }, 
             foreColor: '#f1f1f1' 
           },
           theme: { mode: 'dark' },
           grid: { borderColor: '#444' },
           plotOptions: { 
             bar: { 
               horizontal: false, 
               columnWidth: '60%', 
               borderRadius: 6 
             } 
           },
           dataLabels: { 
             enabled: true, 
             style: { colors: ['#ffffff'] },
             formatter: (val) => `${val}`
           },
           xaxis: { 
             categories: labels, 
             labels: { 
               style: { colors: '#ffffff' },
               rotate: -45
             }
           },
           yaxis: { 
             title: { 
               text: 'Cantidad de fallas', 
               style: { color: '#ffffff', fontSize: '16px' } 
             }, 
             labels: { style: { colors: '#ffffff' } },
             min: 0
           },
           series: [{ name: 'Fallas', data: valores }],
           colors: ['#da02e5'],
           tooltip: { 
             theme: 'dark', 
             y: { 
               formatter: (val) => `${val} fallas`
             } 
           }
         };

         // Destruir gráfico anterior si existe
         if (chartCampaniaInstance) {
           chartCampaniaInstance.destroy();
         }
         
         chartCampaniaInstance = new ApexCharts(document.querySelector('#chartFallasPorCampania'), opciones);
         chartCampaniaInstance.render();

         // Actualizar opciones de filtros de área si es la primera carga
         if (campanias.length > 0 && document.getElementById('filtroAreaCampania').children.length === 0) {
           // Obtener todas las áreas únicas de las campañas
           const todasLasAreas = new Set();
           campanias.forEach(campania => {
             campania.areas.forEach(area => {
               todasLasAreas.add(JSON.stringify({idArea: area.idArea, nombreArea: area.nombreArea}));
             });
           });
           const areasUnicas = Array.from(todasLasAreas).map(areaStr => JSON.parse(areaStr));
           actualizarFiltrosArea(areasUnicas);
         }

       } catch (e) {
         console.error('Error cargando fallas por campaña:', e);
       }
     }

     // Función para actualizar las opciones de filtros de área
     function actualizarFiltrosArea(areas) {
       const selectArea = document.getElementById('filtroAreaCampania');
       
       // Limpiar opciones existentes
       selectArea.innerHTML = '';
       
       // Agregar áreas
       areas.forEach(area => {
         const option = document.createElement('option');
         option.value = area.idArea.toString();
         option.textContent = `🏢 ${area.nombreArea}`;
         option.style.fontSize = '0.9rem';
         selectArea.appendChild(option);
       });
     }

    // Función para actualizar las opciones de filtros jerárquicos
    function actualizarFiltros(filtros) {
      const selectPeriodo = document.getElementById('filtroPeriodo');
      
      // Limpiar opciones existentes
      selectPeriodo.innerHTML = '';
      
      const nombresMeses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                           'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      
      // Agregar años
      if (filtros.años) {
        filtros.años.forEach(año => {
          const option = document.createElement('option');
          option.value = año.toString();
          option.textContent = `📅 ${año}`;
          option.style.fontWeight = 'bold';
          option.style.fontSize = '0.95rem';
          selectPeriodo.appendChild(option);
        });
      }
      
       // Agregar trimestres
       if (filtros.trimestres) {
         filtros.trimestres.forEach(trimestre => {
           const option = document.createElement('option');
           option.value = trimestre;
           option.textContent = `📊 ${trimestre}`;
           option.style.color = '#da02e5';
           option.style.fontWeight = '600';
           option.style.fontSize = '0.9rem';
           option.style.paddingLeft = '20px';
           selectPeriodo.appendChild(option);
         });
       }
      
      // Agregar meses
      if (filtros.meses) {
        filtros.meses.forEach(mesPeriodo => {
          const [mes, año] = mesPeriodo.split('-');
          const option = document.createElement('option');
          option.value = mesPeriodo;
          option.textContent = `📅 ${nombresMeses[parseInt(mes) - 1]} ${año}`;
          option.style.paddingLeft = '40px';
          option.style.fontSize = '0.85rem';
          option.style.opacity = '0.9';
          selectPeriodo.appendChild(option);
        });
      }
    }

    // Event listeners para filtros de fecha
    document.getElementById('filtroPeriodo').addEventListener('change', function() {
      const periodos = Array.from(this.selectedOptions).map(option => option.value);
      const tipos = Array.from(document.getElementById('filtroTipoFecha').selectedOptions).map(option => option.value);
      actualizarPlaceholder('filtroPeriodo', 'filtroPeriodoPlaceholder');
      cargarFallasPorFecha(periodos, tipos);
    });

    document.getElementById('filtroTipoFecha').addEventListener('change', function() {
      const periodos = Array.from(document.getElementById('filtroPeriodo').selectedOptions).map(option => option.value);
      const tipos = Array.from(this.selectedOptions).map(option => option.value);
      actualizarPlaceholder('filtroTipoFecha', 'filtroTipoFechaPlaceholder');
      cargarFallasPorFecha(periodos, tipos);
    });

    // Event listeners para ocultar/mostrar placeholder - Filtro Período
    document.getElementById('filtroPeriodo').addEventListener('focus', function() {
      document.getElementById('filtroPeriodoPlaceholder').style.display = 'none';
    });

    document.getElementById('filtroPeriodo').addEventListener('blur', function() {
      setTimeout(() => {
        actualizarPlaceholder('filtroPeriodo', 'filtroPeriodoPlaceholder');
      }, 100);
    });

    // Event listener para manejar clics en opciones (deselección sin Ctrl) - Período
    document.getElementById('filtroPeriodo').addEventListener('mousedown', function(e) {
      // Ocultar placeholder inmediatamente
      document.getElementById('filtroPeriodoPlaceholder').style.display = 'none';
      
      // Solo permitir deselección sin Ctrl si la opción ya está seleccionada
      if (e.target.tagName === 'OPTION' && e.target.selected) {
        e.preventDefault();
        e.target.selected = false;
        
        // Actualizar placeholder después de un pequeño delay
        setTimeout(() => {
          actualizarPlaceholder('filtroPeriodo', 'filtroPeriodoPlaceholder');
        }, 50);
        
        // Disparar evento change manualmente
        this.dispatchEvent(new Event('change'));
      }
    });

    // Event listeners para ocultar/mostrar placeholder - Filtro Tipo Fecha
    document.getElementById('filtroTipoFecha').addEventListener('focus', function() {
      document.getElementById('filtroTipoFechaPlaceholder').style.display = 'none';
    });

    document.getElementById('filtroTipoFecha').addEventListener('blur', function() {
      setTimeout(() => {
        actualizarPlaceholder('filtroTipoFecha', 'filtroTipoFechaPlaceholder');
      }, 100);
    });

    // Event listener para manejar clics en opciones (deselección sin Ctrl) - Tipo Fecha
    document.getElementById('filtroTipoFecha').addEventListener('mousedown', function(e) {
      // Ocultar placeholder inmediatamente
      document.getElementById('filtroTipoFechaPlaceholder').style.display = 'none';
      
      // Solo permitir deselección sin Ctrl si la opción ya está seleccionada
      if (e.target.tagName === 'OPTION' && e.target.selected) {
        e.preventDefault();
        e.target.selected = false;
        
        // Actualizar placeholder después de un pequeño delay
        setTimeout(() => {
          actualizarPlaceholder('filtroTipoFecha', 'filtroTipoFechaPlaceholder');
        }, 50);
        
        // Disparar evento change manualmente
        this.dispatchEvent(new Event('change'));
      }
    });

     // Event listeners para filtros de campaña
     document.getElementById('filtroAreaCampania').addEventListener('change', function() {
       const areas = Array.from(this.selectedOptions).map(option => option.value);
       actualizarPlaceholder('filtroAreaCampania', 'filtroAreaCampaniaPlaceholder');
       cargarFallasPorCampania(areas);
     });

     // Event listeners para ocultar/mostrar placeholder - Filtro Área Campaña
     document.getElementById('filtroAreaCampania').addEventListener('focus', function() {
       document.getElementById('filtroAreaCampaniaPlaceholder').style.display = 'none';
     });

     document.getElementById('filtroAreaCampania').addEventListener('blur', function() {
       setTimeout(() => {
         actualizarPlaceholder('filtroAreaCampania', 'filtroAreaCampaniaPlaceholder');
       }, 100);
     });

     // Event listener para manejar clics en opciones (deselección sin Ctrl) - Área Campaña
     document.getElementById('filtroAreaCampania').addEventListener('mousedown', function(e) {
       // Ocultar placeholder inmediatamente
       document.getElementById('filtroAreaCampaniaPlaceholder').style.display = 'none';
       
       // Solo permitir deselección sin Ctrl si la opción ya está seleccionada
       if (e.target.tagName === 'OPTION' && e.target.selected) {
         e.preventDefault();
         e.target.selected = false;
         
         // Actualizar placeholder después de un pequeño delay
         setTimeout(() => {
           actualizarPlaceholder('filtroAreaCampania', 'filtroAreaCampaniaPlaceholder');
         }, 50);
         
         // Disparar evento change manualmente
         this.dispatchEvent(new Event('change'));
       }
     });

     // Función para cargar fallas por empleado
     async function cargarFallasPorEmpleado(tiposEvento = []) {
       try {
         let url = '/api/areas/fallas-empleados';
         if (tiposEvento.length > 0) {
           const params = new URLSearchParams();
           tiposEvento.forEach(tipo => params.append('tipo_evento', tipo));
           url += `?${params.toString()}`;
         }
         
         const resp = await fetch(url);
         if (!resp.ok) throw new Error('Error al obtener datos');
         const data = await resp.json();

         const areas = data.areas || [];
         const contenido = document.getElementById('contenidoEmpleados');
         
         if (areas.length === 0) {
           contenido.innerHTML = `
             <div class="text-center py-5">
               <i class="bi bi-info-circle" style="font-size: 3rem; color: #da02e5;"></i>
               <h5 class="mt-3 text-muted">No hay datos disponibles</h5>
               <p class="text-muted">No se encontraron empleados con fallas en las áreas seleccionadas.</p>
             </div>
           `;
           return;
         }

         let html = '';
         
         areas.forEach((area, index) => {
           if (area.totalEmpleados > 0) {
             const areaId = `area-${index}`;
             html += `
               <div class="card mb-3 bg-dark border-0" style="box-shadow: 0 4px 15px rgba(218, 2, 229, 0.2);">
                 <div class="card-header bg-gradient" style="background: linear-gradient(135deg, #da02e5, #e533f0); border: none; cursor: pointer;" 
                      data-bs-toggle="collapse" data-bs-target="#${areaId}" aria-expanded="false" aria-controls="${areaId}">
                   <div class="d-flex justify-content-between align-items-center">
                     <h6 class="mb-0 text-white">
                       <i class="bi bi-building me-2"></i>
                       ${area.nombreArea}
                       <i class="bi bi-chevron-down ms-2" id="icon-${areaId}"></i>
                     </h6>
                     <div class="d-flex gap-2">
                       <span class="badge" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">
                         <i class="bi bi-people-fill me-1"></i>
                         ${area.totalEmpleados} empleados
                       </span>
                       <span class="badge" style="background: rgba(255,107,107,0.8); color: white;">
                         <i class="bi bi-exclamation-triangle-fill me-1"></i>
                         ${area.empleadosConFalla} con fallas
                       </span>
                       <span class="badge" style="background: rgba(255,193,7,0.8); color: #000;">
                         <i class="bi bi-bug-fill me-1"></i>
                         ${area.totalFallas} fallas
                       </span>
                     </div>
                   </div>
                 </div>
                 <div class="collapse" id="${areaId}">
                   <div class="card-body p-3">
                     <div class="row g-3">
             `;
             
             area.empleados.forEach(empleado => {
               const badgeClass = empleado.tieneFallas ? 'bg-danger' : 'bg-success';
               const badgeText = empleado.tieneFallas ? `${empleado.cantidadFallas} fallas` : 'Sin fallas';
               const iconClass = empleado.tieneFallas ? 'bi-exclamation-triangle-fill' : 'bi-check-circle-fill';
               const cardStyle = empleado.tieneFallas ? 
                 'border-left: 4px solid #ff6b6b; box-shadow: 0 2px 8px rgba(255,107,107,0.3);' : 
                 'border-left: 4px solid #00d4aa; box-shadow: 0 2px 8px rgba(0,212,170,0.3);';
               
               html += `
                 <div class="col-lg-3 col-md-6 col-sm-12">
                   <div class="card bg-dark border-0" style="${cardStyle}">
                     <div class="card-body p-3">
                       <div class="d-flex justify-content-between align-items-start mb-2">
                         <h6 class="mb-0 text-white" style="font-size: 0.9rem;">
                           <i class="bi bi-person-fill me-2" style="color: #da02e5;"></i>
                           ${empleado.nombre} ${empleado.apellido}
                         </h6>
                         <span class="badge ${badgeClass}" style="font-size: 0.75rem;">
                           <i class="bi ${iconClass} me-1"></i>
                           ${badgeText}
                         </span>
                       </div>
                       <div class="text-white small">
                         <i class="bi bi-person-badge me-1" style="color: #da02e5;"></i>
                         ID: ${empleado.idUsuario}
                       </div>
                     </div>
                   </div>
                 </div>
               `;
             });
             
             html += `
                     </div>
                   </div>
                 </div>
               </div>
             `;
           }
         });
         
         contenido.innerHTML = html;
         
         // Agregar event listeners para los iconos de colapso
         areas.forEach((area, index) => {
           const areaId = `area-${index}`;
           const iconId = `icon-${areaId}`;
           const collapseElement = document.getElementById(areaId);
           const iconElement = document.getElementById(iconId);
           
           if (collapseElement && iconElement) {
             collapseElement.addEventListener('show.bs.collapse', function () {
               iconElement.style.transform = 'rotate(180deg)';
             });
             
             collapseElement.addEventListener('hide.bs.collapse', function () {
               iconElement.style.transform = 'rotate(0deg)';
             });
           }
         });
         
       } catch (e) {
         console.error('Error cargando fallas por empleado:', e);
         document.getElementById('contenidoEmpleados').innerHTML = `
           <div class="text-center py-5">
             <i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: #da02e5;"></i>
             <h5 class="mt-3 text-danger">Error al cargar datos</h5>
             <p class="text-muted">No se pudieron cargar los datos de empleados. Intente nuevamente.</p>
           </div>
         `;
       }
     }

     // Event listeners para filtros de empleado
     document.getElementById('filtroTipoEmpleado').addEventListener('change', function() {
       const tiposSeleccionados = Array.from(this.selectedOptions).map(option => option.value);
       actualizarPlaceholder('filtroTipoEmpleado', 'filtroTipoEmpleadoPlaceholder');
       cargarFallasPorEmpleado(tiposSeleccionados);
     });

     // Event listeners para ocultar/mostrar placeholder - Filtro Tipo Empleado
     document.getElementById('filtroTipoEmpleado').addEventListener('focus', function() {
       document.getElementById('filtroTipoEmpleadoPlaceholder').style.display = 'none';
     });

     document.getElementById('filtroTipoEmpleado').addEventListener('blur', function() {
       setTimeout(() => {
         actualizarPlaceholder('filtroTipoEmpleado', 'filtroTipoEmpleadoPlaceholder');
       }, 100);
     });

     // Event listener para manejar clics en opciones (deselección sin Ctrl) - Tipo Empleado
     document.getElementById('filtroTipoEmpleado').addEventListener('mousedown', function(e) {
       // Ocultar placeholder inmediatamente
       document.getElementById('filtroTipoEmpleadoPlaceholder').style.display = 'none';
       
       // Solo permitir deselección sin Ctrl si la opción ya está seleccionada
       if (e.target.tagName === 'OPTION' && e.target.selected) {
         e.preventDefault();
         e.target.selected = false;
         
         // Actualizar placeholder después de un pequeño delay
         setTimeout(() => {
           actualizarPlaceholder('filtroTipoEmpleado', 'filtroTipoEmpleadoPlaceholder');
         }, 50);
         
         // Disparar evento change manualmente
         this.dispatchEvent(new Event('change'));
       }
     });

     // Cargar datos iniciales
     document.addEventListener('DOMContentLoaded', () => {
       cargarFallasPorFecha(); // Cargar primero el reporte por fecha
       cargarFallasPorArea(); // Cargar también el reporte por área
       cargarFallasPorCampania(); // Cargar también el reporte por campaña
       cargarFallasPorEmpleado(); // Cargar también el reporte por empleado
       cargarKPITiempoRespuesta(); // Cargar KPI de tiempo de respuesta
       cargarKPITasaFallas(); // Cargar KPI de tasa de fallas
       
       // Inicializar tooltips
       var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
       var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
         return new bootstrap.Tooltip(tooltipTriggerEl);
       });
       
       // Inicializar funcionalidad del dropdown de estadísticas
       inicializarDropdownEstadisticas();
     });
     
     // Función para inicializar el dropdown de estadísticas
     function inicializarDropdownEstadisticas() {
       const dropdownToggle = document.getElementById('dropdown-estadisticas');
       const dropdownItems = document.querySelectorAll('.nav-item.dropdown .dropdown-item');
       const kpisTab = document.getElementById('tab-kpis');
       
       // Texto original del dropdown
       const originalDropdownText = '<i class="bi bi-bar-chart"></i> Estadísticas Fallas <i class="bi bi-chevron-down ms-1"></i>';
       
       // Función para resetear el dropdown a su estado original
       function resetearDropdown() {
         dropdownToggle.innerHTML = originalDropdownText;
         dropdownItems.forEach(dropdownItem => {
           dropdownItem.classList.remove('active');
         });
       }
       
       // Manejar clics en los elementos del dropdown
       dropdownItems.forEach(item => {
         item.addEventListener('click', function(e) {
           e.preventDefault();
           
           // Remover clase active de todos los elementos del dropdown
           dropdownItems.forEach(dropdownItem => {
             dropdownItem.classList.remove('active');
           });
           
           // Agregar clase active al elemento clickeado
           this.classList.add('active');
           
           // Cerrar el dropdown
           const dropdown = bootstrap.Dropdown.getInstance(dropdownToggle);
           if (dropdown) {
             dropdown.hide();
           }
           
           // Actualizar el texto del botón del dropdown para mostrar la opción seleccionada
           const icon = this.querySelector('i');
           const text = this.textContent.trim();
           dropdownToggle.innerHTML = `${icon.outerHTML} ${text} <i class="bi bi-chevron-down ms-1"></i>`;
         });
       });
       
       // Manejar clic en el tab de KPIs para resetear el dropdown
       kpisTab.addEventListener('click', function() {
         resetearDropdown();
       });
       
       // Manejar el estado del dropdown cuando se abre/cierra
       dropdownToggle.addEventListener('show.bs.dropdown', function() {
         this.setAttribute('aria-expanded', 'true');
       });
       
       dropdownToggle.addEventListener('hide.bs.dropdown', function() {
         this.setAttribute('aria-expanded', 'false');
       });
     }

     // Función para cargar el KPI de tiempo de respuesta
     async function cargarKPITiempoRespuesta() {
       try {
         const resp = await fetch('/api/kpis/tiempo-respuesta');
         if (!resp.ok) throw new Error('Error al obtener datos del KPI');
         const data = await resp.json();

         // Animar el contador principal (más lento)
         animarContador('kpiTiempoRespuesta', data.tiempoRespuestaPromedio, 4);
         
         // Animar métricas secundarias con delay escalonado
         setTimeout(() => {
           animarContador('kpiMediana', data.tiempoRespuestaMediana, 3, 'h');
         }, 500);
         
         setTimeout(() => {
           animarContador('kpiP90', data.tiempoRespuestaP90, 3, 'h');
         }, 1000);
         
         setTimeout(() => {
           animarContadorEntero('kpiTotalEventos', data.totalEventosReportados, 2, '');
         }, 1500);
         
         // Actualizar clasificación con animación
         setTimeout(() => {
           document.getElementById('kpiClasificacion').textContent = data.clasificacion;
           document.getElementById('kpiDescripcion').textContent = data.descripcion;
           document.getElementById('kpiClasificacion').style.opacity = '0';
           document.getElementById('kpiDescripcion').style.opacity = '0';
           document.getElementById('kpiClasificacion').style.transition = 'opacity 1s ease-in-out';
           document.getElementById('kpiDescripcion').style.transition = 'opacity 1s ease-in-out';
           
           setTimeout(() => {
             document.getElementById('kpiClasificacion').style.opacity = '1';
             document.getElementById('kpiDescripcion').style.opacity = '1';
           }, 100);
         }, 3000);
         
         // Actualizar nivel y progreso
         const nivel = data.nivel;
         let porcentaje;
         
         // Configurar barra de progreso y estado del nivel
         porcentaje = (nivel / 5) * 100;
         document.getElementById('kpiProgreso').className = 'progress-bar';
         
         // Determinar clase y texto según el nivel
         let claseNivel, icono, texto;
         if (nivel === 1) {
           claseNivel = 'nivel1';
           icono = 'bi-exclamation-triangle';
           texto = 'Presas del Phishing';
         } else if (nivel === 2) {
           claseNivel = 'normal';
           icono = 'bi-info-circle';
           texto = 'Aprendices de Seguridad';
         } else if (nivel === 3) {
           claseNivel = 'normal';
           icono = 'bi-shield-check';
           texto = 'Defensores Digitales';
         } else if (nivel === 4) {
           claseNivel = 'alto';
           icono = 'bi-shield-fill-check';
           texto = 'Guardianes Anti-Phishing';
         } else if (nivel === 5) {
           claseNivel = 'alto';
           icono = 'bi-award';
           texto = 'Vigilantes del Ciberespacio';
         } else {
           claseNivel = 'normal';
           icono = 'bi-question-circle';
           texto = 'Nivel Desconocido';
         }
         
         actualizarEstadoNivel(nivel, claseNivel, icono, texto);
         
         // Animar la barra de progreso
         setTimeout(() => {
           document.getElementById('kpiProgreso').style.width = `${porcentaje}%`;
         }, 2000);
         
         document.getElementById('kpiNivel').textContent = `${nivel}/5`;
         
         // Actualizar indicador visual con delay
         setTimeout(() => {
           actualizarIndicadorNivel(nivel);
         }, 2500);
         
         // Aplicar animaciones
         document.getElementById('kpiMediana').classList.add('counter-animate');
         document.getElementById('kpiP90').classList.add('counter-animate');
         document.getElementById('kpiTotalEventos').classList.add('counter-animate');
         document.getElementById('kpiClasificacion').classList.add('counter-animate');
         
       } catch (e) {
         console.error('Error cargando KPI:', e);
         document.getElementById('kpiTiempoRespuesta').textContent = 'Error';
         document.getElementById('kpiClasificacion').textContent = 'Error al cargar';
         document.getElementById('kpiDescripcion').textContent = 'No se pudieron obtener los datos del KPI';
       }
     }

     // Función para animar contadores con efecto de desaceleración
     function animarContador(elementId, valorFinal, duracion = 4, sufijo = '') {
       const elemento = document.getElementById(elementId);
       const valorInicial = 0;
       const startTime = Date.now();
       
       function animar() {
         const elapsed = (Date.now() - startTime) / 1000; // tiempo transcurrido en segundos
         const progress = Math.min(elapsed / duracion, 1); // progreso de 0 a 1
         
         // Función de easing para desaceleración suave (ease-out)
         const easeOut = 1 - Math.pow(1 - progress, 3);
         
         const valorActual = valorInicial + (valorFinal - valorInicial) * easeOut;
         
         elemento.textContent = valorActual.toFixed(2) + sufijo;
         
         if (progress < 1) {
           requestAnimationFrame(animar);
         } else {
           // Asegurar que termine exactamente en el valor final
           elemento.textContent = valorFinal.toFixed(2) + sufijo;
         }
       }
       
       requestAnimationFrame(animar);
     }

     // Función para animar contadores enteros (sin decimales)
     function animarContadorEntero(elementId, valorFinal, duracion = 4, sufijo = '') {
       const elemento = document.getElementById(elementId);
       const valorInicial = 0;
       const startTime = Date.now();
       
       function animar() {
         const elapsed = (Date.now() - startTime) / 1000; // tiempo transcurrido en segundos
         const progress = Math.min(elapsed / duracion, 1); // progreso de 0 a 1
         
         // Función de easing para desaceleración suave (ease-out)
         const easeOut = 1 - Math.pow(1 - progress, 3);
         
         const valorActual = valorInicial + (valorFinal - valorInicial) * easeOut;
         
         elemento.textContent = Math.round(valorActual) + sufijo;
         
         if (progress < 1) {
           requestAnimationFrame(animar);
         } else {
           // Asegurar que termine exactamente en el valor final
           elemento.textContent = Math.round(valorFinal) + sufijo;
         }
       }
       
       requestAnimationFrame(animar);
     }

     // Función para actualizar el estado del nivel
     function actualizarEstadoNivel(nivel, claseNivel, icono, texto) {
       const estadoNivel = document.getElementById('kpiEstadoNivel');
       const badgeNivel = document.getElementById('kpiBadgeNivel');
       const iconoNivel = document.getElementById('kpiIconoNivel');
       const textoNivel = document.getElementById('kpiTextoNivel');
       
       // Limpiar clases anteriores
       estadoNivel.className = 'text-center mt-2';
       badgeNivel.className = 'badge fs-6 px-3 py-2';
       
       // Aplicar nueva clase
       estadoNivel.classList.add(claseNivel);
       
       // Actualizar contenido
       iconoNivel.className = `bi ${icono} me-1`;
       textoNivel.textContent = texto;
       
       // Mostrar con animación
       estadoNivel.style.display = 'block';
       estadoNivel.style.opacity = '0';
       estadoNivel.style.transition = 'opacity 0.5s ease-in-out';
       
       setTimeout(() => {
         estadoNivel.style.opacity = '1';
       }, 100);
     }

     // Función para actualizar el indicador visual de nivel
     function actualizarIndicadorNivel(nivel) {
       const niveles = document.querySelectorAll('.kpi-level');
       niveles.forEach((nivelElemento, index) => {
         nivelElemento.classList.remove('active', 'critical');
         
         if (index < nivel) {
           nivelElemento.classList.add('active');
         }
       });
     }

     // Event listener para el botón de actualizar
     document.getElementById('btnActualizarKPITiempo').addEventListener('click', () => {
       // Remover animaciones previas
       document.getElementById('kpiMediana').classList.remove('counter-animate');
       document.getElementById('kpiP90').classList.remove('counter-animate');
       document.getElementById('kpiTotalEventos').classList.remove('counter-animate');
       document.getElementById('kpiClasificacion').classList.remove('counter-animate');
       
       // Recargar datos
       cargarKPITiempoRespuesta();
     });

     // Función para cargar el KPI de tasa de fallas
     async function cargarKPITasaFallas() {
       try {
         const resp = await fetch('/api/kpis/tasa-fallas');
         if (!resp.ok) throw new Error('Error al obtener datos del KPI');
         const data = await resp.json();

         // Verificar si hay datos insuficientes
         if (data.insuficienteDatos) {
           // Mostrar mensaje de datos insuficientes
           document.getElementById('kpiTasaFallas').textContent = 'N/A';
           document.getElementById('kpiTotalIntentosFallas').textContent = Math.round(data.totalIntentos);
           document.getElementById('kpiIntentosConFallas').textContent = Math.round(data.intentosConFalla);
           document.getElementById('kpiIntentosSinFallas').textContent = Math.round(data.intentosSinFalla);
           document.getElementById('kpiClasificacionFallas').textContent = data.clasificacion;
           document.getElementById('kpiDescripcionFallas').textContent = data.descripcion;
           document.getElementById('kpiNivelFallas').textContent = '0/5';
           document.getElementById('kpiProgresoFallas').style.width = '0%';
           
           // Aplicar estilo de datos insuficientes
           const kpiCard = document.querySelector('#panel-kpis .row:nth-child(3) .card');
           if (kpiCard) {
             kpiCard.classList.add('insuficiente-datos');
           }
           
           // Ocultar indicador visual y estado del nivel
           document.getElementById('kpiIndicadorFallas').style.display = 'none';
           document.getElementById('kpiEstadoNivelFallas').style.display = 'none';
           
           return;
         }

         // Remover estilo de datos insuficientes si existe
         const kpiCard = document.querySelector('#panel-kpis .row:nth-child(3) .card');
         if (kpiCard) {
           kpiCard.classList.remove('insuficiente-datos');
         }

         // Animar el contador principal (más lento)
         animarContador('kpiTasaFallas', data.tasaFallas, 4);
         
         // Animar métricas secundarias con delay escalonado
         setTimeout(() => {
           animarContadorEntero('kpiTotalIntentosFallas', data.totalIntentos, 3, '');
         }, 500);
         
         setTimeout(() => {
           animarContadorEntero('kpiIntentosConFallas', data.intentosConFalla, 3, '');
         }, 1000);
         
         setTimeout(() => {
           animarContadorEntero('kpiIntentosSinFallas', data.intentosSinFalla, 3, '');
         }, 1500);
         
         // Actualizar clasificación con animación
         setTimeout(() => {
           document.getElementById('kpiClasificacionFallas').textContent = data.clasificacion;
           document.getElementById('kpiDescripcionFallas').textContent = data.descripcion;
           document.getElementById('kpiClasificacionFallas').style.opacity = '0';
           document.getElementById('kpiDescripcionFallas').style.opacity = '0';
           document.getElementById('kpiClasificacionFallas').style.transition = 'opacity 1s ease-in-out';
           document.getElementById('kpiDescripcionFallas').style.transition = 'opacity 1s ease-in-out';
           
           setTimeout(() => {
             document.getElementById('kpiClasificacionFallas').style.opacity = '1';
             document.getElementById('kpiDescripcionFallas').style.opacity = '1';
           }, 100);
         }, 3000);
         
         // Actualizar nivel y progreso
         const nivel = data.nivel;
         let porcentaje;
         
         // Configurar barra de progreso y estado del nivel
         porcentaje = (nivel / 5) * 100;
         document.getElementById('kpiProgresoFallas').className = 'progress-bar';
         
         // Determinar clase y texto según el nivel
         let claseNivel, icono, texto;
         if (nivel === 1) {
           claseNivel = 'nivel1';
           icono = 'bi-exclamation-triangle';
           texto = 'Presas del Phishing';
         } else if (nivel === 2) {
           claseNivel = 'normal';
           icono = 'bi-info-circle';
           texto = 'Aprendices de Seguridad';
         } else if (nivel === 3) {
           claseNivel = 'normal';
           icono = 'bi-shield-check';
           texto = 'Defensores Digitales';
         } else if (nivel === 4) {
           claseNivel = 'alto';
           icono = 'bi-shield-fill-check';
           texto = 'Guardianes Anti-Phishing';
         } else if (nivel === 5) {
           claseNivel = 'alto';
           icono = 'bi-award';
           texto = 'Vigilantes del Ciberespacio';
         } else {
           claseNivel = 'normal';
           icono = 'bi-question-circle';
           texto = 'Nivel Desconocido';
         }
         
         actualizarEstadoNivelFallas(nivel, claseNivel, icono, texto);
         
         // Animar la barra de progreso
         setTimeout(() => {
           document.getElementById('kpiProgresoFallas').style.width = `${porcentaje}%`;
         }, 2000);
         
         document.getElementById('kpiNivelFallas').textContent = `${nivel}/5`;
         
         // Mostrar indicador visual
         document.getElementById('kpiIndicadorFallas').style.display = 'flex';
         
         // Actualizar indicador visual con delay
         setTimeout(() => {
           console.log('Llamando actualizarIndicadorNivelFallas con nivel:', nivel);
           actualizarIndicadorNivelFallas(nivel);
         }, 2500);
         
         // Aplicar animaciones
         document.getElementById('kpiTotalIntentosFallas').classList.add('counter-animate');
         document.getElementById('kpiIntentosConFallas').classList.add('counter-animate');
         document.getElementById('kpiIntentosSinFallas').classList.add('counter-animate');
         document.getElementById('kpiClasificacionFallas').classList.add('counter-animate');
         
       } catch (e) {
         console.error('Error cargando KPI de tasa de fallas:', e);
         document.getElementById('kpiTasaFallas').textContent = 'Error';
         document.getElementById('kpiClasificacionFallas').textContent = 'Error al cargar';
         document.getElementById('kpiDescripcionFallas').textContent = 'No se pudieron obtener los datos del KPI';
       }
     }

     // Función para actualizar el estado del nivel de tasa de fallas
     function actualizarEstadoNivelFallas(nivel, claseNivel, icono, texto) {
       const estadoNivel = document.getElementById('kpiEstadoNivelFallas');
       const badgeNivel = document.getElementById('kpiBadgeNivelFallas');
       const iconoNivel = document.getElementById('kpiIconoNivelFallas');
       const textoNivel = document.getElementById('kpiTextoNivelFallas');
       
       // Limpiar clases anteriores
       estadoNivel.className = 'text-center mt-2';
       badgeNivel.className = 'badge fs-6 px-3 py-2';
       
       // Aplicar nueva clase
       estadoNivel.classList.add(claseNivel);
       
       // Actualizar contenido
       iconoNivel.className = `bi ${icono} me-1`;
       textoNivel.textContent = texto;
       
       // Mostrar con animación
       estadoNivel.style.display = 'block';
       estadoNivel.style.opacity = '0';
       estadoNivel.style.transition = 'opacity 0.5s ease-in-out';
       
       setTimeout(() => {
         estadoNivel.style.opacity = '1';
       }, 100);
     }

     // Función para actualizar el indicador visual de nivel de tasa de fallas
     function actualizarIndicadorNivelFallas(nivel) {
       const niveles = document.querySelectorAll('#kpiIndicadorFallas .kpi-level');
       console.log('Actualizando indicador de tasa de fallas, nivel:', nivel, 'elementos encontrados:', niveles.length);
       
       niveles.forEach((nivelElemento, index) => {
         nivelElemento.classList.remove('active', 'critical');
         
         if (index < nivel) {
           nivelElemento.classList.add('active');
           console.log('Activando nivel', index + 1, 'para nivel', nivel);
         }
       });
     }

     // Event listener para el botón de actualizar tasa de fallas
     document.getElementById('btnActualizarKPIFallas').addEventListener('click', () => {
       // Remover animaciones previas
       document.getElementById('kpiTotalIntentosFallas').classList.remove('counter-animate');
       document.getElementById('kpiIntentosConFallas').classList.remove('counter-animate');
       document.getElementById('kpiIntentosSinFallas').classList.remove('counter-animate');
       document.getElementById('kpiClasificacionFallas').classList.remove('counter-animate');
       
       // Recargar datos
       cargarKPITasaFallas();
     });
  </script>

</body>
</html>