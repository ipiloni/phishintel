<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Generar Llamada - PhishIntel</title>

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Raleway&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="assets/css/main.css" rel="stylesheet">
</head>
<style>
/* Personalizar los radios */

/* Cuando está seleccionado → círculo rosa */
.custom-radio:checked {
  background-color: #da02e5; /* rosa */
  border-color: #da02e5;
}

/* Para navegadores que usan -webkit-appearance */
.custom-radio[type="radio"] {
  accent-color: #da02e5; /* Soporta Chrome/Edge/Firefox modernos */
}

/* Estilos para selectores deshabilitados */
select:disabled {
  background-color: #3d3d3d !important;
  color: #6c757d !important;
  cursor: not-allowed !important;
  opacity: 0.7;
}

select:disabled option {
  color: #6c757d !important;
  background-color: #3d3d3d !important;
}

/* Estilos para el modal de grabación */
.recording-modal .modal-content {
  background-color: #1a1a1a !important;
  color: #eaeaea !important;
  border: 1px solid #da02e5;
}

.recording-modal .modal-header {
  background-color: #111 !important;
  border-bottom: 1px solid #da02e5;
}

.recording-modal .modal-title {
  color: white !important;
}

.recording-modal .modal-body {
  color: #e0e0e0;
}

.recording-modal .modal-footer {
  background-color: #111 !important;
  border-top: 1px solid #da02e5;
}

.recording-controls {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
}

.recording-button {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  border: none;
  font-size: 24px;
  transition: all 0.3s ease;
  cursor: pointer;
}

.recording-button.record {
  background-color: #da02e5;
  color: white;
}

.recording-button.stop {
  background-color: #dc3545;
  color: white;
}

.recording-button:hover {
  transform: scale(1.1);
}

.recording-timer {
  font-size: 24px;
  font-weight: bold;
  color: #da02e5;
}

.recording-visualizer {
  width: 200px;
  height: 50px;
  background-color: #2d2d2d;
  border-radius: 25px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
}

.recording-wave {
  width: 4px;
  height: 20px;
  background-color: #da02e5;
  margin: 0 2px;
  border-radius: 2px;
  animation: wave 1s ease-in-out infinite;
}

.recording-wave:nth-child(2) { animation-delay: 0.1s; }
.recording-wave:nth-child(3) { animation-delay: 0.2s; }
.recording-wave:nth-child(4) { animation-delay: 0.3s; }
.recording-wave:nth-child(5) { animation-delay: 0.4s; }

@keyframes wave {
  0%, 100% { height: 20px; }
  50% { height: 40px; }
}

.consent-checkbox {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  margin: 20px 0;
}

.consent-checkbox input[type="checkbox"] {
  accent-color: #da02e5;
  margin-top: 2px;
}

.consent-text {
  font-size: 14px;
  line-height: 1.5;
  color: #ccc;
}

.audio-preview {
  width: 100%;
  margin: 20px 0;
}

.audio-preview audio {
  width: 100%;
  background-color: #2d2d2d;
  border-radius: 8px;
}

/* Mejorar la visualización de las historias */
.historia-sugerida {
  background: linear-gradient(135deg, #2d2d2d, #3d3d3d);
  border: 2px solid #da02e5;
  border-radius: 12px;
  padding: 20px;
  margin: 15px 0;
  position: relative;
  overflow: hidden;
}

.historia-sugerida::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, #da02e5, #ff6b9d);
}

.historia-sugerida h6 {
  color: white !important;
  font-weight: 600;
  margin-bottom: 10px;
}

.historia-sugerida p {
  font-size: 16px;
  line-height: 1.5;
  margin-bottom: 10px;
  color: #e0e0e0;
}

.historia-sugerida small a {
  color: #da02e5;
  text-decoration: none;
  transition: color 0.3s ease;
}

.historia-sugerida small a:hover {
  color: #ff6b9d;
}

/* Mejorar el botón de grabación */
.recording-button {
  box-shadow: 0 8px 25px rgba(218, 2, 229, 0.3);
  border: 3px solid rgba(218, 2, 229, 0.2);
}

.recording-button:hover {
  box-shadow: 0 12px 35px rgba(218, 2, 229, 0.5);
  border-color: rgba(218, 2, 229, 0.4);
}

.recording-button.stop {
  box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
  border-color: rgba(220, 53, 69, 0.2);
}

.recording-button.stop:hover {
  box-shadow: 0 12px 35px rgba(220, 53, 69, 0.5);
  border-color: rgba(220, 53, 69, 0.4);
}

/* Estilos para el modal de ejemplo de llamada */
.call-example-modal .modal-content {
  background-color: #1a1a1a !important;
  color: #eaeaea !important;
  border: 1px solid #da02e5;
}

.call-example-modal .modal-header {
  background-color: #111 !important;
  border-bottom: 1px solid #da02e5;
}

.call-example-modal .modal-title {
  color: white !important;
}

.call-example-modal .modal-body {
  color: #e0e0e0;
  padding: 0;
}

.call-example-modal .modal-footer {
  background-color: #111 !important;
  border-top: 1px solid #da02e5;
}

.conversation-container {
  height: 500px;
  overflow-y: auto;
  padding: 20px;
  background-color: #1a1a1a;
}

.conversation-container::-webkit-scrollbar {
  width: 8px;
}

.conversation-container::-webkit-scrollbar-track {
  background: #2d2d2d;
  border-radius: 4px;
}

.conversation-container::-webkit-scrollbar-thumb {
  background: #da02e5;
  border-radius: 4px;
}

.conversation-container::-webkit-scrollbar-thumb:hover {
  background: #ff6b9d;
}

.message {
  display: flex;
  margin-bottom: 20px;
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message.ai {
  justify-content: flex-start;
}

.message.recipient {
  justify-content: flex-end;
}

.message-content {
  max-width: 70%;
  padding: 12px 16px;
  border-radius: 12px;
  position: relative;
  word-wrap: break-word;
}

.message.ai .message-content {
  background: linear-gradient(135deg, #2d2d2d, #3d3d3d);
  border: 1px solid #da02e5;
  border-left: 4px solid #da02e5;
}

.message.recipient .message-content {
  background: linear-gradient(135deg, #3d3d3d, #4d4d4d);
  border: 1px solid #6c757d;
  border-right: 4px solid #6c757d;
}

.message-label {
  font-size: 11px;
  font-weight: 600;
  margin-bottom: 5px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.message.ai .message-label {
  color: #da02e5;
  font-weight: 700;
}

.message.recipient .message-label {
  color: #e0e0e0;
  font-weight: 700;
}

.message-text {
  color: #e0e0e0;
  font-size: 14px;
  line-height: 1.5;
  margin: 0;
}
</style>
<body class="index-page">

  <!-- ======= Header ======= -->
  <header id="header" class="header d-flex align-items-center fixed-top">
    <div class="container position-relative d-flex align-items-center justify-content-between">
      <a href="/" class="logo d-flex align-items-center me-auto me-xl-0">
        <h1 class="sitename">PhishIntel</h1>
      </a>

      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="/principal" class="btn-getstarted btn-login">Home</a></li>
          <li><a href="/selectorCampania" class="btn-getstarted btn-login">Volver al Panel</a></li>
        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
      </nav>
    </div>
  </header>
  <!-- End Header -->

  <main class="main">

    <!-- Page Title -->
    <div class="page-title py-5"></div>

    <!-- Formulario con Vue -->
    <section id="llamada" class="contact section">
      <div class="col-lg-8 mx-auto" data-aos="fade-left" data-aos-delay="200">
        <!-- Vue App -->
        <div id="app" class="contact-form-wrapper">
          <div class="form-header">
            <h3>Generación de Simulación de Llamada</h3>
            <p>Esta simulación llamará al usuario destinatario y se hará pasar por el remitente seleccionado.</p>
          </div>

          <form class="php-email-form" @submit.prevent="generarPreview">

            <!-- Selector de Área y Usuario Destinatario -->
            <div class="mb-3">
              <div class="row g-2">
                <div class="col-6">
                  <label for="areaSelect" class="form-label">Seleccione el área del destinatario</label>
                  <select v-model="filtroArea" class="form-control" id="areaSelect" name="area" required>
                    <option value="" disabled>-- Selecciona un área --</option>
                    <option v-for="area in areas" :key="area.idArea" :value="area.nombreArea">
                      {{ area.nombreArea }} 
                    </option>
                  </select>
                </div>
                <div class="col-6">
                  <label for="userSelect" class="form-label">Seleccionar usuario destinatario</label>
                  <select v-model="filtroUsuario" class="form-control" id="userSelect" name="usuario" :disabled="!filtroArea" required>
                    <option value="" disabled>{{ filtroArea ? '-- Selecciona un usuario --' : '-- Selecciona un área primero --' }}</option>
                    <option v-for="usuario in usuariosFiltrados" :key="usuario.idUsuario" :value="usuario">
                      {{ usuario.nombre }} {{ usuario.apellido }}
                    </option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Selector de Área y Usuario Remitente -->
            <div class="mb-3">
              <div class="row g-2">
                <div class="col-6">
                  <label for="areaRemitenteSelect" class="form-label">Seleccione el área del remitente</label>
                  <select v-model="filtroAreaRemitente" class="form-control" id="areaRemitenteSelect" name="areaRemitente" required>
                    <option value="" disabled>-- Selecciona un área --</option>
                    <option v-for="area in areas" :key="area.idArea" :value="area.nombreArea">
                      {{ area.nombreArea }} 
                    </option>
                  </select>
                </div>
                <div class="col-6">
                  <label for="usuarioRemitenteSelect" class="form-label">Seleccionar usuario remitente</label>
                  <select v-model="filtroUsuarioRemitente" class="form-control" id="usuarioRemitenteSelect" name="usuarioRemitente" :disabled="!filtroAreaRemitente" required>
                    <option value="" disabled>{{ filtroAreaRemitente ? '-- Selecciona un usuario --' : '-- Selecciona un área primero --' }}</option>
                    <option v-for="usuario in usuariosRemitentesFiltrados" :key="usuario.idUsuario" :value="usuario">
                      {{ usuario.nombre }} {{ usuario.apellido }}
                    </option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Configuración de Voz del Remitente -->
            <div class="mb-4" :style="{ opacity: filtroUsuarioRemitente ? '1' : '0.5', pointerEvents: filtroUsuarioRemitente ? 'auto' : 'none' }">
              <label class="form-label mb-3">Configuración de Voz</label>
              
              <div v-if="!filtroUsuarioRemitente" class="alert alert-info text-center mb-3 mx-auto w-auto" style="background-color: #3d3d3d; border-color: #6c757d; color: #6c757d; max-width: 60%;">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Selecciona un usuario remitente primero</strong>
              </div>
              
              <div v-if="filtroUsuarioRemitente && !tieneVozConfigurada" class="alert alert-info text-center mb-3 mx-auto w-auto" style="background-color: #3d3d3d; border-color: #6c757d; color: #6c757d; max-width: 60%;">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>Voz no configurada</strong> - El usuario no tiene una voz clonada. Graba una voz para continuar.
              </div>
              
              <div v-if="filtroUsuarioRemitente && tieneVozConfigurada" class="alert alert-success text-center mb-3 mx-auto w-auto" style="background-color: #2d2d2d; border-color: var(--accent-color); color: var(--accent-color); max-width: 60%;">
                <i class="bi bi-check-circle-fill me-2"></i>
                <strong>✓ Voz configurada</strong> - El usuario ya tiene una voz clonada disponible
              </div>

              <div class="text-center">
                <!-- Botón Grabar Nueva Voz -->
                <button type="button" class="btn px-4 py-2 rounded-pill me-3"
                        :style="filtroUsuarioRemitente ? 
                          { backgroundColor: 'var(--accent-color)', color: 'white', border: 'none' } : 
                          { backgroundColor: '#6c757d', color: 'white', border: 'none', cursor: 'not-allowed' }"
                        :disabled="!filtroUsuarioRemitente"
                        @click="abrirModalGrabacion">
                  <i class="bi bi-mic"></i>
                  {{ tieneVozConfigurada ? ' Grabar Nueva Voz' : ' Grabar Voz' }}
                </button>
                <!-- Botón Probar Voz -->
                <button type="button" class="btn px-4 py-2 rounded-pill" 
                        :style="(tieneVozConfigurada && filtroUsuarioRemitente) ? 
                          { backgroundColor: 'var(--accent-color)', color: 'white', border: 'none' } : 
                          { backgroundColor: '#6c757d', color: 'white', border: 'none', cursor: 'not-allowed' }"
                        :disabled="!tieneVozConfigurada || !filtroUsuarioRemitente"
                        @click="abrirModalProbarVoz">
                  <i class="bi bi-play-circle"></i> Probar Voz
                </button>
                
                <p class="mt-2 text-muted" style="color: #ccc !important;">
                  <small v-if="!filtroUsuarioRemitente">Selecciona un usuario remitente para configurar la voz</small>
                  <small v-else-if="tieneVozConfigurada">Prueba la voz o graba una nueva si desea</small>
                  <small v-else>Graba una historia de 30 segundos a 1 minuto para clonar tu voz</small>
                </p>
              </div>
            </div>

            <!-- Objetivo de la llamada -->
            <div class="mb-4">
              <label class="form-label mb-3">Objetivo de la llamada</label>
              <div class="row g-2">
                <div class="col-md-4">
                  <div class="card bloque bloque-normal"
                       @click="objetivoEspecifico = 'Abra un link que se le enviara por'"
                       :style="objetivoEspecifico === 'Abra un link que se le enviara por' ? 'border-color: var(--accent-color);' : ''">
                    <div class="card-body text-center p-1">
                      <div style="font-size: 1em;"><i class="bi bi-link-45deg"></i></div>
                      <h6 class="card-title mb-0" style="font-size: 0.8em;">Abrir un link</h6>
                      <small class="card-text" style="font-size: 0.7em;">Enlace directo</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card bloque bloque-normal"
                       @click="objetivoEspecifico = 'Abra un link para ingresar sus credenciales que se le enviara por'"
                       :style="objetivoEspecifico === 'Abra un link para ingresar sus credenciales que se le enviara por' ? 'border-color: var(--accent-color);' : ''">
                    <div class="card-body text-center p-1">
                      <div style="font-size: 1em;"><i class="bi bi-key-fill"></i></div>
                      <h6 class="card-title mb-0" style="font-size: 0.8em;">Cargar credenciales</h6>
                      <small class="card-text" style="font-size: 0.7em;">Login y contraseña</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card bloque bloque-normal"
                       @click="objetivoEspecifico = 'Abra un link para actualizar sus datos que se le enviara por'"
                       :style="objetivoEspecifico === 'Abra un link para actualizar sus datos que se le enviara por' ? 'border-color: var(--accent-color);' : ''">
                    <div class="card-body text-center p-1">
                      <div style="font-size: 1em;"><i class="bi bi-person-badge"></i></div>
                      <h6 class="card-title mb-0" style="font-size: 0.8em;">Actualizar tus datos</h6>
                      <small class="card-text" style="font-size: 0.7em;">Información personal</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Evento desencadenador -->
            <div class="mb-4">
              <label class="form-label mb-3">Evento desencadenador</label>
              <div class="row g-2">
                <div class="col-md-4">
                  <div class="card bloque bloque-normal"
                       @click="eventoDesencadenador = 'Correo'"
                       :style="eventoDesencadenador === 'Correo' ? 'border-color: var(--accent-color);' : ''">
                    <div class="card-body text-center p-1">
                      <div style="font-size: 1em;"><i class="bi bi-envelope"></i></div>
                      <h6 class="card-title mb-0" style="font-size: 0.8em;">Correo</h6>
                      <small class="card-text" style="font-size: 0.7em;">Email electrónico</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card bloque bloque-normal"
                       @click="eventoDesencadenador = 'Whatsapp'"
                       :style="eventoDesencadenador === 'Whatsapp' ? 'border-color: var(--accent-color);' : ''">
                    <div class="card-body text-center p-1">
                      <div style="font-size: 1em;"><i class="bi bi-whatsapp"></i></div>
                      <h6 class="card-title mb-0" style="font-size: 0.8em;">WhatsApp</h6>
                      <small class="card-text" style="font-size: 0.7em;">Mensajería popular</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card bloque bloque-normal"
                       @click="eventoDesencadenador = 'SMS'"
                       :style="eventoDesencadenador === 'SMS' ? 'border-color: var(--accent-color);' : ''">
                    <div class="card-body text-center p-1">
                      <div style="font-size: 1em;"><i class="bi bi-send"></i></div>
                      <h6 class="card-title mb-0" style="font-size: 0.8em;">SMS</h6>
                      <small class="card-text" style="font-size: 0.7em;">Mensaje de texto</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Rol a imitar -->
            <div class="mb-3">
              <label for="rolAImitar" class="form-label">Rol a imitar</label>
              <select v-model="rolAImitar" class="form-control" id="rolAImitar" name="rolAImitar" required>
                <option value="Jefe">Jefe</option>
                <option value="Compañero de area">Compañero de area</option>
              </select>
            </div>

            <!-- Modo de llamada y botones -->
            <div class="text-center mb-3">
              <div class="d-flex align-items-center justify-content-center gap-3 mb-3">
                <label class="form-label mb-0" style="color: #e0e0e0;">Modo:</label>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="modoSimulado" v-model="modoSimulado" 
                         style="width: 50px; height: 25px; cursor: pointer;">
                  <label class="form-check-label ms-2" for="modoSimulado" style="color: #e0e0e0;">
                    {{ modoSimulado ? 'Simulado' : 'Real' }}
                  </label>
                </div>
              </div>
              <button type="submit" class="btn btn-primary px-4 py-2 rounded-pill me-2" :disabled="cargando">
                <span v-if="cargando">
                  <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                  Generando...
                </span>
                <span v-else>
                  <i class="bi bi-telephone"></i> Generar Llamada
                </span>
              </button>
            </div>
          </form>

          <!-- Modal de Grabación de Audio -->
          <div class="modal fade recording-modal" id="recordingModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">
                    <i class="bi bi-mic me-2"></i>Grabación de Voz para Clonación
                  </h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <!-- Consentimiento -->
                  <div class="historia-sugerida">
                    <h6><i class="bi bi-shield-check me-2"></i>Consentimiento:</h6>
                    <div class="consent-checkbox">
                      <input type="checkbox" id="consent" v-model="consentimiento" required>
                      <label for="consent" class="consent-text">
                        <strong>Autorizo</strong> que mi voz sea grabada y utilizada para generar una voz clonada con fines de seguridad y simulación de phishing. Entiendo que esta grabación será utilizada únicamente para propósitos de entrenamiento y concienciación en seguridad.
                      </label>
                    </div>
                  </div>

                   <!-- Historia sugerida -->
                   <div class="historia-sugerida">
                     <h6><i class="bi bi-lightbulb me-2"></i>Historia sugerida:</h6>
                     <p class="mb-2 fw-bold">{{ historiaSeleccionada }}</p>
                     <small class="text-muted">
                       <i class="bi bi-arrow-clockwise me-1"></i>
                       <a href="#" @click.prevent="seleccionarNuevaHistoria">Cambiar historia</a>
                     </small>
                   </div>

                   <!-- Instrucciones -->
                   <div class="alert alert-info" style="background-color: #2d2d2d; border-color: #da02e5; color: #e0e0e0;">
                     <h6><i class="bi bi-info-circle me-2"></i>Instrucciones:</h6>
                     <ul class="mb-0">
                       <li>Responde a la historia sugerida de manera natural</li>
                       <li>Habla de manera clara y con volumen normal</li>
                       <li>El audio se graba sin procesamiento (crudo)</li>
                       <li>Mínimo 30 segundos, máximo 1 minuto de grabación</li>
                       <li>La grabación se detendrá automáticamente</li>
                     </ul>
                   </div>

                  <!-- Controles de grabación -->
                  <div class="recording-controls" v-if="consentimiento">
                    <!-- Timer -->
                    <div class="recording-timer" v-if="grabando || tiempoGrabacion > 0">
                      {{ formatearTiempo(tiempoGrabacion) }}
                    </div>

                    <!-- Visualizador de audio -->
                    <div class="recording-visualizer" v-if="grabando">
                      <div class="recording-wave"></div>
                      <div class="recording-wave"></div>
                      <div class="recording-wave"></div>
                      <div class="recording-wave"></div>
                      <div class="recording-wave"></div>
                    </div>

                    <!-- Botón de grabación -->
                    <button 
                      type="button" 
                      class="recording-button"
                      :class="grabando ? 'stop' : 'record'"
                      @click="toggleGrabacion"
                      :disabled="!consentimiento"
                    >
                      <i :class="grabando ? 'bi bi-stop-fill' : 'bi bi-mic-fill'"></i>
                    </button>

                    <!-- Estado de grabación -->
                    <div v-if="grabando" class="text-center">
                      <p class="text-danger mb-0">
                        <i class="bi bi-record-circle me-1"></i>
                        Grabando... Habla ahora
                      </p>
                    </div>

                    <!-- Preview del audio -->
                    <div v-if="audioGrabado" class="audio-preview">
                      <h6 class="mb-2">Vista previa del audio:</h6>
                      <audio :src="audioGrabado" controls></audio>
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  
                  <!-- Botón Guardar Audio -->
                  <button 
                    type="button" 
                    class="btn px-4 py-2 rounded-pill" 
                    :style="{ backgroundColor: 'var(--accent-color)', color: 'white', border: 'none' }"
                    @click="guardarAudio"
                    :disabled="!audioGrabado || cargandoAudio"
                    v-if="!mostrarBotonClonar"
                  >
                    <span v-if="cargandoAudio">
                      <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                      Guardando...
                    </span>
                    <span v-else>
                      <i class="bi bi-save me-2"></i>Guardar Audio
                    </span>
                  </button>

                  <!-- Botón Clonar Voz (aparece después de guardar) -->
                  <button 
                    type="button" 
                    class="btn px-4 py-2 rounded-pill" 
                    :style="{ backgroundColor: 'var(--accent-color)', color: 'white', border: 'none' }"
                    @click="clonarVoz"
                    :disabled="cargandoClonar"
                    v-if="mostrarBotonClonar"
                  >
                    <span v-if="cargandoClonar">
                      <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                      Clonando...
                    </span>
                    <span v-else>
                      <i class="bi bi-magic me-2"></i>Clonar Voz
                    </span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Modal de Probar Voz -->
          <div class="modal fade recording-modal" id="testVoiceModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">
                    <i class="bi bi-play-circle me-2"> </i>Probar Voz Clonada
                  </h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <!-- Texto a reproducir -->
                  <div class="mb-4">
                    <label for="textoProbarVoz" class="form-label">Texto a reproducir</label>
                    <textarea 
                      v-model="textoProbarVoz" 
                      class="form-control" 
                      id="textoProbarVoz" 
                      rows="4" 
                      placeholder="Escribe el texto que quieres convertir a voz"
                      style="background-color: #2d2d2d; color: #e0e0e0; border: 1px solid #da02e5;">
                    </textarea>
                  </div>

                  <!-- Reproductor de audio -->
                  <div v-if="audioGenerado" class="audio-preview mb-3">
                    <h6 class="mb-2">Audio generado:</h6>
                    <audio :src="audioGenerado" controls style="width: 100%; background-color: #2d2d2d; border-radius: 8px;"></audio>
                  </div>

                  <!-- Instrucciones -->
                  <div class="alert alert-info" style="background-color: #2d2d2d; border-color: #da02e5; color: #e0e0e0;">
                    <h6><i class="bi bi-info-circle me-2"></i>Instrucciones:</h6>
                    <ul class="mb-0">
                      <li>Escribe el texto que quieres convertir a voz</li>
                      <li>Haz clic en "Reproducir" para generar el audio</li>
                      <li>El audio se reproducirá automáticamente</li>
                      <li>Puedes editar el texto y generar un nuevo audio</li>
                    </ul>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                  <button 
                    type="button" 
                    class="btn px-4 py-2 rounded-pill" 
                    :style="{ backgroundColor: 'var(--accent-color)', color: 'white', border: 'none' }"
                    @click="probarVoz"
                    :disabled="cargandoTTS || !textoProbarVoz.trim()"
                  >
                    <span v-if="cargandoTTS">
                      <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                      Generando...
                    </span>
                    <span v-else>
                      <i class="bi bi-play-fill me-2"></i>Reproducir
                    </span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Modal Preview -->
          <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
              <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                  <h5 class="modal-title">Vista previa de la llamada</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-4">
                    <h6 class="mb-3" style="color: white;">
                      <i class="bi bi-gear-fill me-2"></i>Opciones Elegidas
                    </h6>
                    
                    <div class="row g-3">
                      <!-- Área Destinatario -->
                      <div class="col-md-6">
                        <div class="d-flex align-items-center p-2 rounded" style="background-color: #2d2d2d; color: white;">
                          <span class="me-2"><i class="bi bi-building"></i></span>
                          <div>
                            <small class="d-block" style="color: #ccc;">Área Destinatario</small>
                            <strong>{{ filtroArea }}</strong>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Usuario Destinatario -->
                      <div class="col-md-6">
                        <div class="d-flex align-items-center p-2 rounded" style="background-color: #2d2d2d; color: white;">
                          <span class="me-2"><i class="bi bi-person-fill"></i></span>
                          <div>
                            <small class="d-block" style="color: #ccc;">Usuario Destinatario</small>
                            <strong v-if="filtroUsuario">{{ filtroUsuario.nombre }} {{ filtroUsuario.apellido }}</strong>
                            <strong v-else>—</strong>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Área Remitente -->
                      <div class="col-md-6">
                        <div class="d-flex align-items-center p-2 rounded" style="background-color: #2d2d2d; color: white;">
                          <span class="me-2"><i class="bi bi-building"></i></span>
                          <div>
                            <small class="d-block" style="color: #ccc;">Área Remitente</small>
                            <strong>{{ filtroAreaRemitente }}</strong>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Usuario Remitente -->
                      <div class="col-md-6">
                        <div class="d-flex align-items-center p-2 rounded" style="background-color: #2d2d2d; color: white;">
                          <span class="me-2"><i class="bi bi-person-check-fill"></i></span>
                          <div>
                            <small class="d-block" style="color: #ccc;">Usuario Remitente</small>
                            <strong v-if="filtroUsuarioRemitente">{{ filtroUsuarioRemitente.nombre }} {{ filtroUsuarioRemitente.apellido }}</strong>
                            <strong v-else>—</strong>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Rol a imitar -->
                      <div class="col-md-6">
                        <div class="d-flex align-items-center p-2 rounded" style="background-color: #2d2d2d; color: white;">
                          <span class="me-2"><i class="bi bi-person-badge"></i></span>
                          <div>
                            <small class="d-block" style="color: #ccc;">Rol a imitar</small>
                            <strong>{{ rolAImitar }}</strong>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Objetivo específico -->
                      <div class="col-md-6">
                        <div class="d-flex align-items-center p-2 rounded" style="background-color: #2d2d2d; color: white;">
                          <span class="me-2"><i class="bi bi-bullseye"></i></span>
                          <div>
                            <small class="d-block" style="color: #ccc;">Objetivo</small>
                            <strong>{{ objetivoEspecifico }} {{ eventoDesencadenador }}</strong>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Estado de voz -->
                      <div class="col-md-6">
                        <div class="d-flex align-items-center p-2 rounded" style="background-color: #2d2d2d; color: white;">
                          <span class="me-2"><i class="bi bi-mic"></i></span>
                          <div>
                            <small class="d-block" style="color: #ccc;">Estado de voz</small>
                            <strong v-if="tieneVozConfigurada || vozClonadaEnPreview" >Clonada</strong>
                            <strong v-else >Genérica </strong>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <hr class="my-4" style="border-color: #444;">
                  
                  <!-- Explicación -->
                  <div class="alert alert-info mb-3" style="background-color: #2d2d2d; border-color: #da02e5; color: #e0e0e0;">
                    <h6><i class="bi bi-info-circle me-2"></i>¿Cómo funciona?</h6>
                    <p class="mb-0" style="font-size: 14px;">
                      La llamada se generará en tiempo real usando inteligencia artificial. El sistema simulará una conversación donde el remitente <span v-if="filtroUsuarioRemitente">({{ filtroUsuarioRemitente.nombre }})</span> se hará pasar por un {{ rolAImitar }} e intentará que el destinatario {{ objetivoEspecifico ? objetivoEspecifico.toLowerCase() : '' }} {{ eventoDesencadenador ? eventoDesencadenador.toLowerCase() : '' }}. 
                      La conversación se adaptará dinámicamente según las respuestas del destinatario.
                    </p>
                  </div>

                  <!-- Opción para clonar voz si no está configurada -->
                  <div v-if="!tieneVozConfigurada && !vozClonadaEnPreview" class="alert mb-3" style= border-color:#ffffff;">
                    <h6><i class="bi bi-exclamation-triangle me-2"></i>Voz no configurada</h6>
                    <p class="mb-2" style="font-size: 14px;">
                      El usuario remitente no tiene una voz clonada. Se utilizará una voz predeterminada, o puedes clonar la voz ahora.
                    </p>
                    <button type="button" class="btn btn-sm" 
                            :style="{ backgroundColor: 'var(--accent-color)', color: 'white', border: 'none' }"
                            @click="abrirModalGrabacionDesdePreview">
                      <i class="bi bi-mic me-2"></i>Clonar Voz
                    </button>
                  </div>
                </div>
                <div class="modal-footer border-secondary">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="button" class="btn btn-primary" @click="confirmarLlamada" :disabled="cargandoLlamada">
                    <span v-if="cargandoLlamada">
                      <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                      Generando...
                    </span>
                    <span v-else>
                      <i class="bi bi-telephone me-2"></i>Generar Llamada
                    </span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Modal de Ejemplo de Llamada -->
          <div class="modal fade call-example-modal" id="exampleCallModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">
                    <i class="bi bi-telephone me-2"></i>Ejemplo de Llamada en Tiempo Real
                  </h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="conversation-container">
                    <!-- Mensaje IA -->
                    <div class="message ai">
                      <div class="message-content">
                        <div class="message-label">IA</div>
                        <p class="message-text">Hola, buenos días. ¿Habla con [Nombre del Destinatario]?</p>
                      </div>
                    </div>

                    <!-- Mensaje Destinatario -->
                    <div class="message recipient">
                      <div class="message-content">
                        <div class="message-label">Destinatario</div>
                        <p class="message-text">Sí, habla conmigo. ¿Quién es?</p>
                      </div>
                    </div>

                    <!-- Mensaje IA -->
                    <div class="message ai">
                      <div class="message-content">
                        <div class="message-label">IA</div>
                        <p class="message-text">Hola, soy [Nombre del Remitente] del área de [Área]. Te llamo porque necesitamos que actualices algunos datos importantes en el sistema.</p>
                      </div>
                    </div>

                    <!-- Mensaje Destinatario -->
                    <div class="message recipient">
                      <div class="message-content">
                        <div class="message-label">Destinatario</div>
                        <p class="message-text">Ah, claro. ¿Qué datos necesitan actualizar?</p>
                      </div>
                    </div>

                    <!-- Mensaje IA -->
                    <div class="message ai">
                      <div class="message-content">
                        <div class="message-label">IA</div>
                        <p class="message-text">Necesitamos que actualices tu información de contacto y credenciales. Te voy a enviar un link por [Correo/WhatsApp/SMS] para que puedas hacerlo de forma segura.</p>
                      </div>
                    </div>

                    <!-- Mensaje Destinatario -->
                    <div class="message recipient">
                      <div class="message-content">
                        <div class="message-label">Destinatario</div>
                        <p class="message-text">Perfecto, estaré atento al mensaje. ¿Hay algo más que necesite saber?</p>
                      </div>
                    </div>

                    <!-- Mensaje IA -->
                    <div class="message ai">
                      <div class="message-content">
                        <div class="message-label">IA</div>
                        <p class="message-text">No, eso es todo. Por favor, completa la actualización lo antes posible. Es importante para mantener la seguridad del sistema.</p>
                      </div>
                    </div>

                    <!-- Mensaje Destinatario -->
                    <div class="message recipient">
                      <div class="message-content">
                        <div class="message-label">Destinatario</div>
                        <p class="message-text">De acuerdo, lo haré en cuanto reciba el link. Gracias por avisar.</p>
                      </div>
                    </div>

                    <!-- Mensaje IA -->
                    <div class="message ai">
                      <div class="message-content">
                        <div class="message-label">IA</div>
                        <p class="message-text">Perfecto, gracias por tu colaboración. Que tengas un buen día.</p>
                      </div>
                    </div>

                    <!-- Mensaje Destinatario -->
                    <div class="message recipient">
                      <div class="message-content">
                        <div class="message-label">Destinatario</div>
                        <p class="message-text">Igualmente, hasta luego.</p>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Modal de Llamada en Progreso -->
          <div class="modal fade call-example-modal" id="callInProgressModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-lg modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">
                    <i class="bi bi-telephone me-2"></i>Llamada en Tiempo Real
                  </h5>
                  <button type="button" class="btn-close btn-close-white" @click="cerrarModalLlamada" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <!-- Indicador de estado -->
                  <br>
                  <div class="text-center mb-3" v-if="estadoLlamada">
                    <div class="d-inline-block p-3 rounded" 
                         style="background-color: #1a1a1a; border: 2px solid var(--accent-color); color: white;">
                      <i :class="getEstadoIcon(estadoLlamada.status)" class="me-2"></i>
                      <strong  >{{ getEstadoTexto(estadoLlamada.status) }}</strong>
                    </div>
                  </div>
                  
                  <div class="conversation-container" ref="conversationContainer">
                    <div v-for="(msg, index) in conversacionLlamada" :key="index" 
                         :class="['message', msg.rol === 'IA' ? 'ai' : 'recipient']">
                      <div class="message-content">
                        <div class="message-label">
                          <span v-if="msg.rol === 'IA'">
                            {{ filtroUsuarioRemitente ? `${filtroUsuarioRemitente.nombre} ${filtroUsuarioRemitente.apellido}` : 'IA' }} (IA)
                          </span>
                          <span v-else>
                            {{ filtroUsuario ? `${filtroUsuario.nombre} ${filtroUsuario.apellido}` : 'Destinatario' }} (Destinatario)
                          </span>
                        </div>
                        <p class="message-text">{{ msg.mensaje }}</p>
                      </div>
                    </div>
                    
                    <!-- Mensaje de llamada finalizada -->
                    <div v-if="estadoLlamada && estadoLlamada.status === 'completed'" class="text-center mt-4">
                      <div class="alert" style="background-color: #1a1a1a; border: 2px solid var(--accent-color); color: white;">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        <strong>Llamada finalizada</strong>
                      </div>
                    </div>
                    
                    <!-- Mensajes de error/cancelación -->
                    <div v-if="estadoLlamada && ['failed', 'busy', 'no-answer', 'canceled'].includes(estadoLlamada.status)" class="text-center mt-4">
                      <div class="alert" style="background-color: #1a1a1a; border: 2px solid var(--accent-color); color: var(--accent-color);">
                        <i class="bi bi-x-circle-fill me-2"></i>
                        <strong>{{ getEstadoTexto(estadoLlamada.status) }}</strong>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" @click="cerrarModalLlamada">Cerrar</button>
                </div>
              </div>
            </div>
          </div>

        </div><!-- End #app -->
      </div>
    </section>
  </main>

  <!-- Toast de notificación -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" style="background-color: #1a1a1a; border: 1px solid #da02e5;">
      <div class="toast-header" style="background-color: #2d2d2d; color: white; border-bottom: 1px solid #da02e5;">
        <i class="bi bi-check-circle-fill me-2" style="color: #da02e5;"></i>
        <strong class="me-auto">Éxito</strong>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" style="background-color: #1a1a1a; color: white;">
        Audio guardado correctamente ✅
      </div>
    </div>
    
    <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" style="background-color: #1a1a1a; border: 1px solid #da02e5;">
      <div class="toast-header" style="background-color: #2d2d2d; color: white; border-bottom: 1px solid #da02e5;">
        <i class="bi bi-exclamation-triangle-fill me-2" style="color: #da02e5;"></i>
        <strong class="me-auto">Error</strong>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" style="background-color: #1a1a1a; color: white;">
        Error al procesar el audio
      </div>
    </div>
  </div>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/aos/aos.js"></script>
  <script>
    AOS.init();
  </script>

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          areas: [],
          filtroArea: "",
          filtroUsuario: "",
          filtroAreaRemitente: "",
          filtroUsuarioRemitente: "",
          tieneVozConfigurada: false,
          idVozRemitente: null,
          ubicacionAudioGrabado: null,
          mostrarBotonClonar: false,
          cargandoClonar: false,
          textoProbarVoz: "Hola, buenos días",
          audioGenerado: null,
          cargandoTTS: false,
          contexto: "",
          cargando: false,
          cargandoAudio: false,
          objetivoEspecifico: "",
          eventoDesencadenador: "",
          rolAImitar: "Jefe",
          vozClonadaEnPreview: false,
          cargandoLlamada: false,
          previewAbiertoAntesDeClonar: false,
          modoSimulado: false,
          // Variables para monitoreo de llamada
          llamadaEnProgreso: false,
          estadoLlamada: null,
          conversacionLlamada: [],
          intervaloMonitoreo: null,
          // Variables para grabación
          consentimiento: false,
          grabando: false,
          tiempoGrabacion: 0,
          audioGrabado: null,
          mediaRecorder: null,
          audioChunks: [],
          timerInterval: null,
          maxRecordingTime: 60, // 1 minuto máximo
          historiaSeleccionada: "",
          historias: [
            "Cuéntame qué hiciste hoy en el trabajo",
            "Describe tu comida favorita y por qué te gusta",
            "Habla sobre tu hobby o pasatiempo preferido",
            "Explica cómo fue tu fin de semana",
            "Describe el lugar donde vives",
            "Cuéntame sobre tu familia o mascotas",
            "Habla sobre tu película o serie favorita",
            "Describe tu rutina matutina",
            "Cuéntame sobre un viaje que hayas hecho",
            "Explica qué te gusta hacer en tu tiempo libre"
          ]
        };
      },
      computed: {
        usuariosFiltrados() {
          const areaSeleccionada = this.areas.find(a => a.nombreArea === this.filtroArea);
          return areaSeleccionada ? areaSeleccionada.usuarios : [];
        },
        usuariosRemitentesFiltrados() {
          const areaSeleccionada = this.areas.find(a => a.nombreArea === this.filtroAreaRemitente);
          return areaSeleccionada ? areaSeleccionada.usuarios : [];
        }
      },
      watch: {
        filtroArea() {
          // Limpiar usuario seleccionado cuando cambie el área
          this.filtroUsuario = "";
        },
        filtroAreaRemitente() {
          // Limpiar usuario remitente seleccionado cuando cambie el área
          this.filtroUsuarioRemitente = "";
          this.tieneVozConfigurada = false;
          this.idVozRemitente = null;
        },
        async filtroUsuarioRemitente() {
          // Limpiar audio generado al cambiar usuario
          this.audioGenerado = null;
          
          // Verificar si el usuario remitente tiene voz configurada
          if (this.filtroUsuarioRemitente && this.filtroUsuarioRemitente.idUsuario) {
            await this.verificarVozUsuario();
          } else {
            this.tieneVozConfigurada = false;
            this.idVozRemitente = null;
          }
        }
      },
      methods: {
        async verificarVozUsuario() {
          try {
            const response = await fetch(`http://localhost:8080/api/llamadas/check-voz/${this.filtroUsuarioRemitente.idUsuario}`);
            const data = await response.json();
            
            if (response.ok) {
              this.tieneVozConfigurada = data.tieneVoz;
              this.idVozRemitente = data.idVoz;
            } else {
              console.error("Error verificando voz:", data);
              this.tieneVozConfigurada = false;
              this.idVozRemitente = null;
            }
          } catch (error) {
            console.error("Error verificando voz del usuario:", error);
            this.tieneVozConfigurada = false;
            this.idVozRemitente = null;
          }
        },

        abrirModalEjemploLlamada() {
          const modal = new bootstrap.Modal(document.getElementById("exampleCallModal"));
          modal.show();
        },

        abrirModalProbarVoz() {
          if (!this.tieneVozConfigurada) {
            this.mostrarToastError("El usuario no tiene voz configurada");
            return;
          }
          const modal = new bootstrap.Modal(document.getElementById("testVoiceModal"));
          modal.show();
        },

        async probarVoz() {
          if (!this.textoProbarVoz.trim()) {
            this.mostrarToastError("Por favor ingresa un texto para reproducir");
            return;
          }

          this.cargandoTTS = true;
          try {
            const response = await fetch('http://localhost:8080/api/tts', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                idVoz: this.idVozRemitente,
                texto: this.textoProbarVoz,
                modelo: "eleven_multilingual_v2",
                estabilidad: 0.6,
                velocidad: 0.9,
                exageracion: 0.5
              })
            });

            const data = await response.json();
            
            if (response.ok) {
              this.audioGenerado = `http://localhost:8080/api/audios/${data.idAudio}.mp3`;
              // Auto-reproducir el audio
              setTimeout(() => {
                const audioElement = document.querySelector('#testVoiceModal audio');
                if (audioElement) {
                  audioElement.play();
                }
              }, 500);
            } else {
              this.mostrarToastError("Error generando audio: " + (data.error || "Error desconocido"));
            }
          } catch (error) {
            console.error("Error generando TTS:", error);
            this.mostrarToastError("Error generando audio");
          } finally {
            this.cargandoTTS = false;
          }
        },

        async generarPreview() {
          // Validar que todos los campos estén completos
          if (!this.filtroArea || !this.filtroUsuario || !this.filtroAreaRemitente || !this.filtroUsuarioRemitente) {
            this.mostrarToastError("Por favor completa todos los campos requeridos");
            return;
          }

          if (!this.objetivoEspecifico || !this.eventoDesencadenador || !this.rolAImitar) {
            this.mostrarToastError("Por favor selecciona el objetivo, evento desencadenador y rol a imitar");
            return;
          }

          this.cargando = true;
          try {
            // Verificar si el remitente tiene voz configurada
            await this.verificarVozUsuario();
            
            // Abrir modal de preview
            const modal = new bootstrap.Modal(document.getElementById("previewModal"));
            modal.show();
          } catch (e) {
            console.error("Error:", e);
            this.mostrarToastError("Error al generar preview");
          } finally {
            this.cargando = false;
          }
        },

        abrirModalGrabacionDesdePreview() {
          // Guardar referencia para volver a abrir el preview después de clonar
          this.previewAbiertoAntesDeClonar = true;
          
          // Cerrar el modal de preview temporalmente
          const previewModal = bootstrap.Modal.getInstance(document.getElementById("previewModal"));
          if (previewModal) {
            previewModal.hide();
          }
          
          // Abrir modal de grabación
          this.abrirModalGrabacion();
        },

        mapearEventoDesencadenador(evento) {
          // Mapear los valores del frontend al formato que espera el backend
          const mapeo = {
            "Correo": "Correo",
            "Whatsapp": "Whatsapp",
            "SMS": "SMS"
          };
          return mapeo[evento] || evento;
        },

        async confirmarLlamada() {
          this.cargandoLlamada = true;
          try {
            const payload = {
              password: "phishintel2025",
              idUsuarioDestinatario: this.filtroUsuario.idUsuario,
              idUsuarioRemitente: this.filtroUsuarioRemitente.idUsuario,
              rolAImitar: this.rolAImitar,
              objetivoEspecifico: this.objetivoEspecifico,
              eventoDesencadenador: this.mapearEventoDesencadenador(this.eventoDesencadenador)
            };

            // Determinar endpoint según el modo
            const endpoint = this.modoSimulado 
              ? 'http://localhost:8080/api/llamadas/simulada'
              : 'http://localhost:8080/api/llamadas';

            const response = await fetch(endpoint, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.error || 'Error al generar la llamada');
            }

            this.mostrarToastExito("✅ Llamada generada correctamente");
            
            // Cerrar modal de preview
            const modal = bootstrap.Modal.getInstance(document.getElementById("previewModal"));
            if (modal) {
              modal.hide();
            }

            // Inicializar variables de monitoreo
            this.conversacionLlamada = [];
            this.estadoLlamada = data;
            this.llamadaEnProgreso = true;

            // Abrir modal de llamada en progreso
            const modalLlamada = new bootstrap.Modal(document.getElementById("callInProgressModal"));
            modalLlamada.show();

            // Iniciar monitoreo
            this.iniciarMonitoreo();

          } catch (e) {
            console.error("Error:", e);
            this.mostrarToastError(e.message || "Error al generar la llamada");
          } finally {
            this.cargandoLlamada = false;
          }
        },

        iniciarMonitoreo() {
          // Limpiar intervalo anterior si existe
          if (this.intervaloMonitoreo) {
            clearInterval(this.intervaloMonitoreo);
          }

          // Consultar inmediatamente
          this.monitorearLlamada();

          // Configurar polling cada 3 segundos
          this.intervaloMonitoreo = setInterval(() => {
            this.monitorearLlamada();
          }, 3000);
        },

        async monitorearLlamada() {
          try {
            // Consultar estado de la llamada
            const estadoResponse = await fetch('http://localhost:8080/api/llamadas/en-ejecucion');
            
            if (estadoResponse.status === 404) {
              // No hay llamada en ejecución
              this.detenerMonitoreo();
              return;
            }

            if (!estadoResponse.ok) {
              console.error("Error consultando estado de llamada");
              return;
            }

            const estadoData = await estadoResponse.json();
            this.estadoLlamada = estadoData;

            // Consultar conversación
            const conversacionResponse = await fetch('http://localhost:8080/api/llamadas/conversacion');
            
            if (conversacionResponse.ok) {
              const conversacionData = await conversacionResponse.json();
              const longitudAnterior = this.conversacionLlamada.length;
              this.conversacionLlamada = conversacionData;

              // Scroll automático si hay nuevos mensajes
              if (this.conversacionLlamada.length > longitudAnterior) {
                this.$nextTick(() => {
                  this.scrollToBottom();
                });
              }
            }

            // Detener monitoreo si la llamada terminó
            const estadosFinales = ['completed', 'failed', 'busy', 'no-answer', 'canceled'];
            if (estadosFinales.includes(estadoData.status)) {
              this.detenerMonitoreo();
            }

          } catch (error) {
            console.error("Error monitoreando llamada:", error);
          }
        },

        detenerMonitoreo() {
          if (this.intervaloMonitoreo) {
            clearInterval(this.intervaloMonitoreo);
            this.intervaloMonitoreo = null;
          }
          this.llamadaEnProgreso = false;
        },

        cerrarModalLlamada() {
          this.detenerMonitoreo();
          const modal = bootstrap.Modal.getInstance(document.getElementById("callInProgressModal"));
          if (modal) {
            modal.hide();
          }
          // Limpiar variables
          this.conversacionLlamada = [];
          this.estadoLlamada = null;
        },

        scrollToBottom() {
          const container = this.$refs.conversationContainer;
          if (container) {
            container.scrollTop = container.scrollHeight;
          }
        },

        getEstadoTexto(status) {
          const estados = {
            'queued': 'En cola',
            'initiated': 'Iniciando',
            'ringing': 'Sonando',
            'in-progress': 'En curso',
            'completed': 'Completada',
            'busy': 'Ocupado',
            'no-answer': 'Sin respuesta',
            'failed': 'Fallida',
            'canceled': 'Cancelada'
          };
          return estados[status] || status;
        },

        getEstadoIcon(status) {
          const iconos = {
            'queued': 'bi bi-hourglass-split',
            'initiated': 'bi bi-play-circle',
            'ringing': 'bi bi-telephone',
            'in-progress': 'bi bi-telephone-fill',
            'completed': 'bi bi-check-circle-fill',
            'busy': 'bi bi-telephone-x',
            'no-answer': 'bi bi-telephone-x',
            'failed': 'bi bi-x-circle-fill',
            'canceled': 'bi bi-x-circle-fill'
          };
          return iconos[status] || 'bi bi-question-circle';
        },


        abrirModalGrabacion() {
          // Limpiar variables del modal
          this.limpiarModalGrabacion();
          
          // Seleccionar una historia aleatoria
          this.historiaSeleccionada = this.historias[Math.floor(Math.random() * this.historias.length)];
          const modal = new bootstrap.Modal(document.getElementById("recordingModal"));
          modal.show();
        },

        seleccionarNuevaHistoria() {
          this.historiaSeleccionada = this.historias[Math.floor(Math.random() * this.historias.length)];
        },

        async toggleGrabacion() {
          if (this.grabando) {
            this.detenerGrabacion();
          } else {
            await this.iniciarGrabacion();
          }
        },

        async iniciarGrabacion() {
          try {
            // Configurar audio crudo sin procesamiento
            const stream = await navigator.mediaDevices.getUserMedia({ 
              audio: {
                echoCancellation: false,
                noiseSuppression: false,
                autoGainControl: false,
                sampleRate: 16000,
                channelCount: 1
              } 
            });
            
            // Configurar MediaRecorder con configuración básica
            const options = {
              mimeType: 'audio/webm',
              audioBitsPerSecond: 64000
            };
            
            this.mediaRecorder = new MediaRecorder(stream, options);
            this.audioChunks = [];
            
            this.mediaRecorder.ondataavailable = (event) => {
              this.audioChunks.push(event.data);
            };
            
            this.mediaRecorder.onstop = () => {
              const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
              this.audioGrabado = URL.createObjectURL(audioBlob);
              stream.getTracks().forEach(track => track.stop());
            };
            
            this.mediaRecorder.start();
            this.grabando = true;
            this.tiempoGrabacion = 0;
            
            // Iniciar timer
            this.timerInterval = setInterval(() => {
              this.tiempoGrabacion++;
              if (this.tiempoGrabacion >= this.maxRecordingTime) {
                this.detenerGrabacion();
              }
            }, 1000);
            
          } catch (error) {
            console.error('Error al acceder al micrófono:', error);
            this.mostrarToastError();
          }
        },

        detenerGrabacion() {
          if (this.mediaRecorder && this.grabando) {
            this.mediaRecorder.stop();
            this.grabando = false;
            
            if (this.timerInterval) {
              clearInterval(this.timerInterval);
              this.timerInterval = null;
            }
          }
        },

        formatearTiempo(segundos) {
          const mins = Math.floor(segundos / 60);
          const secs = segundos % 60;
          return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        },

        async guardarAudio() {
          if (!this.audioGrabado) return;
          
          // Validar duración mínima de 30 segundos
          if (this.tiempoGrabacion < 30) {
            this.mostrarToastError("La grabación debe durar al menos 30 segundos");
            return;
          }
          
          this.cargandoAudio = true;
          try {
            // Convertir el blob a FormData para enviar al servidor
            const response = await fetch(this.audioGrabado);
            const audioBlob = await response.blob();
            
            const formData = new FormData();
            formData.append('audio', audioBlob, `audio_${Date.now()}.webm`);
            formData.append('usuario', this.filtroUsuarioRemitente.nombre + ' ' + this.filtroUsuarioRemitente.apellido);
            formData.append('area', this.filtroAreaRemitente);
            formData.append('historia', this.historiaSeleccionada);
            formData.append('idUsuario', this.filtroUsuarioRemitente.idUsuario);
            
            const uploadResponse = await fetch('http://localhost:8080/api/llamadas/subir-audio', {
              method: 'POST',
              body: formData
            });
            
            if (!uploadResponse.ok) {
              throw new Error('Error al subir el audio');
            }
            
            const uploadData = await uploadResponse.json();
            this.ubicacionAudioGrabado = uploadData.ubicacion;
            
            this.mostrarToastExito("✅ Audio guardado correctamente");
            
            // Mostrar botón de clonar después de guardar
            this.mostrarBotonClonar = true;
            
          } catch (error) {
            console.error('Error al guardar audio:', error);
            this.mostrarToastError("Error al guardar el audio");
          } finally {
            this.cargandoAudio = false;
          }
        },

        async clonarVoz() {
          if (!this.ubicacionAudioGrabado || !this.filtroUsuarioRemitente) return;
          
          this.cargandoClonar = true;
          try {
            const response = await fetch('http://localhost:8080/api/llamadas/clonar', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                idUsuario: this.filtroUsuarioRemitente.idUsuario,
                ubicacionArchivo: this.ubicacionAudioGrabado
              })
            });
            
            const data = await response.json();
            
            if (response.ok) {
              this.idVozRemitente = data.idVoz;
              this.tieneVozConfigurada = true;
              this.vozClonadaEnPreview = true;
              this.mostrarToastExito("🎉 Voz clonada exitosamente");
              
              // Cerrar modal y limpiar variables
              bootstrap.Modal.getInstance(document.getElementById("recordingModal")).hide();
              this.limpiarModalGrabacion();
              
              // Si el modal de preview estaba abierto antes de clonar, volver a abrirlo
              if (this.previewAbiertoAntesDeClonar) {
                setTimeout(() => {
                  const modal = new bootstrap.Modal(document.getElementById("previewModal"));
                  modal.show();
                  this.previewAbiertoAntesDeClonar = false;
                }, 500);
              }
            } else {
              this.mostrarToastError("Error clonando voz: " + (data.error || "Error desconocido"));
            }
          } catch (error) {
            console.error('Error clonando voz:', error);
            this.mostrarToastError("Error clonando la voz");
          } finally {
            this.cargandoClonar = false;
          }
        },

        limpiarModalGrabacion() {
          this.audioGrabado = null;
          this.tiempoGrabacion = 0;
          this.consentimiento = false;
          this.historiaSeleccionada = "";
          this.ubicacionAudioGrabado = null;
          this.mostrarBotonClonar = false;
        },

        mostrarToastExito(mensaje = "Operación exitosa") {
          const toastElement = document.getElementById('successToast');
          const toastBody = toastElement.querySelector('.toast-body');
          toastBody.textContent = mensaje;
          const toast = new bootstrap.Toast(toastElement, {
            autohide: true,
            delay: 4000
          });
          toast.show();
        },

        mostrarToastError(mensaje = "Error al procesar la solicitud") {
          const toastElement = document.getElementById('errorToast');
          const toastBody = toastElement.querySelector('.toast-body');
          toastBody.textContent = mensaje;
          const toast = new bootstrap.Toast(toastElement, {
            autohide: true,
            delay: 5000
          });
          toast.show();
        }
      },
      async mounted() {
        try {
          const resp = await fetch("http://localhost:8080/api/areas");
          const data = await resp.json();
          this.areas = data.areas || [];
        } catch (e) {
          console.error("Error cargando áreas:", e);
        }
      },
      beforeUnmount() {
        // Limpiar recursos al desmontar el componente
        if (this.timerInterval) {
          clearInterval(this.timerInterval);
        }
        if (this.audioGrabado) {
          URL.revokeObjectURL(this.audioGrabado);
        }
        // Limpiar intervalo de monitoreo
        this.detenerMonitoreo();
      }
    }).mount("#app");
  </script>

</body>
</html>
