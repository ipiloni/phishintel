<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>ABM - PhishIntel</title>

  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Raleway&display=swap" rel="stylesheet">

  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">

  <link href="assets/css/main.css" rel="stylesheet">
  <style>
    /* Dark theme for forms and lists */
.card.bg-dark .card-header { background-color: #1f1f1f; border-bottom: 1px solid #3a3a3a; }
.card.bg-dark .card-body { background-color: #1b1b1b; }
.card.bg-dark, .card.bg-dark .card-body, .card.bg-dark .card-header { color: #f1f1f1; }

.form-control, .form-select {
  background-color: #212529; /* similar to modal */
  color: #f8f9fa;
  border-color: #495057;
}
.form-control::placeholder { color: #adb5bd; }
.form-control:focus, .form-select:focus { 
  box-shadow: none; 
  border-color: #6c757d; 
  background-color: #212529;
  color: #f8f9fa;
}
.form-control:focus-visible {
  background-color: #212529 !important;
  color: #f8f9fa !important;
}

/* Dual list labels */
.small.text-muted { color: #b0b0b0 !important; }

/* Tabs in dark */
.nav-tabs { 
  border-bottom: 1px solid #3a3a3a; 
  display: flex;
  width: 100%;
}
.nav-tabs .nav-item {
  flex: 1;
  display: flex;
}
.nav-tabs .nav-link { 
  color: #dddddd; 
  flex: 1;
  text-align: center;
}
.nav-tabs .nav-link:hover { color: #ffffff; }
.nav-tabs .nav-link.active {
  color: #ffffff;
  background-color: #1f1f1f;
  border-color: #3a3a3a #3a3a3a #1f1f1f;
}

/* Table dark tweaks */
.table-dark {
  background-color: #1a1a1a !important;
}
.table-dark th, .table-dark td { 
  color: #f8f9fa; 
  background-color: #1a1a1a !important;
}
.table-dark thead th { 
  border-bottom: 1px solid #3a3a3a; 
  background-color: #111111 !important;
}
.table-dark tbody tr:hover {
  background-color: #2d2d2d !important;
}

/* Brand color accents (rosa) */
.btn-outline-primary {
  color: #da02e5;
  border-color: #da02e5;
}
.btn-outline-primary:hover {
  background-color: #da02e5 !important;
  border-color: #da02e5 !important;
  color: #fff !important;
}
.btn-outline-primary:focus, .btn-outline-primary:focus-visible {
  background-color: #da02e5 !important;
  border-color: #da02e5 !important;
  color: #fff !important;
  box-shadow: 0 0 0 0.25rem rgba(218, 2, 229, 0.25) !important;
}
.btn-outline-primary:active, .btn-outline-primary.active, .show > .btn-outline-primary.dropdown-toggle {
  background-color: #da02e5 !important;
  border-color: #da02e5 !important;
  color: #fff !important;
}
.btn-outline-primary:active:focus, .btn-outline-primary.active:focus {
  box-shadow: 0 0 0 0.25rem rgba(218, 2, 229, 0.3) !important;
}

.btn-primary {
  background-color: #da02e5;
  border-color: #da02e5;
}
.btn-primary:hover {
  background-color: #b101bd;
  border-color: #b101bd;
}
.btn-primary:focus, .btn-primary:focus-visible {
  background-color: #b101bd;
  border-color: #b101bd;
  box-shadow: 0 0 0 0.25rem rgba(218, 2, 229, 0.25);
}
.btn-primary:active, .btn-primary.active, .show > .btn-primary.dropdown-toggle {
  background-color: #b101bd;
  border-color: #b101bd;
}
.btn-primary:active:focus, .btn-primary.active:focus {
  box-shadow: 0 0 0 0.25rem rgba(218, 2, 229, 0.3);
}
  </style>
</head>

<body class="index-page">

  <!-- ======= Header ======= -->
  <header id="header" class="header d-flex align-items-center fixed-top">
    <div class="container position-relative d-flex align-items-center justify-content-between">
      <a href="/" class="logo d-flex align-items-center me-auto me-xl-0">
        <h1 class="sitename">PhishIntel</h1>
      </a>

      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="/principal" class="btn-getstarted btn-login">Volver a Home</a></li>
        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
      </nav>
    </div>
  </header>
  <!-- End Header -->

  <main class="main">
    <div class="page-title py-5"></div>

    <section class="contact section">
      <div id="app" class="col-lg-8 mx-auto" data-aos="fade-left" data-aos-delay="200">
          <!-- Tabs -->
          <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link" :class="{active: activeTab==='areas'}" @click="activeTab='areas'" type="button" role="tab">
                <i class="bi bi-building"></i> Gestionar Áreas
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" :class="{active: activeTab==='usuarios'}" @click="activeTab='usuarios'" type="button" role="tab">
                <i class="bi bi-people"></i> Gestionar Empleados
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" :class="{active: activeTab==='eventos'}" @click="activeTab='eventos'" type="button" role="tab">
                <i class="bi bi-calendar-event"></i> Gestionar Eventos
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" :class="{active: activeTab==='reportes'}" @click="activeTab='reportes'" type="button" role="tab">
                <i class="bi bi-flag"></i> Gestionar Reportes
              </button>
            </li>
          </ul>

          <!-- ÁREAS -->
          <div v-show="activeTab==='areas'">
            <div class="card h-100 bg-dark text-white">
              <div class="card-header d-flex justify-content-between align-items-center bg-dark border-secondary">
                <h5 class="mb-0">Áreas</h5>
                <div>
                  <button class="btn btn-primary btn-sm me-2" @click="abrirModalArea()">
                    <i class="bi bi-plus-circle"></i> Crear Área
                  </button>
                  <button class="btn btn-primary btn-sm" @click="cargarAreas"><i class="bi bi-arrow-clockwise"></i></button>
                </div>
              </div>
              <div class="table-responsive">
                <table id="tablaAreas" class="table table-hover table-dark mb-0">
                  <thead>
                    <tr>
                      <th class="sortable" data-col="0" style="cursor:pointer;"># <i class="bi sort-icon bi-caret-down ms-1" style="color:#da02e5;"></i></th>
                      <th class="sortable" data-col="1" style="cursor:pointer;">Nombre <i class="bi sort-icon bi-caret-down ms-1" style="color:#da02e5;"></i></th>
                      <th>Datos</th>
                      <th class="sortable" data-col="3" style="cursor:pointer;">Usuarios <i class="bi sort-icon bi-caret-down ms-1" style="color:#da02e5;"></i></th>
                      <th class="text-end">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="a in areas" :key="a.idArea">
                      <td>{{ a.idArea }}</td>
                      <td>{{ a.nombreArea }}</td>
                      <td>
                        <span v-if="a.datosDelArea && a.datosDelArea.length > 0" class="badge bg-secondary me-1" v-for="dato in a.datosDelArea" :key="dato">
                          {{ dato }}
                        </span>
                        <span v-else class="text-light">Sin datos</span>
                      </td>
                      <td>{{ (a.usuarios||[]).length }}</td>
                      <td class="text-end">
                        <button class="btn btn-sm btn-primary me-2" @click="editarArea(a)"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-primary" @click="eliminarArea(a)"><i class="bi bi-trash"></i></button>
                      </td>
                    </tr>
                    <tr v-if="areas.length===0">
                      <td colspan="5" style="color:#b0b0b0;" class="text-center">Sin áreas</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- USUARIOS -->
          <div v-show="activeTab==='usuarios'">
            <div class="card h-100 bg-dark text-white">
              <div class="card-header d-flex justify-content-between align-items-center bg-dark border-secondary">
                <h5 class="mb-0">Usuarios</h5>
                <div>
                  <button class="btn btn-primary btn-sm me-2" @click="abrirModalUsuario()">
                    <i class="bi bi-plus-circle"></i> Crear Usuario
                  </button>
                  <button class="btn btn-primary btn-sm" @click="cargarUsuarios"><i class="bi bi-arrow-clockwise"></i></button>
                </div>
              </div>
              <div class="table-responsive">
                <table id="tablaUsuarios" class="table table-hover table-dark mb-0">
                  <thead>
                    <tr>
                      <th class="sortable" data-col="0" style="cursor:pointer;"># <i class="bi sort-icon bi-caret-down ms-1" style="color:#da02e5;"></i></th>
                      <th class="sortable" data-col="1" style="cursor:pointer;">Usuario <i class="bi sort-icon bi-caret-down ms-1" style="color:#da02e5;"></i></th>
                      <th class="sortable" data-col="2" style="cursor:pointer;">Nombre <i class="bi sort-icon bi-caret-down ms-1" style="color:#da02e5;"></i></th>
                      <th class="sortable" data-col="3" style="cursor:pointer;">Apellido <i class="bi sort-icon bi-caret-down ms-1" style="color:#da02e5;"></i></th>
                      <th class="sortable" data-col="4" style="cursor:pointer;">Área <i class="bi sort-icon bi-caret-down ms-1" style="color:#da02e5;"></i></th>
                      <th class="text-end">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="u in usuarios" :key="u.idUsuario">
                      <td>{{ u.idUsuario }}</td>
                      <td>{{ u.nombreUsuario }}</td>
                      <td>{{ u.nombre }}</td>
                      <td>{{ u.apellido }}</td>
                      <td>{{ nombreArea(u.idArea) }}</td>
                      <td class="text-end">
                        <button class="btn btn-sm btn-primary me-2" @click="editarUsuario(u)"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-primary" @click="eliminarUsuario(u)"><i class="bi bi-trash"></i></button>
                      </td>
                    </tr>
                    <tr v-if="usuarios.length===0">
                      <td colspan="6" class="text-center" style="color:#b0b0b0;">Sin usuarios</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- EVENTOS -->
          <div v-show="activeTab==='eventos'">
            <div class="card h-100 bg-dark text-white">
              <div class="card-header d-flex justify-content-between align-items-center bg-dark border-secondary">
                <h5 class="mb-0">Eventos</h5>
                <div>
                  <button class="btn btn-primary btn-sm" @click="cargarEventos"><i class="bi bi-arrow-clockwise"></i></button>
                </div>
              </div>
              <div class="table-responsive">
                <table id="tablaEventos" class="table table-hover table-dark mb-0">
                  <thead>
                    <tr>
                      <th class="sortable" data-col="0" style="cursor:pointer;"># <i class="bi sort-icon bi-caret-down ms-1" style="color:#da02e5;"></i></th>
                      <th class="sortable" data-col="1" style="cursor:pointer;">Tipo <i class="bi sort-icon bi-caret-down ms-1" style="color:#da02e5;"></i></th>
                      <th class="sortable" data-col="2" style="cursor:pointer;">Fecha <i class="bi sort-icon bi-caret-down ms-1" style="color:#da02e5;"></i></th>
                      <th class="sortable" data-col="3" style="cursor:pointer;">Dificultad <i class="bi sort-icon bi-caret-down ms-1" style="color:#da02e5;"></i></th>
                      <th class="sortable" data-col="4" style="cursor:pointer;">Medio <i class="bi sort-icon bi-caret-down ms-1" style="color:#da02e5;"></i></th>
                      <th class="sortable" data-col="5" style="cursor:pointer;">Usuarios <i class="bi sort-icon bi-caret-down ms-1" style="color:#da02e5;"></i></th>
                      <th class="text-end">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="e in eventos" :key="e.idEvento">
                      <td>{{ e.idEvento }}</td>
                      <td>
                        <span class="badge" :class="{
                          'bg-info': e.tipoEvento === 'CORREO',
                          'bg-success': e.tipoEvento === 'MENSAJE',
                          'bg-warning': e.tipoEvento === 'LLAMADA'
                        }">
                          {{ e.tipoEvento }}
                        </span>
                      </td>
                      <td>{{ formatearFecha(e.fechaEvento) }}</td>
                      <td>{{ e.dificultad || '—' }}</td>
                      <td>{{ e.medio || '—' }}</td>
                      <td>{{ (e.usuarios || []).length }}</td>
                      <td class="text-end">
                        <button class="btn btn-sm btn-primary me-2" @click="editarEvento(e)"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-primary" @click="eliminarEvento(e)"><i class="bi bi-trash"></i></button>
                      </td>
                    </tr>
                    <tr v-if="eventos.length===0">
                      <td colspan="7" class="text-center" style="color:#b0b0b0;">Sin eventos</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- INTENTOS DE REPORTE -->
          <div v-show="activeTab==='reportes'">
            <div class="card h-100 bg-dark text-white">
              <div class="card-header d-flex justify-content-between align-items-center bg-dark border-secondary">
                <h5 class="mb-0">Intentos de Reporte</h5>
                <div>
                  <button class="btn btn-primary btn-sm" @click="cargarIntentosReporte"><i class="bi bi-arrow-clockwise"></i></button>
                </div>
              </div>
              <div class="table-responsive">
                <table id="tablaReportes" class="table table-hover table-dark mb-0">
                  <thead>
                    <tr>
                      <th class="sortable" data-col="0" style="cursor:pointer;"># <i class="bi sort-icon bi-caret-down ms-1" style="color:#da02e5;"></i></th>
                      <th class="sortable" data-col="1" style="cursor:pointer;">Usuario <i class="bi sort-icon bi-caret-down ms-1" style="color:#da02e5;"></i></th>
                      <th class="sortable" data-col="2" style="cursor:pointer;">Tipo <i class="bi sort-icon bi-caret-down ms-1" style="color:#da02e5;"></i></th>
                      <th class="sortable" data-col="3" style="cursor:pointer;">Fecha Reporte <i class="bi sort-icon bi-caret-down ms-1" style="color:#da02e5;"></i></th>
                      <th class="sortable" data-col="4" style="cursor:pointer;">Estado <i class="bi sort-icon bi-caret-down ms-1" style="color:#da02e5;"></i></th>
                      <th>Observaciones</th>
                      <th class="text-end">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="reporte in intentosReporte" :key="reporte.idIntentoReporte">
                      <td>{{ reporte.idIntentoReporte }}</td>
                      <td>{{ reporte.nombreUsuario }}</td>
                      <td>
                        <span class="badge" :class="{
                          'bg-info': reporte.tipoEvento === 'CORREO',
                          'bg-success': reporte.tipoEvento === 'MENSAJE',
                          'bg-warning': reporte.tipoEvento === 'LLAMADA'
                        }">
                          {{ reporte.tipoEvento }}
                        </span>
                      </td>
                      <td>{{ formatearFecha(reporte.fechaIntento) }}</td>
                      <td>
                        <span class="badge" :class="{
                          'bg-success': reporte.estado === 'VERIFICADO',
                          'bg-info': reporte.estado === 'VALIDADO_SIN_EVENTO',
                          'bg-danger': reporte.estado === 'RECHAZADO',
                          'bg-warning': reporte.estado === 'PENDIENTE'
                        }">
                          {{ getEstadoNombre(reporte.estado) }}
                        </span>
                      </td>
                      <td>
                        <span v-if="reporte.observaciones" style="color: #ddd;">{{ reporte.observaciones.substring(0, 50) }}{{ reporte.observaciones.length > 50 ? '...' : '' }}</span>
                        <span v-else style="color: #777;">Sin observaciones</span>
                      </td>
                      <td class="text-end">
                        <button class="btn btn-sm btn-primary me-2" @click="editarReporte(reporte)"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-primary" @click="eliminarReporte(reporte)"><i class="bi bi-trash"></i></button>
                      </td>
                    </tr>
                    <tr v-if="intentosReporte.length===0">
                      <td colspan="7" class="text-center" style="color:#b0b0b0;">Sin intentos de reporte</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Modal para Áreas -->
          <div class="modal fade" id="modalArea" tabindex="-1" aria-labelledby="modalAreaLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-white">
              <div class="modal-header border-secondary">
                <h5 class="modal-title" id="modalAreaLabel">{{ areaForm.idArea ? 'Editar Área' : 'Crear Área' }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form @submit.prevent="submitArea" class="php-email-form">
                  <div class="mb-3">
                    <label class="form-label">Nombre del Área</label>
                    <input class="form-control" v-model="areaForm.nombreArea" placeholder="Ej: Ventas" required>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Datos del Área</label>
                    <textarea class="form-control" v-model="datosDelAreaTexto" rows="3" placeholder="Ingrese los datos del área, uno por línea o separados por comas"></textarea>
                    <small style="color:#b0b0b0;">Cada línea o elemento separado por coma será un dato del área</small>
                  </div>

                  <div class="mb-2 d-flex justify-content-between align-items-center">
                    <label class="form-label mb-0">Asignación de usuarios</label>
                    <small style="color:#b0b0b0;" v-if="!areaForm.idArea">Se asignarán al crear el área</small>
                    <small style="color:#b0b0b0;" v-else>Se actualizarán asignaciones al guardar</small>
                  </div>

                  <div class="row g-2 align-items-center">
                    <div class="col-5">
                      <div class="small text-muted mb-1">Disponibles</div>
                      <select class="form-select" size="8" multiple v-model="seleccionDisponibles">
                        <option v-for="u in usuariosDisponibles" :key="u.idUsuario" :value="u.idUsuario">
                          {{ u.nombre }} {{ u.apellido }} — de: {{ nombreArea(u.idArea) }}
                        </option>
                      </select>
                    </div>
                    <div class="col-2 d-flex flex-column align-items-center gap-2">
                      <button type="button" class="btn btn-primary btn-sm" @click="agregarSeleccion"><i class="bi bi-chevron-right"></i></button>
                      <button type="button" class="btn btn-primary btn-sm" @click="quitarSeleccion"><i class="bi bi-chevron-left"></i></button>
                    </div>
                    <div class="col-5">
                      <div class="small text-muted mb-1">Asignados</div>
                      <select class="form-select" size="8" multiple v-model="seleccionAsignados">
                        <option v-for="u in usuariosAsignados" :key="u.idUsuario" :value="u.idUsuario">
                          {{ u.nombre }} {{ u.apellido }} — de: {{ nombreArea(u.idArea) }}
                        </option>
                      </select>
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" :disabled="loadingArea">Cancelar</button>
                <button type="button" class="btn btn-primary" @click="submitArea" :disabled="loadingArea">
                  <span v-if="loadingArea" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                  <i v-else class="bi" :class="areaForm.idArea ? 'bi-save' : 'bi-plus-circle' "></i>
                  {{ loadingArea ? 'Procesando...' : (areaForm.idArea ? 'Guardar cambios' : 'Crear Área') }}
                </button>
              </div>
            </div>
          </div>
        </div>

          <!-- Modal para Usuario -->
          <div class="modal fade" id="modalUsuario" tabindex="-1" aria-labelledby="modalUsuarioLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
              <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                  <h5 class="modal-title" id="modalUsuarioLabel">{{ usuarioForm.idUsuario ? 'Editar Usuario' : 'Crear Usuario' }}</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <form @submit.prevent="submitUsuario" class="php-email-form">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label class="form-label">Nombre de usuario</label>
                          <input class="form-control" v-model="usuarioForm.nombreUsuario" :required="!usuarioForm.idUsuario">
                        </div>
                        <div class="mb-3" v-if="!usuarioForm.idUsuario">
                          <label class="form-label">Password</label>
                          <input type="password" class="form-control" v-model="usuarioForm.password" :required="!usuarioForm.idUsuario">
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Nombre</label>
                          <input class="form-control" v-model="usuarioForm.nombre" required>
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Apellido</label>
                          <input class="form-control" v-model="usuarioForm.apellido" required>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label class="form-label">Correo</label>
                          <input type="email" class="form-control" v-model="usuarioForm.correo">
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Teléfono</label>
                          <input class="form-control" v-model="usuarioForm.telefono">
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Dirección</label>
                          <input class="form-control" v-model="usuarioForm.direccion" placeholder="Dirección del usuario">
                        </div>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label class="form-label">ID de Voz</label>
                          <input class="form-control" v-model="usuarioForm.idVoz" placeholder="ID de voz de ElevenLabs">
                          <small style="color:#b0b0b0;">ID de la voz creada en ElevenLabs (opcional)</small>
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Perfil LinkedIn</label>
                          <input class="form-control" v-model="usuarioForm.perfilLinkedin" placeholder="URL del perfil de LinkedIn">
                          <small style="color:#b0b0b0;">URL completa del perfil de LinkedIn (opcional)</small>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label class="form-label">Área</label>
                          <select class="form-select" v-model.number="usuarioForm.idArea">
                            <option :value="null">Sin área</option>
                            <option v-for="a in areas" :key="a.idArea" :value="a.idArea">{{ a.nombreArea }}</option>
                          </select>
                          <small style="color:#b0b0b0;">Para crear, el área se asignará luego de la creación.</small>
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Rol</label>
                          <div class="form-check form-switch mt-2">
                            <input class="form-check-input" type="checkbox" id="checkAdministrador" v-model="usuarioForm.esAdministrador">
                            <label class="form-check-label" for="checkAdministrador">
                              Es Administrador
                            </label>
                          </div>
                          <small style="color:#b0b0b0;">Marcar si el usuario tiene permisos de administrador</small>
                        </div>
                      </div>
                    </div>
                  </form>
                </div>
                <div class="modal-footer border-secondary">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" :disabled="loadingUsuario">Cancelar</button>
                  <button type="button" class="btn btn-primary" @click="submitUsuario" :disabled="loadingUsuario">
                    <span v-if="loadingUsuario" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    <i v-else class="bi" :class="usuarioForm.idUsuario ? 'bi-save' : 'bi-plus-circle' "></i>
                    {{ loadingUsuario ? 'Procesando...' : (usuarioForm.idUsuario ? 'Guardar cambios' : 'Crear Usuario') }}
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Modal para Eventos -->
          <div class="modal fade" id="modalEvento" tabindex="-1" aria-labelledby="modalEventoLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
              <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                  <h5 class="modal-title" id="modalEventoLabel">Editar Evento #{{ eventoForm.idEvento }}</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <strong>Tipo:</strong> {{ eventoForm.tipoEvento }}
                    </div>
                    <div class="col-md-6">
                      <strong>Fecha:</strong> {{ formatearFecha(eventoForm.fechaEvento) }}
                    </div>
                    <div class="col-md-6" v-if="eventoForm.dificultad">
                      <strong>Dificultad:</strong> {{ eventoForm.dificultad }}
                    </div>
                    <div class="col-md-6" v-if="eventoForm.medio">
                      <strong>Medio:</strong> {{ eventoForm.medio }}
                    </div>
                  </div>

                  <hr class="border-secondary">

                  <div class="mb-3">
                    <label class="form-label mb-2"><strong>Gestionar Usuarios Asociados</strong></label>
                    <div class="row g-2 align-items-center">
                      <div class="col-5">
                        <div class="small text-muted mb-1">Disponibles</div>
                        <select class="form-select" size="8" multiple v-model="seleccionUsuariosDisponibles">
                          <option v-for="u in usuariosDisponiblesEvento" :key="u.idUsuario" :value="u.idUsuario">
                            {{ u.nombre }} {{ u.apellido }} ({{ u.nombreUsuario }})
                          </option>
                        </select>
                      </div>
                      <div class="col-2 d-flex flex-column align-items-center gap-2">
                        <button type="button" class="btn btn-primary btn-sm" @click="agregarUsuarioEvento"><i class="bi bi-chevron-right"></i></button>
                        <button type="button" class="btn btn-primary btn-sm" @click="quitarUsuarioEvento"><i class="bi bi-chevron-left"></i></button>
                      </div>
                      <div class="col-5">
                        <div class="small text-muted mb-1">Asociados</div>
                        <select class="form-select" size="8" multiple v-model="seleccionUsuariosAsociados">
                          <option v-for="u in usuariosAsociadosEvento" :key="u.idUsuario" :value="u.idUsuario">
                            {{ u.nombre }} {{ u.apellido }} ({{ u.nombreUsuario }})
                          </option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <hr class="border-secondary">

                  <div class="mb-3">
                    <label class="form-label mb-2"><strong>Gestionar Estado de Usuarios</strong></label>
                    <div class="table-responsive">
                      <table class="table table-sm table-dark">
                        <thead>
                          <tr>
                            <th>Usuario</th>
                            <th>Estado</th>
                            <th>Falla Grave</th>
                            <th>Falló en el Pasado</th>
                            <th>Acciones</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr v-for="ux in eventoForm.usuariosAsociados" :key="ux.idUsuario">
                            <td>{{ nombreUsuario(ux.idUsuario) }}</td>
                            <td>
                              <select class="form-select form-select-sm" v-model="ux.resultado" @change="actualizarEstadoUsuarioEvento(ux)">
                                <option value="PENDIENTE">Pendiente</option>
                                <option value="REPORTADO">Reportado</option>
                                <option value="FALLA">Falla</option>
                              </select>
                            </td>
                            <td>
                              <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" v-model="ux.esFallaGrave" @change="actualizarFallaGrave(ux)">
                              </div>
                            </td>
                            <td>
                              <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" v-model="ux.haFalladoEnElPasado" @change="actualizarHaFalladoPasado(ux)">
                              </div>
                            </td>
                            <td>
                              <button class="btn btn-sm btn-danger" @click="desasociarUsuarioEvento(ux.idUsuario)"><i class="bi bi-x-circle"></i></button>
                            </td>
                          </tr>
                          <tr v-if="eventoForm.usuariosAsociados.length === 0">
                            <td colspan="5" class="text-center" style="color:#b0b0b0;">No hay usuarios asociados</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
                <div class="modal-footer border-secondary">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Modal para Reportes -->
          <div class="modal fade" id="modalReporte" tabindex="-1" aria-labelledby="modalReporteLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
              <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                  <h5 class="modal-title" id="modalReporteLabel">Editar Intento de Reporte #{{ reporteForm.idIntentoReporte }}</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <strong>Usuario:</strong> {{ reporteForm.nombreUsuario }}
                    </div>
                    <div class="col-md-6">
                      <strong>Tipo:</strong> {{ reporteForm.tipoEvento }}
                    </div>
                    <div class="col-md-6">
                      <strong>Fecha Inicio:</strong> {{ formatearFecha(reporteForm.fechaInicio) }}
                    </div>
                    <div class="col-md-6">
                      <strong>Fecha Fin:</strong> {{ formatearFecha(reporteForm.fechaFin) }}
                    </div>
                    <div class="col-md-6">
                      <strong>Fecha Reporte:</strong> {{ formatearFecha(reporteForm.fechaIntento) }}
                    </div>
                  </div>

                  <hr class="border-secondary">

                  <div class="mb-3">
                    <label class="form-label">Estado</label>
                    <select class="form-select" v-model="reporteForm.estado">
                      <option value="PENDIENTE">Pendiente</option>
                      <option value="VERIFICADO">Verificado</option>
                      <option value="VALIDADO_SIN_EVENTO">Validado sin Evento</option>
                      <option value="RECHAZADO">Rechazado</option>
                    </select>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Observaciones</label>
                    <textarea class="form-control" v-model="reporteForm.observaciones" rows="4" placeholder="Agrega observaciones sobre este reporte..."></textarea>
                    <small style="color:#b0b0b0;">Estas observaciones serán visibles para el empleado</small>
                  </div>

                  <div class="mb-3" v-if="reporteForm.estado === 'VERIFICADO'">
                    <label class="form-label">ID Evento Asociado</label>
                    <input type="number" class="form-control" v-model.number="reporteForm.idEventoVerificado" placeholder="ID del evento">
                  </div>
                </div>
                <div class="modal-footer border-secondary">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" :disabled="loadingReporte">Cancelar</button>
                  <button type="button" class="btn btn-primary" @click="submitReporte" :disabled="loadingReporte">
                    <span v-if="loadingReporte" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    <i v-else class="bi bi-save"></i>
                    {{ loadingReporte ? 'Guardando...' : 'Guardar cambios' }}
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Modal de Confirmación de Eliminación -->
          <div class="modal fade" id="modalConfirmarEliminacion" tabindex="-1" aria-labelledby="modalConfirmarEliminacionLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content bg-dark text-white" style="border: 2px solid #da02e5;">
                <div class="modal-header border-secondary" style="background-color: #1a1a1a; border-bottom: 2px solid #da02e5;">
                  <h5 class="modal-title" id="modalConfirmarEliminacionLabel">
                    <i class="bi bi-exclamation-triangle-fill me-2" style="color: #da02e5;"></i>
                    Confirmar Eliminación
                  </h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="background-color: #1a1a1a;">
                  <div class="text-center mb-3">
                    <i class="bi bi-trash-fill" style="font-size: 3rem; color: #da02e5;"></i>
                  </div>
                  <p class="text-center mb-3" style="font-size: 1.1rem; color: #e0e0e0;">
                    {{ confirmacionEliminacion.mensaje }}
                  </p>
                  <div class="alert alert-warning" style="background-color: #2d2d2d; border-color: #da02e5; color: #ffc107;">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Esta acción es destructiva y no se puede deshacer.</strong>
                  </div>
                </div>
                <div class="modal-footer border-secondary" style="background-color: #1a1a1a; border-top: 2px solid #da02e5;">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Cancelar
                  </button>
                  <button type="button" class="btn btn-primary" @click="confirmarEliminacion" :disabled="eliminando">
                    <span v-if="eliminando" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    <i v-else class="bi bi-trash-fill me-2"></i>
                    {{ eliminando ? 'Eliminando...' : 'Eliminar' }}
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Toast de notificación -->
          <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" style="background-color: #1a1a1a; border: 1px solid #da02e5;">
              <div class="toast-header" style="background-color: #2d2d2d; color: white; border-bottom: 1px solid #da02e5;">
                <i class="bi bi-check-circle-fill me-2" style="color: #da02e5;"></i>
                <strong class="me-auto">Éxito</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
              </div>
              <div class="toast-body" style="background-color: #1a1a1a; color: white;">
                <span id="successMessage">Operación completada correctamente ✅</span>
              </div>
            </div>
            
            <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" style="background-color: #1a1a1a; border: 1px solid #dc3545;">
              <div class="toast-header" style="background-color: #2d2d2d; color: white; border-bottom: 1px solid #dc3545;">
                <i class="bi bi-exclamation-triangle-fill me-2" style="color: #dc3545;"></i>
                <strong class="me-auto">Error</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
              </div>
              <div class="toast-body" style="background-color: #1a1a1a; color: white;">
                <span id="errorMessage">No se pudo completar la operación</span>
              </div>
            </div>
          </div>

      </div><!-- End col-lg-8 mx-auto -->

    </section>
  </main>

  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/aos/aos.js"></script>
  <script>
    AOS.init();
  </script>

  <!-- Script de configuración para obtener URL del backend -->
  <script src="assets/js/config.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
  <script>
    const { createApp } = Vue;

    // Usar API_BASE_URL del script de configuración
    const API = API_BASE_URL;

    createApp({
      data() {
        return {
          activeTab: 'areas',
          areas: [],
          usuarios: [],
          seleccionDisponibles: [],
          seleccionAsignados: [],
          loadingArea: false,
          loadingUsuario: false,
          loadingReporte: false,
          eliminando: false,
          confirmacionEliminacion: {
            tipo: null, // 'area', 'usuario', 'evento' o 'reporte'
            item: null,
            mensaje: ''
          },
          eventos: [],
          seleccionUsuariosDisponibles: [],
          seleccionUsuariosAsociados: [],
          intentosReporte: [],
          eventoForm: {
            idEvento: null,
            tipoEvento: '',
            fechaEvento: '',
            dificultad: '',
            medio: '',
            usuariosAsociados: []
          },
          areaForm: {
            idArea: null,
            nombreArea: '',
            datosDelArea: [],
            usuariosSeleccionados: []
          },
          usuarioForm: {
            idUsuario: null,
            nombreUsuario: '',
            password: '',
            nombre: '',
            apellido: '',
            correo: '',
            telefono: '',
            direccion: '',
            idArea: null,
            idVoz: '',
            perfilLinkedin: '',
            esAdministrador: false
          },
          reporteForm: {
            idIntentoReporte: null,
            idUsuario: null,
            nombreUsuario: '',
            tipoEvento: '',
            fechaInicio: '',
            fechaFin: '',
            fechaIntento: '',
            estado: 'PENDIENTE',
            observaciones: '',
            idEventoVerificado: null
          }
        }
      },
      computed: {
        usuariosAsignados() {
          const selected = new Set((this.areaForm.usuariosSeleccionados || []).map(v => Number(v)));
          return this.usuarios.filter(u => selected.has(Number(u.idUsuario)));
        },
        usuariosDisponibles() {
          const selected = new Set((this.areaForm.usuariosSeleccionados || []).map(v => Number(v)));
          return this.usuarios.filter(u => !selected.has(Number(u.idUsuario)));
        },
        destinoAreaNombre() {
          return this.areaForm.idArea ? this.nombreArea(this.areaForm.idArea) : '(nueva área)';
        },
        datosDelAreaTexto: {
          get() {
            return this.areaForm.datosDelArea ? this.areaForm.datosDelArea.join('\n') : '';
          },
          set(value) {
            if (!value || value.trim() === '') {
              this.areaForm.datosDelArea = [];
            } else {
              // Dividir por líneas o comas y limpiar espacios
              this.areaForm.datosDelArea = value
                .split(/[\n,]/)
                .map(item => item.trim())
                .filter(item => item.length > 0);
            }
          }
        },
        usuariosAsociadosEvento() {
          const asociados = new Set((this.eventoForm.usuariosAsociados || []).map(ux => Number(ux.idUsuario)));
          return this.usuarios.filter(u => asociados.has(Number(u.idUsuario)));
        },
        usuariosDisponiblesEvento() {
          const asociados = new Set((this.eventoForm.usuariosAsociados || []).map(ux => Number(ux.idUsuario)));
          return this.usuarios.filter(u => !asociados.has(Number(u.idUsuario)));
        }
      },
      methods: {
        showToast(type, message) {
          if (type === 'success') {
            document.getElementById('successMessage').textContent = message;
            const toast = new bootstrap.Toast(document.getElementById('successToast'));
            toast.show();
          } else {
            document.getElementById('errorMessage').textContent = message;
            const toast = new bootstrap.Toast(document.getElementById('errorToast'));
            toast.show();
          }
        },
        nombreArea(idArea) {
          const a = this.areas.find(x => x.idArea === idArea);
          return a ? a.nombreArea : '—';
        },
        usuariosDeArea(idArea) {
          return this.usuarios.filter(u => u.idArea === idArea);
        },
        usuariosNoAsignados(idArea) {
          return this.usuarios.filter(u => u.idArea !== idArea && (u.idArea == null || u.idArea !== idArea));
        },
        agregarSeleccion() {
          const set = new Set((this.areaForm.usuariosSeleccionados || []).map(v => Number(v)));
          this.seleccionDisponibles.forEach(id => set.add(Number(id)));
          this.areaForm.usuariosSeleccionados = Array.from(set.values());
          this.seleccionDisponibles = [];
        },
        quitarSeleccion() {
          const quitar = new Set((this.seleccionAsignados || []).map(v => Number(v)));
          this.areaForm.usuariosSeleccionados = (this.areaForm.usuariosSeleccionados || []).map(v => Number(v)).filter(id => !quitar.has(Number(id)));
          this.seleccionAsignados = [];
        },
        // ------- ÁREAS -------
        async cargarAreas() {
          const resp = await fetch(`${API}/api/areas`);
          const data = await resp.json();
          this.areas = data.areas || [];
          // Si estoy editando un área, recalcular listas derivadas
          if (this.areaForm.idArea) {
            const idArea = this.areaForm.idArea;
            this.areaForm.usuariosSeleccionados = this.usuarios.filter(u => u.idArea === idArea).map(u => u.idUsuario);
          }
          // Reinicializar ordenamiento después de cargar
          this.$nextTick(() => {
            const tablaAreas = document.getElementById('tablaAreas');
            if (tablaAreas) {
              this.configurarOrdenamientoTabla(tablaAreas);
            }
          });
        },
        abrirModalArea() {
          this.resetAreaForm();
          const modal = new bootstrap.Modal(document.getElementById('modalArea'));
          modal.show();
        },
        editarArea(area) {
          this.areaForm.idArea = area.idArea;
          this.areaForm.nombreArea = area.nombreArea;
          this.areaForm.datosDelArea = area.datosDelArea || [];
          // Pre-cargar asignados actuales
          this.areaForm.usuariosSeleccionados = this.usuarios.filter(u => u.idArea === area.idArea).map(u => u.idUsuario);
          this.seleccionDisponibles = [];
          this.seleccionAsignados = [];
          const modal = new bootstrap.Modal(document.getElementById('modalArea'));
          modal.show();
        },
        resetAreaForm() {
          this.areaForm = { idArea: null, nombreArea: '', datosDelArea: [], usuariosSeleccionados: [] };
          this.seleccionDisponibles = [];
          this.seleccionAsignados = [];
        },
        async submitArea() {
          this.loadingArea = true;
          try {
            if (!this.areaForm.idArea) {
              // Crear área (permite asignar usuarios en payload)
              const payload = {
                nombreArea: this.areaForm.nombreArea,
                datosDelArea: this.areaForm.datosDelArea,
                usuarios: this.areaForm.usuariosSeleccionados
              };
              const resp = await fetch(`${API}/api/areas`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });
              if (!resp.ok) throw new Error('Error creando área');
              this.showToast('success', 'Área creada correctamente ✅');
            } else {
              // Editar área
              const resp = await fetch(`${API}/api/areas/${this.areaForm.idArea}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                  nombreArea: this.areaForm.nombreArea,
                  datosDelArea: this.areaForm.datosDelArea
                })
              });
              if (!resp.ok) throw new Error('Error editando área');

              // Sin endpoint masivo de asignación, dif vamos por usuario (PUT /usuarios/{id})
              const idArea = this.areaForm.idArea;
              const asignadosActuales = new Set(this.usuarios.filter(u => u.idArea === idArea).map(u => u.idUsuario));
              const asignadosDeseados = new Set(this.areaForm.usuariosSeleccionados);

              // Usuarios a asignar (antes no estaban)
              const aAsignar = Array.from(asignadosDeseados).filter(id => !asignadosActuales.has(id));
              // Usuarios a quitar (antes estaban y ya no)
              const aQuitar = Array.from(asignadosActuales).filter(id => !asignadosDeseados.has(id));

              // Ejecutar actualizaciones secuenciales para claridad
              for (const idUsuario of aAsignar) {
                await fetch(`${API}/api/usuarios/${idUsuario}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ idArea })
                });
              }
              for (const idUsuario of aQuitar) {
                await fetch(`${API}/api/usuarios/${idUsuario}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ idArea: null })
                });
              }
              this.showToast('success', 'Área editada correctamente ✅');
            }
            await this.cargarAreas();
            await this.cargarUsuarios();
            this.resetAreaForm();
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalArea'));
            if (modal) modal.hide();
          } catch (e) {
            this.showToast('error', e.message || 'Error en operación de área');
          } finally {
            this.loadingArea = false;
          }
        },
        eliminarArea(area) {
          this.confirmacionEliminacion.tipo = 'area';
          this.confirmacionEliminacion.item = area;
          this.confirmacionEliminacion.mensaje = `¿Estás seguro de que deseas eliminar el área "${area.nombreArea}"?`;
          const modal = new bootstrap.Modal(document.getElementById('modalConfirmarEliminacion'));
          modal.show();
        },
        async confirmarEliminacion() {
          this.eliminando = true;
          try {
            if (this.confirmacionEliminacion.tipo === 'area') {
              const area = this.confirmacionEliminacion.item;
              const resp = await fetch(`${API}/api/areas/${area.idArea}`, { method: 'DELETE' });
              if (!resp.ok) {
                this.showToast('error', 'No se pudo eliminar el área');
                return;
              }
              this.showToast('success', `Área "${area.nombreArea}" eliminada correctamente ✅`);
              await this.cargarAreas();
              await this.cargarUsuarios();
            } else if (this.confirmacionEliminacion.tipo === 'usuario') {
              const usuario = this.confirmacionEliminacion.item;
              const resp = await fetch(`${API}/api/usuarios/${usuario.idUsuario}`, { method: 'DELETE' });
              if (!resp.ok) {
                this.showToast('error', 'No se pudo eliminar el usuario');
                return;
              }
              this.showToast('success', `Usuario "${usuario.nombre} ${usuario.apellido}" eliminado correctamente ✅`);
              await this.cargarUsuarios();
              await this.cargarAreas();
            } else if (this.confirmacionEliminacion.tipo === 'evento') {
              const evento = this.confirmacionEliminacion.item;
              const resp = await fetch(`${API}/api/eventos/${evento.idEvento}`, { method: 'DELETE' });
              if (!resp.ok) {
                this.showToast('error', 'No se pudo eliminar el evento');
                return;
              }
              this.showToast('success', `Evento #${evento.idEvento} eliminado correctamente ✅`);
              await this.cargarEventos();
            } else if (this.confirmacionEliminacion.tipo === 'reporte') {
              const reporte = this.confirmacionEliminacion.item;
              const resp = await fetch(`${API}/api/admin/intentos-reporte/${reporte.idIntentoReporte}`, { method: 'DELETE' });
              if (!resp.ok) {
                this.showToast('error', 'No se pudo eliminar el intento de reporte');
                return;
              }
              this.showToast('success', `Intento de reporte #${reporte.idIntentoReporte} eliminado correctamente ✅`);
              await this.cargarIntentosReporte();
            }
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalConfirmarEliminacion'));
            if (modal) modal.hide();
            // Limpiar confirmación
            this.confirmacionEliminacion = { tipo: null, item: null, mensaje: '' };
          } catch (e) {
            this.showToast('error', e.message || 'Error al eliminar');
          } finally {
            this.eliminando = false;
          }
        },

        // ------- USUARIOS -------
        async cargarUsuarios() {
          const resp = await fetch(`${API}/api/usuarios`);
          const data = await resp.json();
          this.usuarios = data.usuarios || [];
          // Reinicializar ordenamiento después de cargar
          this.$nextTick(() => {
            const tablaUsuarios = document.getElementById('tablaUsuarios');
            if (tablaUsuarios) {
              this.configurarOrdenamientoTabla(tablaUsuarios);
            }
          });
        },
        abrirModalUsuario() {
          this.resetUsuarioForm();
          const modal = new bootstrap.Modal(document.getElementById('modalUsuario'));
          modal.show();
        },
        editarUsuario(usuario) {
          this.usuarioForm = {
            idUsuario: usuario.idUsuario,
            nombreUsuario: usuario.nombreUsuario,
            password: '',
            nombre: usuario.nombre,
            apellido: usuario.apellido,
            correo: usuario.correo || '',
            telefono: usuario.telefono || '',
            direccion: usuario.direccion || '',
            idArea: usuario.idArea,
            idVoz: usuario.idVoz || '',
            perfilLinkedin: usuario.perfilLinkedin || '',
            esAdministrador: usuario.esAdministrador || false
          };
          this.activeTab = 'usuarios';
          const modal = new bootstrap.Modal(document.getElementById('modalUsuario'));
          modal.show();
        },
        resetUsuarioForm() {
          this.usuarioForm = { 
            idUsuario: null, 
            nombreUsuario: '', 
            password: '', 
            nombre: '', 
            apellido: '', 
            correo: '', 
            telefono: '', 
            direccion: '', 
            idArea: null, 
            idVoz: '', 
            perfilLinkedin: '', 
            esAdministrador: false 
          };
        },
        async submitUsuario() {
          this.loadingUsuario = true;
          try {
            if (!this.usuarioForm.idUsuario) {
              // Crear usuario
              const payload = {
                nombreUsuario: this.usuarioForm.nombreUsuario,
                password: this.usuarioForm.password,
                nombre: this.usuarioForm.nombre,
                apellido: this.usuarioForm.apellido,
                correo: this.usuarioForm.correo || undefined,
                telefono: this.usuarioForm.telefono || undefined,
                direccion: this.usuarioForm.direccion || undefined,
                esAdministrador: this.usuarioForm.esAdministrador || false,
                idArea: this.usuarioForm.idArea || undefined,
                idVoz: this.usuarioForm.idVoz || undefined,
                perfilLinkedin: this.usuarioForm.perfilLinkedin || undefined
              };
              const resp = await fetch(`${API}/api/usuarios`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });
              if (!resp.ok) throw new Error('Error creando usuario');
              this.showToast('success', 'Usuario creado correctamente ✅');
            } else {
              // Editar usuario (incluye reasignar área)
              const payload = {
                nombreUsuario: this.usuarioForm.nombreUsuario,
                nombre: this.usuarioForm.nombre,
                apellido: this.usuarioForm.apellido,
                correo: this.usuarioForm.correo || null,
                telefono: this.usuarioForm.telefono || null,
                direccion: this.usuarioForm.direccion || null,
                idArea: this.usuarioForm.idArea,
                idVoz: this.usuarioForm.idVoz || null,
                perfilLinkedin: this.usuarioForm.perfilLinkedin || null,
                esAdministrador: this.usuarioForm.esAdministrador || false
              };
              const resp = await fetch(`${API}/api/usuarios/${this.usuarioForm.idUsuario}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });
              if (!resp.ok) throw new Error('Error editando usuario');
              this.showToast('success', 'Usuario editado correctamente ✅');
            }
            await this.cargarUsuarios();
            await this.cargarAreas();
            this.resetUsuarioForm();
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalUsuario'));
            if (modal) modal.hide();
          } catch (e) {
            this.showToast('error', e.message || 'Error en operación de usuario');
          } finally {
            this.loadingUsuario = false;
          }
        },
        eliminarUsuario(usuario) {
          this.confirmacionEliminacion.tipo = 'usuario';
          this.confirmacionEliminacion.item = usuario;
          this.confirmacionEliminacion.mensaje = `¿Estás seguro de que deseas eliminar al usuario "${usuario.nombre} ${usuario.apellido}"?`;
          const modal = new bootstrap.Modal(document.getElementById('modalConfirmarEliminacion'));
          modal.show();
        },

        // ------- EVENTOS -------
        async cargarEventos() {
          try {
            const resp = await fetch(`${API}/api/eventos`);
            if (!resp.ok) throw new Error('Error al cargar eventos');
            const data = await resp.json();
            this.eventos = data.eventos || [];
            // Reinicializar ordenamiento después de cargar
            this.$nextTick(() => {
              const tablaEventos = document.getElementById('tablaEventos');
              if (tablaEventos) {
                this.configurarOrdenamientoTabla(tablaEventos);
              }
            });
          } catch (e) {
            this.showToast('error', e.message || 'Error al cargar eventos');
          }
        },
        formatearFecha(fechaStr) {
          if (!fechaStr) return '—';
          const fecha = new Date(fechaStr);
          return fecha.toLocaleString('es-ES', { 
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit', 
            hour: '2-digit', 
            minute: '2-digit' 
          });
        },
        nombreUsuario(idUsuario) {
          const u = this.usuarios.find(x => x.idUsuario === idUsuario);
          return u ? `${u.nombre} ${u.apellido} (${u.nombreUsuario})` : '—';
        },
        editarEvento(evento) {
          this.eventoForm = {
            idEvento: evento.idEvento,
            tipoEvento: evento.tipoEvento,
            fechaEvento: evento.fechaEvento,
            dificultad: evento.dificultad || '',
            medio: evento.medio || '',
            usuariosAsociados: (evento.usuarios || []).map(u => ({
              idUsuario: u.idUsuario,
              resultado: u.resultado,
              esFallaGrave: u.esFallaGrave || false,
              haFalladoEnElPasado: u.haFalladoEnElPasado || false,
              fechaReporte: u.fechaReporte || null,
              fechaFalla: u.fechaFalla || null
            }))
          };
          this.seleccionUsuariosDisponibles = [];
          this.seleccionUsuariosAsociados = [];
          const modalElement = document.getElementById('modalEvento');
          
          // Limpiar cualquier backdrop existente
          const existingBackdrops = document.querySelectorAll('.modal-backdrop');
          existingBackdrops.forEach(backdrop => backdrop.remove());
          document.body.classList.remove('modal-open');
          document.body.style.overflow = '';
          document.body.style.paddingRight = '';
          
          let modal = bootstrap.Modal.getInstance(modalElement);
          if (!modal) {
            modal = new bootstrap.Modal(modalElement, {
              backdrop: true,
              keyboard: true
            });
          }
          
          // Agregar listener para limpiar backdrop al cerrar
          modalElement.addEventListener('hidden.bs.modal', () => {
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
          }, { once: true });
          
          modal.show();
        },
        actualizarDatosEventoEnModal() {
          const eventoActualizado = this.eventos.find(e => e.idEvento === this.eventoForm.idEvento);
          if (eventoActualizado) {
            this.eventoForm.usuariosAsociados = (eventoActualizado.usuarios || []).map(u => ({
              idUsuario: u.idUsuario,
              resultado: u.resultado,
              esFallaGrave: u.esFallaGrave || false,
              haFalladoEnElPasado: u.haFalladoEnElPasado || false,
              fechaReporte: u.fechaReporte || null,
              fechaFalla: u.fechaFalla || null
            }));
          }
        },
        eliminarEvento(evento) {
          this.confirmacionEliminacion.tipo = 'evento';
          this.confirmacionEliminacion.item = evento;
          this.confirmacionEliminacion.mensaje = `¿Estás seguro de que deseas eliminar el evento #${evento.idEvento} (${evento.tipoEvento})? Esta acción eliminará todas las asociaciones con usuarios.`;
          const modal = new bootstrap.Modal(document.getElementById('modalConfirmarEliminacion'));
          modal.show();
        },
        async agregarUsuarioEvento() {
          if (this.seleccionUsuariosDisponibles.length === 0) return;
          for (const idUsuario of this.seleccionUsuariosDisponibles) {
            const usuario = this.usuarios.find(u => u.idUsuario === idUsuario);
            if (usuario && !this.eventoForm.usuariosAsociados.find(ux => ux.idUsuario === idUsuario)) {
              try {
                const resp = await fetch(`${API}/api/eventos/${this.eventoForm.idEvento}/usuarios/${idUsuario}`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ resultado: 'PENDIENTE' })
                });
                if (!resp.ok) throw new Error('Error al asociar usuario');
                this.eventoForm.usuariosAsociados.push({
                  idUsuario: idUsuario,
                  resultado: 'PENDIENTE',
                  esFallaGrave: false,
                  haFalladoEnElPasado: false
                });
              } catch (e) {
                this.showToast('error', `Error al asociar usuario: ${e.message}`);
              }
            }
          }
          this.seleccionUsuariosDisponibles = [];
          await this.cargarEventos();
          this.actualizarDatosEventoEnModal();
        },
        async quitarUsuarioEvento() {
          if (this.seleccionUsuariosAsociados.length === 0) return;
          await this.desasociarUsuarioEvento(this.seleccionUsuariosAsociados[0]);
          this.seleccionUsuariosAsociados = [];
        },
        async desasociarUsuarioEvento(idUsuario) {
          try {
            const resp = await fetch(`${API}/api/eventos/${this.eventoForm.idEvento}/usuarios/${idUsuario}`, {
              method: 'DELETE'
            });
            if (!resp.ok) throw new Error('Error al desasociar usuario');
            this.showToast('success', 'Usuario desasociado correctamente');
            await this.cargarEventos();
            this.actualizarDatosEventoEnModal();
          } catch (e) {
            this.showToast('error', `Error al desasociar usuario: ${e.message}`);
          }
        },
        async actualizarEstadoUsuarioEvento(ux) {
          try {
            const fechaReporte = ux.resultado === 'REPORTADO' ? new Date().toISOString() : null;
            const fechaFalla = ux.resultado === 'FALLA' ? new Date().toISOString() : null;
            const resp = await fetch(`${API}/api/eventos/${this.eventoForm.idEvento}/usuarios/${ux.idUsuario}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                resultado: ux.resultado,
                fechaReporte: fechaReporte,
                fechaFalla: fechaFalla
              })
            });
            if (!resp.ok) throw new Error('Error al actualizar estado');
            await this.cargarEventos();
            this.actualizarDatosEventoEnModal();
            this.showToast('success', 'Estado actualizado correctamente');
          } catch (e) {
            this.showToast('error', `Error al actualizar estado: ${e.message}`);
          }
        },
        async actualizarFallaGrave(ux) {
          try {
            // Necesitamos crear un endpoint PUT para actualizar estos campos
            // Por ahora, usamos el endpoint de asociación con los datos actuales
            const fechaReporte = ux.fechaReporte ? new Date(ux.fechaReporte).toISOString() : null;
            const fechaFalla = ux.fechaFalla ? new Date(ux.fechaFalla).toISOString() : null;
            const resp = await fetch(`${API}/api/eventos/${this.eventoForm.idEvento}/usuarios/${ux.idUsuario}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                resultado: ux.resultado,
                fechaReporte: fechaReporte,
                fechaFalla: fechaFalla,
                esFallaGrave: ux.esFallaGrave,
                haFalladoEnElPasado: ux.haFalladoEnElPasado
              })
            });
            if (!resp.ok) throw new Error('Error al actualizar falla grave');
            await this.cargarEventos();
            this.actualizarDatosEventoEnModal();
            this.showToast('success', 'Falla grave actualizada correctamente');
          } catch (e) {
            this.showToast('error', `Error al actualizar falla grave: ${e.message}`);
          }
        },
        async actualizarHaFalladoPasado(ux) {
          try {
            const fechaReporte = ux.fechaReporte ? new Date(ux.fechaReporte).toISOString() : null;
            const fechaFalla = ux.fechaFalla ? new Date(ux.fechaFalla).toISOString() : null;
            const resp = await fetch(`${API}/api/eventos/${this.eventoForm.idEvento}/usuarios/${ux.idUsuario}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                resultado: ux.resultado,
                fechaReporte: fechaReporte,
                fechaFalla: fechaFalla,
                esFallaGrave: ux.esFallaGrave,
                haFalladoEnElPasado: ux.haFalladoEnElPasado
              })
            });
            if (!resp.ok) throw new Error('Error al actualizar ha fallado en el pasado');
            await this.cargarEventos();
            this.actualizarDatosEventoEnModal();
            this.showToast('success', 'Estado de falla pasada actualizado correctamente');
          } catch (e) {
            this.showToast('error', `Error al actualizar estado: ${e.message}`);
          }
        },

        // ------- INTENTOS DE REPORTE -------
        async cargarIntentosReporte() {
          try {
            const resp = await fetch(`${API}/api/admin/intentos-reporte`);
            if (!resp.ok) throw new Error('Error al cargar intentos de reporte');
            const data = await resp.json();
            this.intentosReporte = data.intentos || [];
            this.$nextTick(() => {
              const tablaReportes = document.getElementById('tablaReportes');
              if (tablaReportes) {
                this.configurarOrdenamientoTabla(tablaReportes);
              }
            });
          } catch (e) {
            this.showToast('error', e.message || 'Error al cargar intentos de reporte');
          }
        },
        getEstadoNombre(estado) {
          const nombres = {
            'PENDIENTE': 'Pendiente',
            'VERIFICADO': 'Verificado',
            'VALIDADO_SIN_EVENTO': 'Validado',
            'RECHAZADO': 'Rechazado'
          };
          return nombres[estado] || estado;
        },
        editarReporte(reporte) {
          this.reporteForm = {
            idIntentoReporte: reporte.idIntentoReporte,
            idUsuario: reporte.idUsuario,
            nombreUsuario: reporte.nombreUsuario,
            tipoEvento: reporte.tipoEvento,
            fechaInicio: reporte.fechaInicio,
            fechaFin: reporte.fechaFin,
            fechaIntento: reporte.fechaIntento,
            estado: reporte.estado,
            observaciones: reporte.observaciones || '',
            idEventoVerificado: reporte.idEventoVerificado
          };
          const modal = new bootstrap.Modal(document.getElementById('modalReporte'));
          modal.show();
        },
        async submitReporte() {
          this.loadingReporte = true;
          try {
            const payload = {
              estado: this.reporteForm.estado,
              observaciones: this.reporteForm.observaciones,
              idEventoVerificado: this.reporteForm.idEventoVerificado
            };
            const resp = await fetch(`${API}/api/admin/intentos-reporte/${this.reporteForm.idIntentoReporte}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            if (!resp.ok) throw new Error('Error actualizando reporte');
            this.showToast('success', 'Reporte actualizado correctamente ✅');
            await this.cargarIntentosReporte();
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalReporte'));
            if (modal) modal.hide();
          } catch (e) {
            this.showToast('error', e.message || 'Error en operación de reporte');
          } finally {
            this.loadingReporte = false;
          }
        },
        eliminarReporte(reporte) {
          this.confirmacionEliminacion.tipo = 'reporte';
          this.confirmacionEliminacion.item = reporte;
          this.confirmacionEliminacion.mensaje = `¿Estás seguro de que deseas eliminar el intento de reporte #${reporte.idIntentoReporte}?`;
          const modal = new bootstrap.Modal(document.getElementById('modalConfirmarEliminacion'));
          modal.show();
        },

        inicializarOrdenamientoTablas() {
          // Inicializar ordenamiento para tabla de áreas
          const tablaAreas = document.getElementById('tablaAreas');
          if (tablaAreas) {
            this.configurarOrdenamientoTabla(tablaAreas);
          }

          // Inicializar ordenamiento para tabla de usuarios
          const tablaUsuarios = document.getElementById('tablaUsuarios');
          if (tablaUsuarios) {
            this.configurarOrdenamientoTabla(tablaUsuarios);
          }

          // Inicializar ordenamiento para tabla de eventos
          const tablaEventos = document.getElementById('tablaEventos');
          if (tablaEventos) {
            this.configurarOrdenamientoTabla(tablaEventos);
          }

          // Inicializar ordenamiento para tabla de reportes
          const tablaReportes = document.getElementById('tablaReportes');
          if (tablaReportes) {
            this.configurarOrdenamientoTabla(tablaReportes);
          }
        },
        configurarOrdenamientoTabla(tabla) {
          // Eliminar listeners anteriores si existen
          const headers = tabla.querySelectorAll('thead th.sortable');
          headers.forEach((th) => {
            // Clonar el elemento para eliminar todos los listeners
            const newTh = th.cloneNode(true);
            th.parentNode.replaceChild(newTh, th);
          });
          
          // Agregar nuevos listeners
          const newHeaders = tabla.querySelectorAll('thead th.sortable');
          newHeaders.forEach((th) => {
            let asc = false;
            th.addEventListener('click', () => {
              const colIndex = parseInt(th.getAttribute('data-col'), 10);
              asc = !asc;
              this.ordenarTablaPorColumna(tabla, colIndex, asc);
              // Actualizar iconos del header clickeado
              newHeaders.forEach(h => {
                const icon = h.querySelector('.sort-icon');
                if (!icon) return;
                if (h === th) {
                  icon.classList.remove('bi-caret-down', 'bi-caret-up-fill', 'bi-caret-down-fill');
                  icon.classList.add(asc ? 'bi-caret-up-fill' : 'bi-caret-down-fill');
                } else {
                  icon.classList.remove('bi-caret-up-fill', 'bi-caret-down-fill');
                  icon.classList.add('bi-caret-down');
                }
              });
            });
          });
        },
        ordenarTablaPorColumna(tabla, indiceColumna, ascendente) {
          const tbody = tabla.querySelector('tbody');
          const filas = Array.from(tbody.querySelectorAll('tr'));

          const comparar = (a, b) => {
            const celdaA = a.children[indiceColumna]?.textContent.trim() || '';
            const celdaB = b.children[indiceColumna]?.textContent.trim() || '';
            
            // Para columnas numéricas (ID, cantidad de usuarios, etc.)
            const numA = parseFloat(celdaA.replace(/[^0-9.-]+/g, ''));
            const numB = parseFloat(celdaB.replace(/[^0-9.-]+/g, ''));
            const esNumeroA = !isNaN(numA);
            const esNumeroB = !isNaN(numB);

            let res = 0;
            if (esNumeroA && esNumeroB) {
              res = numA - numB;
            } else {
              res = celdaA.localeCompare(celdaB, 'es', { sensitivity: 'base' });
            }
            return ascendente ? res : -res;
          };

          filas.sort(comparar).forEach(fila => tbody.appendChild(fila));
        }
      },
      async mounted() {
        await Promise.all([this.cargarAreas(), this.cargarUsuarios(), this.cargarEventos(), this.cargarIntentosReporte()]);
        this.$nextTick(() => {
          this.inicializarOrdenamientoTablas();
        });
      }
    }).mount('#app');
  </script>

</body>

</html>

